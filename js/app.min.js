var app=angular.module("restaurante",["ngRoute","ngSanitize","mgcrea.ngStrap","angularUtils.directives.dirPagination"],["$provide",function($provide){var PLURAL_CATEGORY_ONE="one",PLURAL_CATEGORY_OTHER="other";$provide.value("$locale",{DATETIME_FORMATS:{AMPMS:["AM","PM"],DAY:["Dom","Lun","Mar","Mie","Jue","Vie","Sab"],MONTH:["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"],SHORTDAY:["Dom","Lun","Mar","Mie","Jue","Vie","Sab"],SHORTMONTH:["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sept","Oct","Nov","Dic"],fullDate:"EEEE d MMMM y",longDate:"d MMMM y",medium:"d MMM y HH:mm:ss",mediumDate:"d MMM y",mediumTime:"HH:mm:ss",short:"dd/MM/yy HH:mm",shortDate:"dd/MM/yyyy",shortTime:"HH:mm:ss"},NUMBER_FORMATS:{CURRENCY_SYM:",",DECIMAL_SEP:".",GROUP_SEP:",",PATTERNS:[{gSize:3,lgSize:3,macFrac:0,maxFrac:3,minFrac:0,minInt:1,negPre:"-",negSuf:"",posPre:"",posSuf:""},{gSize:3,lgSize:3,macFrac:0,maxFrac:2,minFrac:2,minInt:1,negPre:"(",negSuf:" ¤)",posPre:"",posSuf:" ¤"}]},id:"es-es",pluralCat:function(n){return 0<=n&&n<=2&&2!=n?PLURAL_CATEGORY_ONE:PLURAL_CATEGORY_OTHER}})}]),socket=io.connect("http://127.0.0.1:8080",{forceNew:!0}),code=document.getElementById("resuFoni").value;app.controller("inicioCtrl",function($scope,$rootScope,$timeout,$http,$modal,$window){alertify.set("notifier","position","top-right"),$scope.lstU=[],$scope.loading=!1,$scope.loadingText="Cargando...",$scope.changeUser=$modal({scope:$scope,template:"change.user.html",show:!1,backdrop:!1,keyboard:!0}),$scope.userInfo={},$scope.hideLoading=function(){$scope.loading=!1,$scope.loadingText="Cargando..."},$scope.showLoading=function(mensaje){$scope.loading=!0,$scope.loadingText=mensaje||"Cargando..."},$scope.hideLoading(),socket.on("connect",function(){$(".network-bad").hide(),console.log("CONECT..!")}),socket.on("disconnect",function(){$(".network-bad").show(),console.log("DISCONECT..!")}),$timeout(function(){socket.connected||$(".network-bad").show()}),socket.on("info",function(data){console.log(data),null!=data.action&&"lstU"==data.action?$scope.lstU=data.lst:$rootScope.$broadcast("infoNode",data)}),$scope.difLocalServer=0,$scope.fechaActual=null,$http.post("consultas.php",{opcion:"timeNow"}).success(function(data){$scope.fechaActual=moment(data.fechaActual),$scope.difLocalServer=moment(new Date).diff(moment(data.timeNow))}),$scope.tiempoTranscurrido=function(tiempo){var de=moment(new Date).add($scope.difLocalServer),para=moment(tiempo);return de.to(para)},$scope.difMinutos=function(tiempo){var de=moment(new Date).add($scope.difLocalServer),para=moment(tiempo);return de.diff(para,"minutes")},$scope.formatoFecha=function(fecha,formato){var _for=formato||"D [de] MMMM [de] YYYY";if(!fecha)return fecha;if(8==fecha.length)var txt=moment(fecha,"HH:mm:ss").format(_for);else txt=moment(fecha).format(_for);return txt},$scope.pressKey=function(key,altDerecho,event){if($scope.loading)return!1;if(117!=key&&!altDerecho||event.ctrlKey&&event.shiftKey||event.preventDefault(),85==key&&event.ctrlKey&&event.altKey?($scope.userInfo._usuario="",$scope.userInfo._clave="",$scope.changeUser.show(),$timeout(function(){document.getElementById("_usuario")&&document.getElementById("_usuario").focus()})):!altDerecho||13!=key&&92!=key&&91!=key?17!=key&&18!=key&&92!=key&&91!=key&&$rootScope.$broadcast("keyPress",key,altDerecho,event):$window.location.href="#/",altDerecho&&"#/"===document.location.hash)switch(key){case 79:$window.location.href="#/orden";break;case 65:$window.location.href="#/adminOrden";break;case 70:$window.location.href="#/factura";break;case 69:$window.location.href="#/evento";break;case 67:$window.location.href="#/caja";break;case 73:$window.location.href="#/inventario";break;case 77:$window.location.href="#/mantenimiento";break;case 82:$window.location.href="#/reportes"}console.log("K:",key)},$scope.lstEstadosFactura=[],$scope.catEstadosFactura=function(){$http.post("consultas.php",{opcion:"catEstadosFactura"}).success(function(data){$scope.lstEstadosFactura=data||[]})},$scope.imagen={id:null,tipo:"",accion:""},$scope.resetImagen=function(){$scope.imagen={id:null,tipo:"",accion:""},$("#subirImagen").modal("hide"),$(".close.fileinput-remove").click()},$scope.asignarValorImagen=function(id,tipo){$scope.imagen.id=id,$scope.imagen.tipo=tipo,$("#subirImagen").modal("show")},$("#imagen").fileinput({language:"es",uploadUrl:"upload.php",showRemove:!0,showUpload:!0,autoReplace:!0,maxFileCount:1,cache:!1,maxFileSize:1024,uploadAsync:!1,allowedFileExtensions:["jpeg","jpg","png"],uploadExtraData:function(){return{id:$scope.imagen.id,tipo:$scope.imagen.tipo}}}).on("filebatchpreupload",function(event,data,previewId,index){console.log("1",data.response)}).on("fileuploaded",function(event,data,previewId,index){console.log("2",data.response),data.response.respuesta&&($rootScope.$broadcast("cargarLista",data.response.accion),$scope.resetImagen())}).on("filebatchuploadsuccess",function(event,data,previewId,index){console.log("3",data.response),data.response.respuesta&&($rootScope.$broadcast("cargarLista",data.response.accion),$scope.resetImagen())}).on("filebatchuploaderror",function(event,data,msg){console.log("4",data)}).on("fileuploaderror",function(event,data,msg){console.log("5",data)}),$(function(){$("#cargando").removeAttr("style")}),($scope.catTipoCliente=function(){$http.post("consultas.php",{opcion:"catTiposCliente"}).success(function(data){$scope.lstTipoCliente=data})})(),$scope.cambiarUsuario=function(){if(console.log($scope.userInfo),$scope.loading)return!1;$scope.loading=!0,$http.post("consultas.php",{opcion:"login",usuario:$scope.userInfo._usuario,clave:$scope.userInfo._clave}).success(function(data){console.log(data),$scope.loading=!1,"success"==data.respuesta?($scope.changeUser.hide(),window.location.href="./"):alertify.notify(data.mensaje||data,"danger",6)})},$window.onfocus=function(){$("#divFocus").hide(),$("#ng_view").removeClass("back-blur")},$window.onblur=function(){}}),app.config(function($routeProvider){$routeProvider.when("/",{templateUrl:"view/inicio.php"}).when("/cliente",{templateUrl:"view/cliente.php",controller:"clienteCtrl"}).when("/inventario",{templateUrl:"view/inventario.php",controller:"inventarioCtrl"}).when("/nuevoEdita/:evento/:id?",{templateUrl:"view/nuevoEdita.php",controller:"nuevoEditaCtrl"}).when("/admin",{templateUrl:"view/admin.php",controller:"crtlAdmin"}).when("/orden",{templateUrl:"view/orden.php",controller:"crtlOrden"}).when("/evento",{templateUrl:"view/evento.php",controller:"crtlEvento"}).when("/adminOrden",{templateUrl:"view/adminOrden.php",controller:"crtlAdminOrden"}).when("/reporte",{templateUrl:"view/reporte.php",controller:"reporteCtrl"}).when("/mantenimiento",{templateUrl:"view/mantenimiento.php",controller:"crtlMantenimiento"}).when("/factura/:idOrdenCliente?",{templateUrl:"view/factura.php",controller:"facturaCtrl"}).when("/caja",{templateUrl:"view/caja.php",controller:"ctrlCaja"}).when("/tendencia",{templateUrl:"view/tendencia.php",controller:"ctrlTendencia"}).otherwise({redirectTo:"/"})}).config(function($tooltipProvider){angular.extend($tooltipProvider.defaults,{trigger:"hover",html:!0})}).config(function($popoverProvider){angular.extend($popoverProvider.defaults,{trigger:"hover",html:!0})}),app.directive("numbersOnly",function(){return{require:"ngModel",link:function(scope,element,attr,ngModelCtrl){ngModelCtrl.$parsers.push(function(text){if(text){var transformedInput=text.replace(/[^0-9]/g,"");return transformedInput!==text&&(ngModelCtrl.$setViewValue(transformedInput),ngModelCtrl.$render()),transformedInput}})}}}),app.directive("autofocus",function($timeout){return{link:function(scope,element,attrs){$timeout(function(){element.focus()})}}}),app.directive("focusEnter",function(){return{restrict:"A",link:function($scope,selem,attrs){selem.bind("keydown",function(e){if(13===(e.keyCode||e.which)){e.preventDefault();for(var pageElems=document.querySelectorAll("input, select, textarea, button.focus-enter"),elem=e.srcElement||e.target,focusNext=!1,len=pageElems.length,i=0;i<len;i++){var pe=pageElems[i];if(focusNext){if("none"!==pe.style.display){angular.element(pe).focus();break}}else pe===elem&&(focusNext=!0)}}})}}}),app.directive("capitalize",function(){return{require:"ngModel",link:function(scope,element,attrs,modelCtrl){var capitalize=function(inputValue){null==inputValue&&(inputValue="");var capitalized=inputValue.toUpperCase();if(capitalized!==inputValue){var selection=element[0].selectionStart;modelCtrl.$setViewValue(capitalized),modelCtrl.$render(),element[0].selectionStart=selection,element[0].selectionEnd=selection}return capitalized};modelCtrl.$parsers.push(capitalize),capitalize(scope[attrs.ngModel])}}}),app.controller("clienteCtrl",function($scope,$http,$modal,$timeout){$scope.menuCliente="ingresar",$scope.txtCliente="",$scope.lstClientes=[],$scope.$on("keyPress",function(event,key,altDerecho){if($scope.$parent.loading)return!1;117==key&&("ingresar"!=$scope.menuCliente||$scope.modalOpen()||$scope.consultaCliente())}),$scope.modalOpen=function(_name){return null==_name?$("body>div").hasClass("modal")&&$("body>div").hasClass("top"):!(!$("#"+_name).data()||!$("#"+_name).data().$scope.$isShown)},$scope.resetValores=function(accion){$scope.accion="insert","cliente"==accion&&($scope.cliente={nit:null,nombre:"",cui:null,correo:"",telefono:null,direccion:"",idTipoCliente:1}),"lstClientes"==accion&&($scope.lstClientes=[])},$scope.resetValores("cliente"),document.getElementById("dial.buscarCliente.html")&&($scope.dialBuscarCliente=$modal({scope:$scope,template:"dial.buscarCliente.html",show:!1,backdrop:"static"})),$scope.buscarCliente=function(valor,accion){0==valor.length&&"principal"==accion?($scope.txtCliente="",$scope.lstClientes=[],$scope.dialBuscarCliente.show(),$timeout(function(){$("#buscador").focus()},150)):1<=valor.length?$http.post("consultas.php",{opcion:"consultarCliente",valor:valor}).success(function(data){data.encontrado?1==data.lstResultados.length&&data.encontrado?($scope.accion="update",$scope.cliente=data.lstResultados[0],$scope.dialBuscarCliente.hide(),$scope.txtCliente="",$scope.menuCliente="ingresar",$("#nit").focus()):1<data.lstResultados.length&&($scope.lstClientes=data.lstResultados,"principal"==accion&&$scope.dialBuscarCliente.show(),$timeout(function(){$("#buscador").focus()})):($scope.lstClientes=[],alertify.notify("No se encontró resultados, agregar <b>CLIENTE</b>","info",5),$scope.dialBuscarCliente.hide(),$scope.txtCliente="",$scope.menuCliente="ingresar",$scope.accion="insert",$scope.cliente=data.lstResultados[0],$timeout(function(){$("#nit").focus()},150))}):alertify.notify("Ingrese un dato para consultar","info",3)},$scope.consultaCliente=function(){var cliente=$scope.cliente;cliente.nombre&&3<=cliente.nombre.length?cliente.direccion&&8<=cliente.direccion.length?null!=cliente.cui&&1<=cliente.cui.length&&13!=cliente.cui.length?alertify.notify("El No. de CUI debe tener 13 dígitos","warning",3):$http.post("consultas.php",{opcion:"consultaCliente",accion:$scope.accion,cliente:$scope.cliente}).success(function(data){console.log(data),alertify.set("notifier","position","top-right"),alertify.notify(data.mensaje,data.respuesta,data.tiempo),"success"==data.respuesta&&($scope.resetValores("cliente"),$scope.txtCliente="",$("#ticket").focus())}).error(function(error,status){$scope.data.error={message:error,status:status},console.log($scope.data.error.status)}):alertify.notify("La dirección debe tener más de 7 caracteres","warning",5):alertify.notify("El nombre debe tener más de 2 caracteres","warning",4)},$scope.seleccionarCliente=function(cliente){$scope.cliente=angular.copy(cliente),$scope.resetValores("lstClientes"),$scope.txtCliente="",$scope.menuCliente="ingresar",$scope.accion="update",$scope.dialBuscarCliente.hide(),$timeout(function(){$("#nit").focus()},125)}}),app.controller("inventarioCtrl",function($scope,$http,$modal,$timeout,$filter){$scope.lstInventario=[],$scope.inventarioMenu="inventario",$scope.accion="insert",$scope.groupBy="sinFiltro",$scope.$watch("inventarioMenu",function(_old,_new){"inventario"==$scope.inventarioMenu?$scope.lstProductosInventario():$scope.realizarReajuste&&"inventario"!=$scope.inventarioMenu&&($scope.realizarReajuste=!1)}),$scope.$watch("groupBy",function(_old,_new){_old!=_new&&"inventario"==$scope.inventarioMenu&&$scope.lstProductosInventario()}),$scope.$on("keyPress",function(event,key,altDerecho){if($scope.$parent.loading)return!1;117==key?$scope.modalOpen("dialAdminProducto")?$scope.consultaProducto():"inventario"==$scope.inventarioMenu?$scope.modalOpen("dialCierreDiario")?$scope.consultaCuadreProducto():$scope.realizarReajuste&&!$scope.modalOpen()&&$scope.guardarReajusteMasivo():"tipoProducto"==$scope.inventarioMenu?$scope.modalOpen()||$scope.consultaTipoProducto():"medidas"==$scope.inventarioMenu?$scope.modalOpen()||$scope.consultaMedida():"compras"==$scope.inventarioMenu&&($scope.modalOpen("dialEditarFacturaCompra")?$scope.consultaFactura("update"):$scope.modalOpen()||$scope.consultaFactura("insert")):!altDerecho||65!=key&&71!=key&&83!=key&&84!=key&&77!=key&&82!=key&&67!=key||$scope.modalOpen()||("inventario"==$scope.inventarioMenu&&65!=key?83==key?$scope.groupBy="sinFiltro":84==key?$scope.groupBy="tipoProducto":77==key?$scope.groupBy="medida":82==key?$scope.realizarReajusteMasivo():67==key&&$scope.realizarReajuste?$scope.cancelarReajuste():67!=key||$scope.realizarReajuste||$scope.realizarCierre():65==key?$scope.editarAccion("insert",null):alertify.notify("Acción no válida","info",3))}),document.getElementById("dial.ingreso.html")&&($scope.dialIngreso=$modal({scope:$scope,template:"dial.ingreso.html",show:!1,backdrop:"static"})),document.getElementById("dialAdmin.producto.html")&&($scope.dialAdministrar=$modal({scope:$scope,template:"dialAdmin.producto.html",show:!1,backdrop:"static"})),document.getElementById("dial.cierreDiario.html")&&($scope.dialCierreDiario=$modal({scope:$scope,template:"dial.cierreDiario.html",show:!1,backdrop:"static"})),document.getElementById("dial.lstFacturaCompra.html")&&($scope.dialLstFacturaCompra=$modal({scope:$scope,template:"dial.lstFacturaCompra.html",show:!1,backdrop:"static"})),document.getElementById("dial.editarFacturaCompra.html")&&($scope.dialEditarFacturaCompra=$modal({scope:$scope,template:"dial.editarFacturaCompra.html",show:!1,backdrop:"static"})),document.getElementById("dial.verDetalleFacturaCompra.html")&&($scope.dialVerDetalleFacturaCompra=$modal({scope:$scope,template:"dial.verDetalleFacturaCompra.html",show:!1,backdrop:"static"})),document.getElementById("dial.verCierreDiario.html")&&($scope.dialVerCierreDiario=$modal({scope:$scope,template:"dial.verCierreDiario.html",show:!1,backdrop:"static"})),$scope.dialAdministrarAbrir=function(){$scope.dialAdministrar.show()},$scope.dialAdministrarCerrar=function(){$scope.dialAdministrar.hide()},$scope.cierreDiario={},$scope.accionCuadreProducto=function(idUbicacion){$scope.$parent.showLoading("Consultando..."),$scope.idUbicacion=idUbicacion,$http.post("consultas.php",{opcion:"accionCuadreProducto",idUbicacion:idUbicacion}).success(function(data){console.log("producto",data),$scope.cierreDiario=data,$scope.cierreDiario.fechaRegistroCuadre=moment(data.fechaRegistroCuadre),$scope.$parent.hideLoading()})},$scope.realizarReajuste=!1,$scope.realizarReajusteMasivo=function(){$scope.groupBy="sinFiltro",$scope.realizarReajuste=!0,$scope.reajusteMasivo={lstProductos:[],observacion:""}},$scope.cancelarReajuste=function(){alertify.confirm("CONFIRMAR CANCELACIÓN","Esta seguro(a) de cancelar el reajuste másivo de los productos?",function(){$scope.realizarReajuste=!1,$scope.groupBy="sinFiltro",$scope.lstProductosInventario()},function(){})},$scope.consultaReajusteInventario=function(){var itemProducto=$scope.itemProducto;itemProducto.cantidad&&0!=itemProducto.cantidad?$http.post("consultas.php",{opcion:"consultaReajusteInventario",accion:"insert",datos:$scope.itemProducto}).success(function(data){console.log(data),alertify.set("notifier","position","top-right"),alertify.notify(data.mensaje,data.respuesta,data.tiempo),"success"==data.respuesta&&($scope.lstProductosInventario(),$scope.resetValores(2),$scope.dialIngreso.hide())}):alertify.notify("La cantidad debe ser diferente a 0","warning",4)},$scope.guardarReajusteMasivo=function(){if($scope.$parent.loading)return!1;var invProductos=$scope.lstInventario[0].lstProductos,error=!1,totalCambios=0;if(invProductos.length){$scope.reajusteMasivo.lstProductos=[];for(var i=0;i<invProductos.length;i++){if(console.log(invProductos[i]),null==invProductos[i].cantidad){error=!0,alertify.notify("La cantidad ingresada en "+invProductos[i].producto+" no es válida","danger",5);break}if(invProductos[i].esIncremento){if(invProductos[i].disponibilidad+invProductos[i].cantidad<0){error=!0,alertify.notify("La nueva disponibilidad no puede ser negativa en "+invProductos[i].producto,"danger",5);break}}else if(invProductos[i].disponibilidad-invProductos[i].cantidad<0){error=!0,alertify.notify("La nueva disponibilidad no puede ser negativa en "+invProductos[i].producto,"danger",5);break}!error&&0<invProductos[i].cantidad&&(totalCambios++,$scope.reajusteMasivo.lstProductos.push({idProducto:invProductos[i].idProducto,cantidad:invProductos[i].cantidad,esIncremento:invProductos[i].esIncremento}))}}else error=!0,alertify.notify("No se tiene productos en la lista","danger",4);console.log(totalCambios),error||(0<totalCambios?($scope.$parent.showLoading("Guardando..."),$http.post("consultas.php",{opcion:"guardarReajusteMasivo",accion:"insert",datos:$scope.reajusteMasivo}).success(function(data){console.log(data),alertify.set("notifier","position","top-right"),alertify.notify(data.mensaje,data.respuesta,data.tiempo),$scope.$parent.hideLoading(),"success"==data.respuesta&&($scope.realizarReajuste=!1,$scope.groupBy="sinFiltro",$scope.lstProductosInventario())})):alertify.notify("Usted no ha realizado ningun reajuste, verifique","warning",5))},$scope.modalAccionCuadreProducto=function(){$scope.idUbicacion=null,$scope.dialCierreDiario.show()},$scope.consultaCuadreProducto=function(){if($scope.$parent.loading)return!1;for(var diferencias=0,i=0;i<$scope.cierreDiario.lstProductos.length;i++)$scope.cierreDiario.lstProductos[i].mostrarAlerta=!1,$scope.cierreDiario.lstProductos[i].disponible<$scope.cierreDiario.lstProductos[i].disponibilidad&&($scope.cierreDiario.lstProductos[i].mostrarAlerta||($scope.cierreDiario.lstProductos[i].mostrarAlerta=!0),$scope.cierreDiario.lstProductos[i].agregarComentario&&!$scope.cierreDiario.lstProductos[i].comentario.length&&($scope.cierreDiario.lstProductos[i].alertaComentario=!0),$scope.cierreDiario.lstProductos[i].agregarComentario&&$scope.cierreDiario.lstProductos[i].comentario.length||diferencias++);if(diferencias)alertify.notify("Existe(n) <b>"+diferencias+" PRODUCTOS</b> con faltantes, verifique","info",7);else{var cierreDiario=$scope.cierreDiario;"update"!=$scope.accion||cierreDiario.idCierreDiario&&0<cierreDiario.idCierreDiario?cierreDiario.fechaRegistroCuadre?($scope.$parent.showLoading("Guardando..."),$http.post("consultas.php",{opcion:"consultaCuadreProducto",accion:$scope.accion,data:$scope.cierreDiario}).success(function(data){console.log(data),alertify.set("notifier","position","top-right"),alertify.notify(data.mensaje,data.respuesta,data.tiempo),$scope.$parent.hideLoading(),"success"==data.respuesta&&($scope.resetValores("cierreDiario"),$scope.dialCierreDiario.hide(),$scope.lstProductosInventario())})):alertify.notify("Ingrese una fecha válida","warning",3):alertify.notify("El código del cierra no es válido","warning",4)}},$scope.catTipoProducto=function(){$http.post("consultas.php",{opcion:"catTipoProducto"}).success(function(data){$scope.lstTipoProducto=data||[]})},$scope.catUbicacion=function(){$http.post("consultas.php",{opcion:"catUbicacion"}).success(function(data){$scope.lstUbicacion=data||[]})},$scope.catMedidas=function(){$http.post("consultas.php",{opcion:"catMedidas"}).success(function(data){$scope.lstMedidas=data||[]})},$scope.verCierreDiario=function(){$scope.dialVerCierreDiario.show()},$scope.fechaCuadreP={},$scope.cargarFechaCierre=function(fechaCierre){if(fechaCierre){fechaCierre=$filter("date")(fechaCierre,"yyyy-MM-dd");$http.post("consultas.php",{opcion:"cargarFechaCierre",fechaCierre:fechaCierre}).success(function(data){console.log(data),$scope.fechaCuadreP=data})}},$scope.buscarTipoProducto="",$scope.resetValores=function(accion){$scope.accion="insert",$scope.buscarTipoProducto="",$scope.buscarMedida="",1==accion?$scope.producto={producto:"",idUbicacion:1,idTipoProducto:null,idMedida:null,perecedero:!0,cantidadMinima:null,cantidadMaxima:null,disponibilidad:"",importante:!0}:2==accion?$scope.itemProducto={idProducto:null,nombreProducto:"",cantidad:0,disponibilidad:null,observacion:"",esIncremento:!0}:4==accion?$scope.tp={idTipoProducto:null,tipoProducto:""}:6==accion?$scope.medidaProd={idMedida:null,medida:""}:"producto"==accion?$scope.prod={idProducto:null,nombreProducto:"",medida:"",cantidad:null,costo:null,seleccionado:!1}:"cierreDiario"==accion?$scope.cierreDiario={idCierreDiario:null,fechaCierre:null,comentario:"",lstProductos:[]}:"compras"==accion&&($scope.compras={noFactura:null,fechaFactura:null,idProveedor:null,proveedor:"",idEstadoFactura:1,comentario:"",lstProductos:[]})},($scope.cargarInicio=function(){$http.post("consultas.php",{opcion:"inicioInventario"}).success(function(data){$scope.lstMedidas=data.catMedidas||[],$scope.lstTipoProducto=data.catTipoProducto||[],$scope.lstUbicacion=data.catUbicacion||[],$scope.lstEstadosFactura.length||$scope.catEstadosFactura()}),$scope.resetValores(1),$scope.resetValores("compras")})(),$scope.filtro={filter:[{filter:"idProducto",value:8}],order:[{by:"idTipoProducto",order:"DESC"}],limit:25,page:1},$scope.idxProducto=-1,$scope.seleccionKeyProducto=function(key){13==key?$scope.lstProductos.length?1==$scope.lstProductos.length?$scope.seleccionarProducto($scope.lstProductos[0]):-1!=$scope.idxProducto&&$scope.seleccionarProducto($scope.lstProductos[$scope.idxProducto]):alertify.notify("No se encontro el producto ingresaoo","info",5):38==key?$scope.lstProductos.length&&0<$scope.idxProducto?$scope.idxProducto--:0==$scope.idxProducto&&($scope.idxProducto=$scope.lstProductos.length-1):40==key&&($scope.lstProductos.length&&$scope.idxProducto+1<$scope.lstProductos.length?$scope.idxProducto++:$scope.lstProductos.length&&$scope.idxProducto+1&&($scope.idxProducto=0))},$scope.cancelarIngreso=function(accion){1==accion&&($scope.resetValores("producto"),$timeout(function(){$("#producto").focus()},50))},$scope.subTotalQuetzales=function(accion){var subTotalQuetzales=0;if(1==accion)for(var i=0;i<$scope.compras.lstProductos.length;i++)subTotalQuetzales+=parseFloat($scope.compras.lstProductos[i].costo);else if(2==accion)for(i=0;i<$scope.facturaCompra.lstProductos.length;i++)subTotalQuetzales+=parseFloat($scope.facturaCompra.lstProductos[i].costo);return subTotalQuetzales},$scope.quitarProdIngreso=function(index){$scope.compras.lstProductos.splice(index,1)},$scope.agregarIngresoProducto=function(){var prod=$scope.prod;prod.idProducto&&0<prod.idProducto?prod.cantidad&&0<prod.cantidad?prod.costo&&0<prod.costo?($scope.compras.lstProductos.push({idProducto:prod.idProducto,producto:prod.producto,cantidad:prod.cantidad,costo:prod.costo}),$scope.cancelarIngreso(1),alertify.notify("Agregado a la lista","success",2),$scope.lstProductos=[]):alertify.notify("Ingrese el precio total de compra","danger",3):alertify.notify("La cantidad ingresada debe ser mayor a 0","danger",4):alertify.notify("El código del Producto no es válido","danger",3)},$scope.seleccionarProducto=function(producto){producto.idProducto&&0<producto.idProducto?($scope.prod={idProducto:producto.idProducto,producto:producto.producto,medida:producto.medida,cantidad:null,costo:null,seleccionado:!0},$timeout(function(){$("#cantidad").focus()},125),$scope.lstProductos=[]):alertify.notify("El código del Producto no es válido","danger",5)},$scope.consultaFactura=function(accion){if($scope.$parent.loading)return!1;var error=!1;if($scope.accion=accion,$scope.compras.lstProductos.length||"insert"!=$scope.accion){if("insert"==$scope.accion)for(var i=0;i<$scope.compras.lstProductos.length;i++){var prod=$scope.compras.lstProductos[i];if(!(prod.idProducto&&0<prod.idProducto)){error=!0,alertify.notify("El Código del producto no es válido, verifique","warning",5);break}if(!(prod.cantidad&&0<prod.cantidad)){alertify.notify("La cantidad debe ser mayor a 0","warning",4),error=!0;break}}}else error=!0,alertify.notify("No ha ingresado ningun producto, verifique","info",4);error||($scope.$parent.showLoading("Guardando..."),$http.post("consultas.php",{opcion:"consultaFactura",accion:$scope.accion,data:"insert"==$scope.accion?$scope.compras:$scope.facturaCompra}).success(function(data){console.log(data),alertify.set("notifier","position","top-right"),alertify.notify(data.mensaje,data.respuesta,data.tiempo),$scope.$parent.hideLoading(),"success"==data.respuesta&&("insert"==$scope.accion?$scope.resetValores("compras"):"update"==$scope.accion&&($scope.dialEditarFacturaCompra.hide(),$scope.cargarLstFacturaCompra()))}))},$scope.lstProductos=[],$scope.buscarProducto=function(nombreProducto){nombreProducto.length&&!$scope.prod.seleccionado?$http.post("consultas.php",{opcion:"buscarProducto",nombreProducto:nombreProducto}).success(function(data){$scope.lstProductos=data}):$scope.lstProductos=[]},$scope.editarFacturaCompra=function(facturaCompra,accion){if($scope.$parent.loading)return!1;console.log(facturaCompra),$scope.facturaCompra=angular.copy(facturaCompra),$scope.facturaCompra.fechaFactura=moment(facturaCompra.fechaFactura),$scope.dialLstFacturaCompra.hide(),"editar"==accion&&$scope.dialEditarFacturaCompra.show(),"verDetalle"==accion&&($scope.$parent.showLoading("Cargando..."),$http.post("consultas.php",{opcion:"cargarLstIngresoProducto",idFacturaCompra:$scope.facturaCompra.idFacturaCompra}).success(function(data){$scope.facturaCompra.lstProductos=data,$scope.dialVerDetalleFacturaCompra.show(),$scope.$parent.hideLoading()}))},$scope.detalleFacturaCompra=[],$scope.cargarLstFacturaCompra=function(){if($scope.$parent.loading)return!1;$scope.$parent.showLoading("Cargando..."),$http.post("consultas.php",{opcion:"cargarLstFacturaCompra"}).success(function(data){console.log(data),$scope.detalleFacturaCompra=data,$scope.dialLstFacturaCompra.show(),$scope.$parent.hideLoading()})},$scope.editarAccion=function(accion,producto){"update"==($scope.accion=accion)&&($scope.producto=angular.copy(producto),$scope.producto.idMedida=$scope.producto.idMedida.toString(),$scope.producto.idTipoProducto=$scope.producto.idTipoProducto.toString()),$scope.dialAdministrarAbrir(),$timeout(function(){$("#nombreProducto").focus()},160)},$scope.consultaProducto=function(){if($scope.$parent.loading)return!1;var producto=$scope.producto;"update"!=$scope.accion||0<producto.idProducto?producto.producto&&3<=producto.producto.length?producto.idUbicacion&&0<producto.idUbicacion?producto.idTipoProducto&&0<producto.idTipoProducto?producto.idMedida&&0<producto.idMedida?producto.cantidadMinima&&0<producto.cantidadMinima?producto.cantidadMinima&&0<producto.cantidadMinima?producto.disponibilidad&&0<producto.disponibilidad?($scope.$parent.showLoading("Guardando..."),$http.post("consultas.php",{opcion:"consultaProducto",accion:$scope.accion,datos:$scope.producto}).success(function(data){console.log(data),alertify.set("notifier","position","top-right"),alertify.notify(data.mensaje,data.respuesta,data.tiempo),$scope.$parent.hideLoading(),"success"==data.respuesta&&($scope.resetValores(1),$scope.lstProductosInventario(),$scope.dialAdministrarCerrar())})):alertify.notify("La disponibilidad debe ser mayor a 0","warning",5):alertify.notify("La cantidad máxima debe ser mayor a 0","warning",5):alertify.notify("La cantidad mínima debe ser mayor a 0","warning",5):alertify.notify("Seleccione la medida","warning",5):alertify.notify("Seleccione el tipo de producto","warning",5):alertify.notify("Seleccione la ubicacion del producto","warning",5):alertify.notify("El nombre del producto debe ser mayor a 3 caracteres","warning",5):alertify.notify("No. de producto no definido","warning",5)},$scope.lstProductosInventario=function(){if($scope.$parent.loading)return!1;$scope.$parent.showLoading("Cargando..."),$http.post("consultas.php",{opcion:"lstProductos",groupBy:$scope.groupBy}).success(function(data){console.log("::::",data),$scope.lstInventario=data,$scope.$parent.hideLoading()})},$scope.resetValores(4),$scope.editarTipoProducto=function(tipoProducto){$scope.accion="update",$scope.tp.idTipoProducto=tipoProducto.idTipoProducto,$scope.tp.tipoProducto=tipoProducto.tipoProducto,$("#tipoProducto").focus()},$scope.consultaTipoProducto=function(tipoProducto){if($scope.$parent.loading)return!1;var tp=$scope.tp;"update"!=$scope.accion||tp.idTipoProducto&&0<tp.idTipoProducto?tp.tipoProducto&&3<tp.tipoProducto.length?($scope.$parent.showLoading("Guardando..."),$http.post("consultas.php",{opcion:"consultaTipoProducto",accion:$scope.accion,datos:$scope.tp}).success(function(data){console.log(data),alertify.set("notifier","position","top-right"),alertify.notify(data.mensaje,data.respuesta,data.tiempo),$scope.$parent.hideLoading(),"success"==data.respuesta&&($scope.resetValores(4),$scope.catTipoProducto())})):alertify.notify("La descripción del tipo de producto debe ser mayor a 3 caracteres","warning",5):alertify.notify("El No. del Tipo de producto no es válido","warning",5)},$scope.resetValores(6),$scope.editarMedida=function(medida){$scope.accion="update",$scope.medidaProd.idMedida=medida.idMedida,$scope.medidaProd.medida=medida.medida,$("#medida").focus()},$scope.consultaMedida=function(){if($scope.$parent.loading)return!1;var medida=$scope.medidaProd;"update"!=$scope.accion||medida.idMedida&&0<medida.idMedida?medida.medida&&3<medida.medida.length?($scope.$parent.showLoading("Guardando..."),$http.post("consultas.php",{opcion:"consultaMedida",accion:$scope.accion,datos:$scope.medidaProd}).success(function(data){alertify.set("notifier","position","top-right"),alertify.notify(data.mensaje,data.respuesta,data.tiempo),$scope.$parent.hideLoading(),"success"==data.respuesta&&($scope.medidaProducto="",$scope.catMedidas(),$scope.resetValores(6))})):alertify.notify("La descripcion de la medida debe ser mayor a 3 caracteres","warning",5):alertify.notify("El No. de la medida no es válido","warning",5)},$scope.resetValores(2),$scope.ingresarReajuste=function(idProducto,nombreProducto,disponibilidad){$scope.itemProducto.idProducto=parseInt(idProducto),$scope.itemProducto.nombreProducto=nombreProducto,$scope.itemProducto.disponibilidad=disponibilidad,$scope.dialIngreso.show(),$timeout(function(){$("#cantidadReajuste").focus()},100)},$scope.retornarTotalReajuste=function(disponibilidad,cantidad,esIncremento){return cantidad?esIncremento?parseFloat(disponibilidad)+parseFloat(cantidad):parseFloat(disponibilidad)-parseFloat(cantidad):disponibilidad},$scope.modalOpen=function(_name){return null==_name?$("body>div").hasClass("modal")&&$("body>div").hasClass("top"):!(!$("#"+_name).data()||!$("#"+_name).data().$scope.$isShown)}}),app.controller("crtlAdmin",function($scope,$http,$modal,$timeout){$scope.adminMenu="ajustes",$scope.accion="insert",$scope.filtroUsuario="activos",document.getElementById("dial.adminUsuario.html")&&($scope.dialAdminUsuario=$modal({scope:$scope,template:"dial.adminUsuario.html",show:!1,backdrop:"static",keyboard:!1})),document.getElementById("dial.cambiarEstado.html")&&($scope.dialCambiarEstadoUsuario=$modal({scope:$scope,template:"dial.cambiarEstado.html",show:!1,backdrop:"static",keyboard:!1})),document.getElementById("dial.modulosPerfil.html")&&($scope.dialModulosPerfil=$modal({scope:$scope,template:"dial.modulosPerfil.html",show:!1,backdrop:"static",keyboard:!1})),$scope.$watch("filtroUsuario",function(_old,_new){_old!=_new&&"usuarios"==$scope.adminMenu&&$scope.cargarLstUsuarios()}),$scope.lstEstadoUsuario=[],$scope.cargarLstEstadoUsuario=function(){$http.post("consultas.php",{opcion:"lstEstadoUsuario"}).success(function(data){$scope.lstEstadoUsuario=data})},$scope.dataPerfil={},$scope.datosPerfil=function(perfil){$scope.dataPerfil=angular.copy(perfil),$scope.dataPerfil.lstModulosPerfil=[],$scope.consultarModulosPerfil($scope.dataPerfil.idPerfil),$scope.dialModulosPerfil.show()},$scope.consultarModulosPerfil=function(idPerfil){$http.post("consultas.php",{opcion:"consultarModulosPerfil",idPerfil:idPerfil}).success(function(data){$scope.dataPerfil.lstModulosPerfil=data||[]})},$scope.asignarModulo=function(idPerfil,idModulo,asignado){$scope.$parent.showLoading("Guardando..."),$http.post("consultas.php",{opcion:"asignarModulo",idPerfil:idPerfil,idModulo:idModulo,asignado:asignado}).success(function(data){alertify.set("notifier","position","top-right"),alertify.notify(data.mensaje,data.respuesta,data.tiempo),"success"==data.respuesta&&$scope.consultarModulosPerfil(idPerfil),$scope.$parent.hideLoading()})},$scope.actualizarEstadoUsuario=function(){$scope.$parent.showLoading("Guardando..."),$http.post("consultas.php",{opcion:"actualizarEstadoUsuario",data:$scope.user}).success(function(data){alertify.set("notifier","position","top-right"),alertify.notify(data.mensaje,data.respuesta,data.tiempo),"success"==data.respuesta&&($scope.filtroUsuario="activos",$scope.user={},$scope.dialCambiarEstadoUsuario.hide()),$scope.$parent.hideLoading()})},$scope.user={},$scope.cambiarEstadoUsuario=function(usuario){$scope.user=angular.copy(usuario),$scope.dialCambiarEstadoUsuario.show()},$scope.lstPerfiles=[],$scope.parametro=null,$scope.cargarLstPerfiles=function(){$http.post("consultas.php",{opcion:"lstPerfiles"}).success(function(data){$scope.lstPerfiles=data}),$scope.parametro=null,$http.post("consultas.php",{opcion:"getParams",idParametro:"gruposCocina"}).success(function(data){null!=data&&($scope.parametro=data)})},$scope.cargarLstUsuarios=function(){$http.post("consultas.php",{opcion:"cargarLstUsuarios",filtro:$scope.filtroUsuario}).success(function(data){$scope.lstUsuarios=data})},$scope.guardarParametro=function(){null==$scope.parametro.idParametro?alertify.notify("Parámetro no válido","warning",4):null==$scope.parametro.valor?alertify.notify("Valor no válido","warning",4):$http.post("consultas.php",{opcion:"setParams",idParametro:$scope.parametro.idParametro,valor:$scope.parametro.valor}).success(function(data){alertify.notify(data.mensaje||data,data.respuesta||"danger",4)})},$scope.accion="insert",$scope.editarPerfil=function(perfil){$scope.accion="update",$scope.perfil=angular.copy(perfil)},$scope.consultaPerfil=function(){if($scope.$parent.loading)return!1;var perfil=$scope.perfil;"update"!=$scope.accion||perfil.idPerfil&&0<perfil.idPerfil?perfil.perfil&&3<perfil.perfil.length?($scope.$parent.showLoading("Guardando..."),$http.post("consultas.php",{opcion:"consultaPerfil",accion:$scope.accion,datos:$scope.perfil}).success(function(data){alertify.set("notifier","position","top-right"),alertify.notify(data.mensaje,data.respuesta,data.tiempo),$scope.$parent.hideLoading(),"success"==data.respuesta&&($scope.cargarLstPerfiles(),$scope.resetValores("perfil"))})):alertify.notify("La descripcion del perfil debe ser mayor a 3 caracteres","warning",5):alertify.notify("No. de perfil no es válido","warning",3)},$scope.agregarUsuario=function(){$scope.accion="insert",$scope.usuario={usuario:"",idEstadoUsuario:1,idPerfil:1,codigo:null,clave:"",nombres:"",apellidos:""},$scope.dialAdminUsuario.show(),$timeout(function(){$("#nombreUsuario").focus()},125)},$scope.editarUsuario=function(usuario){$scope.accion="update",$scope.usuario=angular.copy(usuario),$scope.usuario.codigo=parseInt($scope.usuario.codigo),$scope.dialAdminUsuario.show(),$timeout(function(){$("#nombreUsuario").focus()},125)},$scope.consultaUsuario=function(){var usuario=$scope.usuario;usuario.idPerfil&&0<usuario.idPerfil?usuario.usuario?8<=usuario.usuario.length?usuario.codigo?0<usuario.codigo?usuario.nombres&&3<=usuario.nombres.length?usuario.apellidos&&2<=usuario.apellidos.length?($scope.$parent.showLoading("Guardando..."),$http.post("consultas.php",{opcion:"consultaUsuario",accion:$scope.accion,data:$scope.usuario}).success(function(data){alertify.set("notifier","position","top-right"),alertify.notify(data.mensaje,data.respuesta,data.tiempo),"success"==data.respuesta&&($scope.cargarLstUsuarios(),$scope.resetValores("usuario"),$scope.dialAdminUsuario.hide()),$scope.$parent.hideLoading()})):alertify.notify("Los apellidos de la persona debe tener más de 1 caracter","warning",5):alertify.notify("El nombre de la persona debe tener más de 2 caracteres","warning",5):alertify.notify("El código del usuario debe ser mayor a 0","warning",4):alertify.notify("Ingrese CÓDIGO de usuario válido, sin espacios en blanco","warning",5):alertify.notify("El nombre de usuario debe tener más de 7 caracteres","warning",5):alertify.notify("Ingrese usuario válido, sin espacios en blanco","warning",5):alertify.notify("Seleccione el perfil del Usuario","warning",4)},$scope.resetearClave=function(usuario){$http.post("consultas.php",{opcion:"resetearClave",usuario:usuario}).success(function(data){alertify.set("notifier","position","top-right"),alertify.notify(data.mensaje,data.respuesta,data.tiempo)})},$scope.resetValores=function(accion){$scope.accion="insert","usuario"==accion?$scope.usuario={usuario:"",idEstadoUsuario:1,idPerfil:1,codigo:null,clave:"",nombres:"",apellidos:""}:"perfil"==accion&&($scope.perfil={perfil:""})},$scope.documento=[],$scope.getDocumento=function(){if(!(0<$scope.idDocumento))return!1;$scope.documento=[],$http.post("consultas.php",{opcion:"getDocumento",idDocumento:$scope.idDocumento}).success(function(data){data.getDocumento.length&&($scope.documento=data.getDocumento)})},$scope.guardarDocumento=function(){for(var lstCampos=[],lstColumnas=[],ixC=0;ixC<$scope.documento.length;ixC++){var lstCambio=[],campo=$scope.documento[ixC];if(0<campo.x&&campo.x!=campo.old.x&&lstCambio.push({cmp:"x",val:campo.x}),0<campo.y&&campo.y!=campo.old.y&&lstCambio.push({cmp:"y",val:campo.y}),0<campo.fontSize&&campo.fontSize!=campo.old.fontSize&&lstCambio.push({cmp:"fontSize",val:campo.fontSize}),campo.mostrarTitulo!=campo.old.mostrarTitulo&&lstCambio.push({cmp:"mostrarTitulo",val:campo.mostrarTitulo}),2==campo.idTipoItem)for(var ixE=0;ixE<campo.encabezado.length;ixE++){var columna=campo.encabezado[ixE];0<columna.width&&columna.width!=columna.old.width&&lstColumnas.push({idColumnaLista:columna.idColumnaLista,val:columna.width})}lstCambio.length&&lstCampos.push({idDocumentoDetalle:campo.idDocumentoDetalle,lstCambio:lstCambio})}$http.post("consultas.php",{opcion:"guardarDocumento",lstCampos:lstCampos,lstColumnas:lstColumnas}).success(function(data){alertify.notify(data.mensaje,data.respuesta,4)})},$scope.$watch("idDocumento",function(_new){$scope.getDocumento()}),$scope.catDocumentos=[],$scope.idDocumento=0,($scope.inicio=function(){$scope.cargarLstEstadoUsuario(),$scope.cargarLstPerfiles(),$scope.cargarLstUsuarios(),$http.post("consultas.php",{opcion:"catDocumentos"}).success(function(data){$scope.catDocumentos=data.catDocumentos,$timeout(function(){$scope.idDocumento=$scope.catDocumentos[0].idDocumento})})})()}),app.controller("crtlOrden",function($scope,$http,$timeout,$modal,$location){$scope.lstTipoServicio=[],$scope.lstTipoMenu=[],$scope.lstMenu=[],$scope.noTicket=0,$scope.buscarTicket="",$scope.idTipoServicio="",$scope.idTipoMenu="",$scope.accionOrden="nuevo",$scope.idEstadoOrden=1,$scope.todoDetalle=!1,$scope.observacion="",$scope.comentario="",$scope.filtroServicio=1,$scope.miIndex=-1,$scope.myId="",$scope.ordenActual={idOrdenCliente:0,noTicket:"",totalAgregar:0,lstAgregar:[],lstPedidos:[]},$scope.menuActual={lstPrecio:[]},$scope.menuPer={},alertify.set("notifier","position","top-right"),$scope.nombreMenu=$scope.nombreCombo="",document.getElementById("ayuda.html")&&($scope.dlAyuda=$modal({scope:$scope,template:"ayuda.html",show:!1,backdrop:!1,keyboard:!0})),document.getElementById("dial.orden.nueva.html")&&($scope.dialOrden=$modal({scope:$scope,template:"dial.orden.nueva.html",show:!1,backdrop:!1,keyboard:!0})),document.getElementById("dial.orden.cliente.html")&&($scope.dialOrdenCliente=$modal({scope:$scope,template:"dial.orden.cliente.html",show:!1,backdrop:!1,keyboard:!1})),document.getElementById("dial.cantidad.html")&&($scope.dialCantidad=$modal({scope:$scope,template:"dial.cantidad.html",show:!1,backdrop:!1,keyboard:!1})),document.getElementById("dial.orden-menu.html")&&($scope.dialOrdenMenu=$modal({scope:$scope,template:"dial.orden-menu.html",show:!1,backdrop:!1,keyboard:!1})),document.getElementById("dial.menu-cantidad.html")&&($scope.dialMenuCantidad=$modal({scope:$scope,template:"dial.menu-cantidad.html",show:!1,backdrop:!1,keyboard:!1})),document.getElementById("dial.orden-busqueda.html")&&($scope.dialOrdenBusqueda=$modal({scope:$scope,template:"dial.orden-busqueda.html",show:!1,backdrop:!1,keyboard:!0})),document.getElementById("dial.orden.cancelar.html")&&($scope.dialOrdenCancelar=$modal({scope:$scope,template:"dial.orden.cancelar.html",show:!1,backdrop:!1,keyboard:!0})),document.getElementById("dial.orden.editar.html")&&($scope.dialEditarDetalle=$modal({scope:$scope,template:"dial.orden.editar.html",show:!1,backdrop:!1,keyboard:!0})),document.getElementById("dial.ultimas.ordenes.html")&&($scope.dialUltimasOrdenes=$modal({scope:$scope,template:"dial.ultimas.ordenes.html",show:!1,backdrop:!1,keyboard:!0})),document.getElementById("dial.orden.cancelar-parcial.html")&&($scope.dialCancelarDetalle=$modal({scope:$scope,template:"dial.orden.cancelar-parcial.html",show:!1,backdrop:!1,keyboard:!0})),document.getElementById("dial.orden.cancelar-otro.html")&&($scope.dialCancelarOtro=$modal({scope:$scope,template:"dial.orden.cancelar-otro.html",show:!1,backdrop:!1,keyboard:!0})),($scope.init=function(){$http.post("consultas.php",{opcion:"catTiposServicio"}).success(function(data){data.length&&($scope.lstTipoServicio=data,$scope.idTipoServicio=data[0].idTipoServicio)}),$http.post("consultas.php",{opcion:"catTipoMenu"}).success(function(data){data.length&&($scope.lstTipoMenu=data,$scope.idTipoMenu=data[0].idTipoMenu)})})(),$scope.openCantidad=function(){$scope.cantidadInicial=1,$scope.menuActual={},0<$scope.ordenActual.noTicket?0<$scope.ordenActual.noTicket&&3==$scope.idTipoServicio&&($scope.idTipoServicio=1):$scope.idTipoServicio=3,$scope.dialOrdenCliente.hide(),$scope.dialCantidad.show(),$timeout(function(){document.getElementById("cantidadInicial")&&document.getElementById("cantidadInicial").focus()})},$scope.lstTicketBusqueda=[],$scope.buscarOrdenTicket=function(_ticketDetalle){if($scope.$parent.loading)return!1;(0<$scope.buscarTicket||0<_ticketDetalle)&&($scope.lstTicketBusqueda=[],$scope.$parent.loading=!0,null==_ticketDetalle&&($scope.lstOrdenCliente=[]),$http.post("consultas.php",{opcion:"busquedaTicket",ticket:_ticketDetalle||$scope.buscarTicket}).success(function(data){$scope.$parent.loading=!1,Array.isArray(data)&&data.length?($scope.buscarTicket=0,1==data.length?$scope.seleccionarDeBusqueda(data[0],_ticketDetalle||0):1<data.length&&0<(_ticketDetalle||0)?alertify.notify("No se encontro información","info",3):($scope.lstTicketBusqueda=data,$scope.dialOrdenBusqueda.show())):alertify.notify("No se encontro información","info",2)}))},$scope.seleccionarDeBusqueda=function(orden,_ticketDetalle){0<_ticketDetalle?$scope.itemDetalle.destinoOrden=orden:($scope.miIndex=-1,$scope.dialOrdenBusqueda.hide(),$timeout(function(){$scope.consultaDetalleOrden(orden,!0)}))},$scope.lstOrdenCliente=[],$scope.consultaOrdenCliente=function(){if($scope.$parent.loading)return!1;$scope.lstOrdenCliente=[],0<$scope.idEstadoOrden&&($scope.miIndex=-1,$scope.$parent.loading=!0,$http.post("consultas.php",{opcion:"lstOrdenCliente",idEstadoOrden:$scope.idEstadoOrden}).success(function(data){$scope.$parent.loading=!1,Array.isArray(data)&&($scope.lstOrdenCliente=data),$timeout(function(){$scope.lstOrdenCliente.length&&($scope.miIndex=0)})}))},$scope.seleccionarTicket=function(idOrdenCliente){if($scope.miIndex=-1,idOrdenCliente&&0<idOrdenCliente)for(var i=0;i<$scope.lstOrdenCliente.length;i++)if($scope.lstOrdenCliente[i].idOrdenCliente==idOrdenCliente){$scope.miIndex=i;break}},$scope.downUpOrdenes=function(subir){if(!$scope.lstOrdenCliente.length)return!1;subir&&0<$scope.miIndex&&!$scope.$parent.loading?$scope.miIndex-=1:!subir&&$scope.miIndex+1<$scope.lstOrdenCliente.length&&!$scope.$parent.loading&&($scope.miIndex+=1)},$scope.nuevaOrden=function(){$scope.noTicket=0,$scope.dialOrden.show()},$scope.consultaOrden=function(orden){$scope.dialOrden.hide(),$scope.accionOrden="modificar",$scope.ordenActual={idOrdenCliente:orden.idOrdenCliente,noTicket:orden.numeroTicket,totalAgregar:0,lstAgregar:[],lstPedidos:[]},$scope.openCantidad()},$scope.agregarOrden=function(domicilio){if($scope.$parent.loading)return!1;$scope.codigoRapido="",0<parseInt($scope.noTicket)||"domicilio"==domicilio?($scope.$parent.loading=!0,$http.post("consultas.php",{opcion:"consultaOrdenCliente",accion:"insert",datos:{numeroTicket:$scope.noTicket,usuarioResponsable:"",lstU:$scope.$parent.lstU}}).success(function(data){$scope.$parent.loading=!1,"success"==data.respuesta?($scope.accionOrden="nuevo",$scope.dialOrden.hide(),$scope.ordenActual={idOrdenCliente:data.data,noTicket:parseInt($scope.noTicket),totalAgregar:0,lstAgregar:[],lstPedidos:[]},$scope.openCantidad()):(alertify.set("notifier","position","top-right"),alertify.notify(data.mensaje,data.respuesta,data.tiempo))})):(alertify.set("notifier","position","top-right"),alertify.notify("Número de Ticket NO Válido","danger",4))},$scope.tipoMenu="menu",$scope.mostrarMenus=function(tipoMenu){$scope.tipoMenu="menu"==tipoMenu?($scope.nombreMenu="","menu"):($scope.nombreCombo="","combo"),$scope.consultaMenus(),$scope.dialOrdenMenu.show(),$scope.dialCantidad.hide(),$timeout(function(){$("#"+tipoMenu).focus()},175)},$scope.lstCombo=[],$scope.consultaMenus=function(){if($scope.$parent.loading)return!1;"menu"==$scope.tipoMenu&&0<$scope.idTipoMenu?($scope.$parent.loading=!0,$scope.lstMenu=[],$http.post("consultas.php",{opcion:"lstMenu",idTipoMenu:$scope.idTipoMenu,idEstadoMenu:1}).success(function(data){$scope.$parent.loading=!1,data.length&&($scope.lstMenu=data)})):"combo"==$scope.tipoMenu&&($scope.$parent.loading=!0,$scope.lstCombo=[],$http.post("consultas.php",{opcion:"lstCombo",idEstadoMenu:1}).success(function(data){$scope.$parent.loading=!1,data.length&&($scope.lstCombo=data)}))},$scope.seleccionarMenu=function(menu){if($scope.$parent.loading)return!1;var datos={opcion:"precioDisponibilidad",idMenu:0,idCombo:0,idTipoServicio:$scope.idTipoServicio,cantidad:$scope.cantidadInicial};"menu"==$scope.tipoMenu?($scope.menuActual={idMenu:menu.idMenu,menu:menu.menu,imagen:menu.imagen},datos.idMenu=menu.idMenu):"combo"==$scope.tipoMenu&&($scope.menuActual={idMenu:menu.idCombo,menu:menu.combo,imagen:menu.imagen},datos.idCombo=menu.idCombo),$scope.menuActual.precio=0,$scope.menuActual.lstPrecio=[],$scope.observacion="",$scope.lstSinDisponibilidad=[],$scope.$parent.loading=!0,$http.post("consultas.php",datos).success(function(data){$scope.$parent.loading=!1,data.precio&&0<data.precio&&($scope.menuActual.precio=data.precio,$scope.lstSinDisponibilidad=data.lstSinDisponibilidad,$scope.dialOrdenMenu.hide(),data.lstSinDisponibilidad.length?$scope.dialCantidad.show():$scope.agregarOrdenLista())})},$scope.agregarOrdenLista=function(){if(0<$scope.menuActual.precio)if(0<$scope.cantidadInicial)if(0<$scope.idTipoServicio){var tipoServicio=$scope.descripcion("lstTipoServicio","idTipoServicio",$scope.idTipoServicio,"tipoServicio"),subTotal=parseFloat($scope.menuActual.precio)*$scope.cantidadInicial;$scope.ordenActual.totalAgregar+=subTotal;for(var index=-1,i=0;i<$scope.ordenActual.lstAgregar.length;i++)if($scope.ordenActual.lstAgregar[i].idMenu==$scope.menuActual.idMenu&&$scope.ordenActual.lstAgregar[i].idTipoServicio==$scope.idTipoServicio&&$scope.ordenActual.lstAgregar[i].tipoMenu==$scope.tipoMenu){index=i;break}0<=index?$scope.ordenActual.lstAgregar[index].cantidad+=parseInt($scope.cantidadInicial):$scope.ordenActual.lstAgregar.unshift({idMenu:$scope.menuActual.idMenu,menu:$scope.menuActual.menu,cantidad:parseInt($scope.cantidadInicial),precio:$scope.menuActual.precio,tipoServicio:tipoServicio,idTipoServicio:$scope.idTipoServicio,tipoMenu:$scope.tipoMenu,observacion:$scope.observacion}),$scope.dialCantidad.hide(),$scope.dialOrdenCliente.show()}else alertify.notify("Debe seleccionar un Tipo de Servicio","danger",2);else alertify.notify("La cantidad debe ser mayor a cero","danger",2);else alertify.notify("Menú no disponible para este Tipo de Servicio","danger",3)},$scope.guardarOrden=function(){if($scope.$parent.loading)return!1;if($scope.ordenActual.lstAgregar.length){for(var lstAgregar=[],i=0;i<$scope.ordenActual.lstAgregar.length;i++)lstAgregar.push({idMenu:$scope.ordenActual.lstAgregar[i].idMenu,cantidad:$scope.ordenActual.lstAgregar[i].cantidad,precio:$scope.ordenActual.lstAgregar[i].precio,menu:$scope.ordenActual.lstAgregar[i].menu,idTipoServicio:$scope.ordenActual.lstAgregar[i].idTipoServicio,tipoMenu:$scope.ordenActual.lstAgregar[i].tipoMenu,observacion:$scope.ordenActual.lstAgregar[i].observacion});$scope.$parent.loading=!0,$http.post("consultas.php",{opcion:"guardarDetalleOrden",idOrdenCliente:$scope.ordenActual.idOrdenCliente,lstAgregar:lstAgregar,accionOrden:$scope.accionOrden}).success(function(data){$scope.$parent.loading=!1,"success"==data.respuesta?(alertify.notify(data.mensaje,data.respuesta,data.tiempo),$scope.dialOrdenCliente.hide(),$scope.ordenActual.lstAgregar=[],data.myId!=$scope.myId&&($scope.myId=data.myId,"nuevo"==$scope.accionOrden?($scope.lstOrdenCliente.push(data.data.paraMesero),$timeout(function(){$scope.ordenActual.idOrdenCliente==data.data.idOrdenCliente&&($scope.miIndex=$scope.lstOrdenCliente.length-1)})):$scope.consultaDetalleOrden())):alertify.notify(data.mensaje,data.respuesta,data.tiempo)})}else alertify.notify("No ha agregado ningún menú","danger",4)},$scope.lstSinDisponibilidad=[],$scope.consultaMenuPorCodigo=function(){if($scope.$parent.loading)return!1;0<$scope.codigoRapido&&($scope.$parent.loading=!0,$scope.lstSinDisponibilidad=[],$http.post("consultas.php",{opcion:"menuPorCodigo",codigoRapido:$scope.codigoRapido,cantidad:$scope.cantidadInicial,idTipoServicio:$scope.idTipoServicio}).success(function(data){$scope.$parent.loading=!1,$scope.codigoRapido="",null!=data.tipoMenu?($scope.menuActual=data.menu,$scope.tipoMenu=data.tipoMenu,$scope.observacion="",data.menu.lstSinDisponibilidad.length||$scope.agregarOrdenLista(),$scope.lstSinDisponibilidad=data.menu.lstSinDisponibilidad):alertify.notify("Código no válido","danger",2)}))},$scope.cancelarOrdenPrincipal=function(idOrdenCliente){if($scope.$parent.loading)return!1;5<$scope.comentario.length?0<idOrdenCliente?($scope.$parent.loading=!0,$http.post("consultas.php",{opcion:"consultaOrdenCliente",accion:"cancel",datos:{idOrdenCliente:idOrdenCliente,comentario:$scope.comentario}}).success(function(data){$scope.$parent.loading=!1,alertify.notify(data.mensaje,data.respuesta,data.tiempo),"success"==data.respuesta&&$scope.dialOrdenCancelar.hide()})):alertify.notify("Orden de Cliente no válida","danger",4):alertify.notify("Comentario demasiado corto","danger",5)},$scope.cancelarOrdenParcial=function(idOrdenCliente,lstDetalle){if($scope.$parent.loading)return!1;3<$scope.comentario.length||!Array.isArray(lstDetalle)?($scope.$parent.loading=!0,$http.post("consultas.php",{opcion:"cancelarOrdenParcial",idOrdenCliente:idOrdenCliente,lstDetalle:lstDetalle,comentario:$scope.comentario}).success(function(data){$scope.$parent.loading=!1,null!=data.mensaje&&(alertify.notify(data.mensaje,data.respuesta,3),"success"==data.respuesta&&($scope.dialCancelarDetalle.hide(),$scope.dialCancelarOtro.hide(),$scope.consultaDetalleOrden()))})):alertify.notify("Comentario demasiado corto","danger",5)},$scope.modalBuscar=function(){$scope.dialOrdenBusqueda.show(),$timeout(function(){document.getElementById("inputSearch").focus()},200)},$scope.infoOrden={},$scope.deBusqueda=!1,$scope.lstEstados=[{abr:"P",title:"Pendiente",css:"default"},{abr:"C",title:"Cocinando",css:"info"},{abr:"L",title:"Listo",css:"primary"},{abr:"S",title:"Servido",css:"success"}],$scope.consultaDetalleOrden=function(orden,deBusqueda,force){return(!$scope.$parent.loading||void 0!==force)&&(void 0!==orden&&($scope.deBusqueda=null!=deBusqueda&&!($scope.idEstadoOrden=0),$scope.infoOrden=orden),0<$scope.infoOrden.idOrdenCliente&&($scope.$parent.loading=!0,void $http.post("consultas.php",{opcion:"lstDetalleOrdenCliente",idOrdenCliente:$scope.infoOrden.idOrdenCliente,todo:$scope.todoDetalle}).success(function(data){if($scope.$parent.loading=!1,data.lst){for(var ix=0;ix<data.lst.length;ix++){for(var lstEstados=[],im=0;im<data.lst[ix].lstMenus.length;im++){for(var menu=data.lst[ix].lstMenus[im],ixT=-1,idEstadoActual=parseInt(menu.perteneceCombo?menu.idEstadoDetalleOrdenCombo:menu.idEstadoDetalleOrden),ie=0;ie<lstEstados.length;ie++)if(idEstadoActual==lstEstados[ie].idEstado){ixT=ie;break}if(-1==ixT){var estado=$scope.lstEstados[idEstadoActual-1]||{};ixT=lstEstados.length,lstEstados.push({idEstado:idEstadoActual,abr:estado.abr,title:estado.title,css:estado.css,total:0})}lstEstados[ixT].total++}data.lst[ix].estados=lstEstados}$scope.infoOrden.lstOrden=data.lst,$scope.infoOrden.lstOtros=data.lstOtros,$scope.infoOrden.total=data.total}})))},$scope.itemDetalle={},$scope.cancelarDetalle=function(itemDetalle){$scope.itemDetalle=itemDetalle,$scope.comentario="",$scope.dialCancelarDetalle.show()},$scope.cancelarOtroMenu=function(otroMenu){$scope.itemDetalle=otroMenu,$scope.dialCancelarOtro.show()},$scope.accionDetalleOrden="tipoServicio",$scope.editarDetalle=function(item){$scope.itemDetalle={descripcion:item.descripcion,imagen:item.imagen,cantidad:item.cantidad,lstMenus:angular.copy(item.lstMenus),lstDetalle:angular.copy(item.lstDetalle),idTipoServicio:item.idTipoServicio,lstTipoServicio:angular.copy($scope.lstTipoServicio),busqueda:"",destinoOrden:{},cantidadReasignar:angular.copy(item.cantidad)};for(var ixT=0;ixT<$scope.itemDetalle.lstTipoServicio.length;ixT++)$scope.itemDetalle.lstTipoServicio[ixT].cantidad="",item.idTipoServicio==$scope.itemDetalle.lstTipoServicio[ixT].idTipoServicio&&($scope.itemDetalle.lstTipoServicio[ixT].cantidad=item.cantidad);$scope.dialEditarDetalle.show(),$timeout(function(){document.getElementById("input_ts_0")&&document.getElementById("input_ts_0").focus()})},$scope.editarOrdenParcial=function(){if($scope.$parent.loading)return!1;if("tipoServicio"==$scope.accionDetalleOrden){for(var total=0,_current=null,lstDetalle=[],cantidadMenus=angular.copy($scope.itemDetalle.cantidad),ix=0;ix<$scope.itemDetalle.lstTipoServicio.length;ix++)if(total+=(_current=$scope.itemDetalle.lstTipoServicio[ix]).cantidad||0,_current&&_current.cantidad&&_current.idTipoServicio!=$scope.itemDetalle.idTipoServicio){for(var im=1;im<=_current.cantidad;im++){var index=cantidadMenus-im;if(void 0===$scope.itemDetalle.lstMenus[index])break;lstDetalle.push({idDetalleOrdenMenu:$scope.itemDetalle.lstMenus[index].idDetalleOrdenMenu,idDetalleOrdenCombo:$scope.itemDetalle.lstMenus[index].idDetalleOrdenCombo,idTipoServicio:_current.idTipoServicio})}cantidadMenus-=_current.cantidad}if(total!=$scope.itemDetalle.cantidad)alertify.notify("La suma de los Tipos de Servicios debe ser igual a: "+$scope.itemDetalle.cantidad,"danger",5),!0;else if(0===lstDetalle.length)alertify.notify("Ningún cambio realizado ","info",5),$scope.dialEditarDetalle.hide();else{$scope.$parent.loading=!0;var datos={opcion:"cambiarServicio",idOrdenCliente:$scope.infoOrden.idOrdenCliente,lstDetalle:lstDetalle};$http.post("consultas.php",datos).success(function(data){$scope.$parent.loading=!1,alertify.notify(data.mensaje||data,data.respuesta||"danger",5),"success"==data.respuesta&&($scope.dialEditarDetalle.hide(),$scope.consultaDetalleOrden())})}}else if("reasignar"==$scope.accionDetalleOrden){lstDetalle=[];if(!(0<$scope.itemDetalle.cantidadReasignar)||$scope.itemDetalle.cantidadReasignar>$scope.itemDetalle.cantidad)return alertify.notify("Cantidad no válida","danger",3),!1;for(im=1;im<=$scope.itemDetalle.cantidadReasignar;im++){index=$scope.itemDetalle.lstMenus.length-im;if(void 0===$scope.itemDetalle.lstMenus[index])break;lstDetalle.push({idDetalleOrdenMenu:$scope.itemDetalle.lstMenus[index].idDetalleOrdenMenu,idDetalleOrdenCombo:$scope.itemDetalle.lstMenus[index].idDetalleOrdenCombo})}datos={opcion:"reasignarDetalleOrden",idOrdenCliente:$scope.infoOrden.idOrdenCliente,idOrdenClienteDestino:$scope.itemDetalle.destinoOrden.idOrdenCliente,lstDetalle:lstDetalle};$scope.$parent.loading=!0,$http.post("consultas.php",datos).success(function(data){$scope.$parent.loading=!1,alertify.notify(data.mensaje||data,data.respuesta||"danger",5),"success"==data.respuesta&&($scope.dialEditarDetalle.hide(),$scope.consultaDetalleOrden())})}},$scope.agregarOtroMenu=function(){0<$scope.menuPer.cantidad?0<$scope.menuPer.precioUnidad?$scope.menuPer.descripcion&&0<$scope.menuPer.descripcion.length?(console.log($scope.menuPer),$scope.ordenActual.lstAgregar.unshift({idMenu:null,menu:$scope.menuPer.descripcion,cantidad:$scope.menuPer.cantidad,precio:$scope.menuPer.precioUnidad,tipoServicio:"",idTipoServicio:"",tipoMenu:"personalizado",observacion:null}),$scope.filtroServicio="",$scope.menuPer={}):alertify.notify("Revise Descripción","danger",5):alertify.notify("Revise Precio por Unidad","danger",5):alertify.notify("Revise Cantidad","danger",5)},$scope.ordenCantidad=function(index,sumar,cantidad,precio){sumar?($scope.ordenActual.lstAgregar[index].cantidad++,$scope.ordenActual.totalAgregar+=precio):1<cantidad&&($scope.ordenActual.lstAgregar[index].cantidad--,$scope.ordenActual.totalAgregar-=precio)},$scope.total=function(){for(var total=0,i=0;i<$scope.ordenActual.lstAgregar.length;i++)actual=$scope.ordenActual.lstAgregar[i],actual.cantidad=parseInt(actual.cantidad),actual.precio=parseFloat(actual.precio),actual.cantidad&&actual.precio&&(total+=actual.cantidad*actual.precio);$scope.ordenActual.totalAgregar=total},$scope.quitarElemento=function(index,cantidad,precio){$scope.ordenActual.totalAgregar-=cantidad*precio,$scope.ordenActual.lstAgregar.splice(index,1)},$scope.cancelarMenu=function(){$scope.menuActual&&0<$scope.menuActual.idMenu&&($scope.menuActual={},$timeout(function(){document.getElementById("codigoRapido")&&document.getElementById("codigoRapido").focus()}))},$scope.changeInt=function(val,sum,min,max){return(val=parseInt(val))&&val<max&&sum?val+1:val&&min<val&&!sum?val-1:val||min},$scope.$watch("idEstadoOrden",function(_new){$scope.todoDetalle=10==_new,$scope.consultaOrdenCliente()}),$scope.$watch("idTipoMenu",function(_new){$scope.consultaMenus()}),$scope.$watch("idTipoServicio",function(_new,_old){_new&&($scope.filtroServicio=_new)}),$scope.$watch("miIndex",function(_new){$scope.infoOrden={},0<=_new&&$scope.lstOrdenCliente[_new]&&$scope.consultaDetalleOrden($scope.lstOrdenCliente[_new])}),$scope.auxKeyTicket=function(accion,numero,model1,model2){if("number"==accion){var numeroTxt=numero.toString();if(null!=model2){var noTicketTxt=parseInt($scope[model1][model2]||0).toString();$scope[model1][model2]=parseInt(noTicketTxt+numeroTxt)}else{noTicketTxt=parseInt($scope[model1]||0).toString();$scope[model1]=parseInt(noTicketTxt+numeroTxt)}}("supr"==accion&&(null!=model2?$scope[model1][model2]=0:$scope[model1]=0),"back"==accion)&&(null!=model2?(noTicketTxt=(noTicketTxt=parseInt($scope[model1][model2]).toString()).substr(0,noTicketTxt.length-1),$scope[model1][model2]=parseInt(noTicketTxt)):(noTicketTxt=(noTicketTxt=parseInt($scope[model1]).toString()).substr(0,noTicketTxt.length-1),$scope[model1]=parseInt(noTicketTxt)))},$scope._keyInicioOrden=function(key,altDerecho){altDerecho&&86==key&&$scope.nuevaOrden(),38==key&&$scope.downUpOrdenes(!0),40==key&&$scope.downUpOrdenes(!1),33==key&&$scope.lstOrdenCliente.length&&($scope.miIndex=0),34==key&&$scope.lstOrdenCliente.length&&($scope.miIndex=$scope.lstOrdenCliente.length-1),altDerecho&&80==key&&($scope.idEstadoOrden=1),altDerecho&&76==key&&($scope.idEstadoOrden=3),altDerecho&&70==key&&($scope.idEstadoOrden=4),altDerecho&&67==key&&($scope.idEstadoOrden=10),altDerecho&&83==key&&($scope.idEstadoOrden=6),48<=key&&key<=57&&!$("#buscarTicket").is(":focus")&&$scope.auxKeyTicket("number",key-48,"buscarTicket"),96<=key&&key<=105&&!$("#buscarTicket").is(":focus")&&$scope.auxKeyTicket("number",key-96,"buscarTicket"),46==key&&$scope.auxKeyTicket("supr",0,"buscarTicket"),8!=key||$("#buscarTicket").is(":focus")||$scope.auxKeyTicket("back",0,"buscarTicket"),13!=key&&117!=key||$scope.buscarOrdenTicket(),115==key&&0<$scope.infoOrden.idOrdenCliente&&$location.path("/factura/"+$scope.infoOrden.idOrdenCliente),altDerecho&&65==key&&0<$scope.infoOrden.idOrdenCliente&&$scope.infoOrden.idEstadoOrden<=4?$scope.consultaOrden($scope.infoOrden):altDerecho&&88==key&&0<$scope.infoOrden.idOrdenCliente&&($scope.dialOrdenCancelar.show(),$scope.comentario="",$timeout(function(){document.getElementById("txtCancelar")&&document.getElementById("txtCancelar").focus()}))},$scope._keyDialTicket=function(key){27==key&&$scope.dialOrden.hide(),48<=key&&key<=57&&!$("#noTicket").is(":focus")&&$scope.auxKeyTicket("number",key-48,"noTicket"),96<=key&&key<=105&&!$("#noTicket").is(":focus")&&$scope.auxKeyTicket("number",key-96,"noTicket"),46==key&&$scope.auxKeyTicket("supr",0,"noTicket"),8!=key||$("#noTicket").is(":focus")||$scope.auxKeyTicket("back",0,"noTicket"),68!=key||0<$scope.noTicket||$scope.agregarOrden("domicilio"),13!=key&&117!=key||$scope.agregarOrden()},$scope._keyDialOrden=function(key,altDerecho){console.log(key),altDerecho&&65==key&&$scope.openCantidad(),117==key&&$scope.guardarOrden(),27==key&&"modificar"==$scope.accionOrden&&$scope.dialOrdenCliente.hide(),37==key&&1<$scope.filtroServicio?$scope.filtroServicio--:37==key&&1==$scope.filtroServicio?$scope.filtroServicio="":39==key&&$scope.filtroServicio<3?$scope.filtroServicio++:39==key&&""==$scope.filtroServicio&&($scope.filtroServicio=1)},$scope._keyCantidad=function(key,altDerecho){(109==key||189==key)&&1<$scope.cantidadInicial&&($scope.cantidadInicial=$scope.changeInt($scope.cantidadInicial,!1,1,500)),107!=key&&187!=key||($scope.cantidadInicial=$scope.changeInt($scope.cantidadInicial,!0,1,500)),46==key&&$scope.cancelarMenu(),$("#codigoRapido").is(":focus")&&8==key&&$scope.auxKeyTicket("supr",0,"codigoRapido"),$("#cantidadInicial").is(":focus")&&13==key&&document.getElementById("codigoRapido").focus(),$("#codigoRapido").is(":focus")&&13==key&&$scope.consultaMenuPorCodigo(),altDerecho&&!$("#observacionMenu").is(":focus")&&79==key&&document.getElementById("observacionMenu").focus(),altDerecho&&!$("#observacionMenu").is(":focus")&&76==key&&0<$scope.ordenActual.noTicket&&($scope.idTipoServicio=1),altDerecho&&!$("#observacionMenu").is(":focus")&&82==key&&0<$scope.ordenActual.noTicket&&($scope.idTipoServicio=2),!altDerecho||$("#observacionMenu").is(":focus")||68!=key||0<$scope.ordenActual.noTicket||($scope.idTipoServicio=3),76!=key&&82!=key&&68!=key||$timeout(function(){$("#cantidadInicial").focus()},100),altDerecho&&!$("#observacionMenu").is(":focus")&&77==key&&$scope.mostrarMenus("menu"),altDerecho&&!$("#observacionMenu").is(":focus")&&67==key&&$scope.mostrarMenus("combo"),27==key&&($scope.dialCantidad.hide(),$scope.dialOrdenCliente.show())},$scope._keyDialMenuCantidad=function(key,altDerecho){117==key?$scope.agregarAPedido():(109==key||189==key)&&1<$scope.menuActual.cantidad?$scope.menuActual.cantidad--:107==key||187==key?(isNaN($scope.menuActual.cantidad)&&($scope.menuActual.cantidad=0),$scope.menuActual.cantidad++):27==key?($scope.dialMenuCantidad.hide(),$scope.dialOrdenCliente.show()):48<=key&&key<=57&&!$("#cantidad_menu").is(":focus")?$scope.auxKeyTicket("number",key-48,"menuActual","cantidad"):96<=key&&key<=105&&!$("#cantidad_menu").is(":focus")?$scope.auxKeyTicket("number",key-96,"menuActual","cantidad"):46==key?$scope.auxKeyTicket("supr",0,"menuActual","cantidad"):8!=key||$("#cantidad_menu").is(":focus")||$scope.auxKeyTicket("back",0,"menuActual","cantidad")},$scope.$on("keyPress",function(event,key,altDerecho){if((altDerecho&&67==key||187==key||189==key||109==key||107==key)&&event.preventDefault(),$scope.$parent.loading)return!1;$scope.modalOpen()?($scope.modalOpen("dial_orden_nueva")&&$scope._keyDialTicket(key),$scope.modalOpen("dial_orden_cliente")&&$scope._keyDialOrden(key,altDerecho),$scope.modalOpen("dial_cantidad")&&$scope._keyCantidad(key,altDerecho),$scope.modalOpen("dial_orden_menu")&&27==key&&($scope.dialOrdenMenu.hide(),$scope.dialOrdenCliente.show()),$scope.modalOpen("dial_menu_cantidad")&&$scope._keyDialMenuCantidad(key,altDerecho)):$scope._keyInicioOrden(key,altDerecho)}),$scope.modalOpen=function(_name){return null==_name?$("body>div").hasClass("modal")&&$("body>div").hasClass("top"):!(!$("#"+_name).data()||!$("#"+_name).data().$scope.$isShown)},$scope.$on("infoNode",function(event,datos){switch(datos.accion){case"ordenNueva":datos.data.myId==$scope.myId||$scope.$parent.loading||($scope.myId=datos.data.myId,datos.data.info&&datos.data.info.paraMesero&&(1==$scope.idEstadoOrden||2==$scope.idEstadoOrden)&&($scope.lstOrdenCliente.push(datos.data.info.paraMesero),$timeout(function(){$scope.ordenActual.idOrdenCliente==datos.data.idOrdenCliente&&($scope.miIndex=$scope.lstOrdenCliente.length-1)})));break;case"ordenAgregar":datos.data.myId==$scope.myId||$scope.$parent.loading||($scope.myId=datos.data.myId,$scope.infoOrden.idOrdenCliente==datos.data.idOrdenCliente&&$scope.consultaDetalleOrden(void 0,void 0,!0));break;case"cambioTipoServicio":$scope.infoOrden.idOrdenCliente==datos.data.idOrdenCliente&&$scope.consultaDetalleOrden();break;case"ordenPrincipalCancelada":if(1==$scope.idEstadoOrden||2==$scope.idEstadoOrden){var index=$scope.indexArray("lstOrdenCliente","idOrdenCliente",datos.idOrdenCliente),newIndex=0;$scope.miIndex==index&&($scope.miIndex=-1),$scope.miIndex+1==$scope.lstOrdenCliente.length&&(newIndex=$scope.miIndex-1,$scope.miIndex=-1),0<=index&&$scope.lstOrdenCliente.splice(index,1),$timeout(function(){$scope.lstOrdenCliente.length&&-1==$scope.miIndex&&($scope.miIndex=newIndex)})}break;case"cancelarOrdenParcial":$scope.infoOrden.idOrdenCliente==datos.data.idOrdenCliente&&$scope.consultaDetalleOrden();break;case"cambioEstadoDetalleOrden":for(var ixO=0;ixO<datos.data.ordenCocina.lstOrden.length;ixO++)if($scope.infoOrden.idOrdenCliente==datos.data.ordenCocina.lstOrden[ixO].idOrdenCliente){$scope.consultaDetalleOrden();break}}$scope.$apply()}),$scope.descripcion=function(arr,id,_value,_return){for(var descrip="",i=0;i<$scope[arr].length;i++)if($scope[arr][i][id]==_value){descrip=$scope[arr][i][_return];break}return descrip},$scope.indexArray=function(arr,cmp,_value){for(var index=-1,i=0;i<$scope[arr].length;i++)if($scope[arr][i][cmp]==_value){index=i;break}return index}}),app.controller("crtlAdminOrden",function($scope,$http,$timeout,$modal){$scope.lstMenu=[],$scope.idEstadoOrden=1,$scope.idEstadoOrdenTk=1,$scope.tipoVista="ticket",$scope.ixMenuActual=-1,$scope.ixTicketActual=-1,$scope.ixMenuFocus=-1,$scope.ixTicketFocus=-1,$scope.lstDestinoMenu=[],$scope.lstMenus=[],$scope.lstTickets=[],$scope.codigoPersonal="",$scope.clave="",$scope.keyPanel="",$scope.lstGrupos=[{numeroGrupo:"99",grupo:"Todos"},{numeroGrupo:"1",grupo:"Grupo #1"},{numeroGrupo:"2",grupo:"Grupo #2"},{numeroGrupo:"3",grupo:"Grupo #3"},{numeroGrupo:"4",grupo:"Grupo #4"},{numeroGrupo:"5",grupo:"Grupo #5"}],$scope.numeroGrupo="99",$scope.seleccionMenu={si:!1,menu:"",imagen:null,count:{total:0,llevar:0,restaurante:0,domicilio:0}},$scope.seleccionTicket={si:!1,menu:"",imagen:null,numeroTicket:"",count:{total:0,llevar:0,restaurante:0,domicilio:0}},$scope.lstEstados=[{abr:"P",title:"Pendiente",css:"default"},{abr:"C",title:"Cocinando",css:"info"},{abr:"L",title:"Listo",css:"primary"},{abr:"S",title:"Servido",css:"success"}],$scope.ticketActual={},$scope.idDestinoMenu="",$scope.agruparPor="",$scope.user={},document.getElementById("consulta.personal.html")&&($scope.dConsultaPersonal=$modal({scope:$scope,template:"consulta.personal.html",show:!1,backdrop:!1,keyboard:!0})),document.getElementById("ayuda.html")&&($scope.dAyuda=$modal({scope:$scope,template:"ayuda.html",show:!1,backdrop:!1,keyboard:!0})),alertify.set("notifier","position","top-right"),$http.post("consultas.php",{opcion:"iniOrdenAdmin"}).success(function(data){null!=data.usuario&&($scope.lstDestinoMenu=data.lstDestinoMenu,$scope.user=data.usuario,$timeout(function(){data.lstDestinoMenu.length&&($scope.idDestinoMenu=$scope.user.idDestinoMenu||"1")}))}),$scope.dialogoConsultaPersonal=function(agruparPor){$scope.codigoPersonal="",$scope.clave="",$scope.dConsultaPersonal.show(),$timeout(function(){document.getElementById("codigoPersonal").focus()},50)},$scope.consultarPersonal=function(){$http.post("consultas.php",{opcion:"login",codigoPersonal:$scope.codigoPersonal,clave:$scope.clave}).success(function(data){alertify.set("notifier","position","top-right"),alertify.notify(data.mensaje,data.respuesta,4),"success"==data.respuesta?($scope.dConsultaPersonal.hide(),null!=data.usuario&&($scope.user=data.usuario,$scope.lstDestinoMenu=data.usuario.lstDestinos,$scope.idDestinoMenu="",$timeout(function(){$scope.lstDestinoMenu.length&&($scope.idDestinoMenu=$scope.lstDestinoMenu[0].idDestinoMenu)}))):document.getElementById("codigoPersonal").focus()})},$scope.consultaOrden=function(){if($scope.$parent.loading)return!1;if(0<$scope.idEstadoOrden&&0<$scope.idDestinoMenu&&0<$scope.numeroGrupo){var datos={opcion:"consultaOrdenesCocina",idEstadoDetalleOrden:$scope.idEstadoOrden,idDestinoMenu:$scope.idDestinoMenu,numeroGrupo:$scope.numeroGrupo};$scope.$parent.loading=!0,$http.post("consultas.php",datos).success(function(data){$scope.$parent.loading=!1,Array.isArray(data.lstMenu)&&($scope.ixMenuActual=-1,$scope.lstMenus=data.lstMenu)})}},$scope.consultaOrdenTicket=function(ignoreWait){if($scope.$parent.loading&&!ignoreWait)return!1;if(0<$scope.idEstadoOrdenTk&&0<$scope.idDestinoMenu){var datos={opcion:"lstOrdenPorTicket",idEstadoOrden:1==$scope.idEstadoOrdenTk?"valid":4,numeroGrupo:$scope.numeroGrupo};$scope.$parent.loading=!0,$http.post("consultas.php",datos).success(function(data){$scope.$parent.loading=!1,Array.isArray(data.lstTicket)&&($scope.lstTickets=data.lstTicket)})}},$scope.consultaDetalleOrden=function(force){return(!$scope.$parent.loading||void 0!==force)&&(0<$scope.ticketActual.idOrdenCliente&&($scope.ticketActual.lstOrden=[],$scope.$parent.loading=!0,void $http.post("consultas.php",{opcion:"lstDetalleOrdenCliente",idOrdenCliente:$scope.ticketActual.idOrdenCliente,todo:!1}).success(function(data){if($scope.$parent.loading=!1,data.lst){for(var ix=0;ix<data.lst.length;ix++){for(var lstEstados=[],im=0;im<data.lst[ix].lstMenus.length;im++){var menu=data.lst[ix].lstMenus[im],ixT=-1,idEstadoActual=parseInt(menu.perteneceCombo?menu.idEstadoDetalleOrdenCombo:menu.idEstadoDetalleOrden);if(-1==(ixT=$scope.indexArray(lstEstados,"idEstado",idEstadoActual))){var estado=$scope.lstEstados[idEstadoActual-1]||{};ixT=lstEstados.length,lstEstados.push({idEstado:idEstadoActual,abr:estado.abr,title:estado.title,css:estado.css,total:0})}lstEstados[ixT].total++}data.lst[ix].estados=lstEstados}$scope.ticketActual.lstOrden=data.lst,console.log(data),$timeout(function(){for(var index=-1,ix=0;ix<data.lst.length;ix++)if(data.lst[ix].limite){index=ix;break}0<=index&&document.getElementById("detalle_orden_"+index)&&document.getElementById("detalle_orden_"+index).focus()})}})))},$scope.servirMenu=function(index){var orden=angular.copy($scope.ticketActual.lstOrden[index]);if($scope.$parent.loading||!(0<orden.seleccionados))return!1;var datos={opcion:"servirMenuCliente",datos:{idOrdenCliente:$scope.ticketActual.idOrdenCliente,seleccionados:orden.seleccionados,idCombo:orden.esCombo?orden.idCombo:null,idMenu:orden.esCombo?null:orden.idMenu,idTipoServicio:orden.idTipoServicio}};if(!(0<$scope.ticketActual.idOrdenCliente))return!1;$scope.$parent.loading=!0,$http.post("consultas.php",datos).success(function(data){$scope.$parent.loading=!1,alertify.notify(data.mensaje||data,data.respuesta||"danger",5),data.respuesta})},$scope.servirTodo=function(){for(var lstOrden=[],ixO=0;ixO<$scope.ticketActual.lstOrden.length;ixO++){var orden=$scope.ticketActual.lstOrden[ixO];lstOrden.push({idOrdenCliente:$scope.ticketActual.idOrdenCliente,seleccionados:orden.seleccionados,idCombo:orden.esCombo?orden.idCombo:null,idMenu:orden.esCombo?null:orden.idMenu,idTipoServicio:orden.idTipoServicio,limite:orden.limite})}if($scope.$parent.loading||!(0<lstOrden.length))return!1;var datos={opcion:"servirTodo",lstOrden:lstOrden};$scope.$parent.loading=!0,$http.post("consultas.php",datos).success(function(data){if($scope.$parent.loading=!1,alertify.notify(data.mensaje||data,data.respuesta||"danger",5),"success"==data.respuesta&&$scope.ticketActual.lstOrden&&$scope.ticketActual.lstOrden.length)for(var ixO=0;ixO<$scope.ticketActual.lstOrden.length;ixO++)$scope.ticketActual.lstOrden[ixO].limite=0,$scope.ticketActual.lstOrden[ixO].cantidadRestante=0})},$scope.reset=function(){$scope.seleccionMenu={si:!1,menu:"",imagen:null,count:{total:0,llevar:0,restaurante:0,domicilio:0}},$scope.seleccionTicket={si:!1,menu:"",imagen:null,numeroTicket:"",count:{total:0,llevar:0,restaurante:0,domicilio:0}},$scope.ixMenuFocus=-1,$scope.ixTicketFocus=-1},$scope.$watch("idDestinoMenu",function(_new){$scope.consultaOrden(),$scope.consultaOrdenTicket(!0)}),$scope.$watch("idEstadoOrden",function(_new){$scope.consultaOrden()}),$scope.$watch("numeroGrupo",function(_new){$scope.consultaOrden()}),$scope.$watch("tipoVista",function(_new){"menu"==_new?($timeout(function(){0<=$scope.ixMenuActual&&document.getElementById("input_"+$scope.ixMenuActual)&&document.getElementById("input_"+$scope.ixMenuActual).focus()}),$scope.keyPanel="left"):"ticket"==_new&&($scope.keyPanel="right")}),$scope.panel={array:"lstMenus",index:"ixMenuActual",seleccion:"seleccionMenu",focus:"ixMenuFocus"},$scope.$watch("keyPanel",function(_new){"left"==_new?($scope.panel.array="lstMenus",$scope.panel.index="ixMenuActual",$scope.panel.seleccion="seleccionMenu",$scope.panel.focus="ixMenuFocus"):"right"==_new&&($scope.panel.array="lstTickets",$scope.panel.index="ixTicketActual",$scope.panel.seleccion="seleccionTicket",$scope.panel.focus="ixTicketFocus")}),$scope.$watch("ixTicketActual",function(_new){$scope.ixTicketFocus=-1,$scope.scroll("ixt_",_new),$scope.ticketActual={},0<=_new&&($scope.ticketActual=$scope.lstTickets[_new],$scope.consultaDetalleOrden())}),$scope.$watch("ixMenuActual",function(_new){$scope.ixMenuFocus=-1,$scope.scroll("ixm_",_new),0<=_new&&document.getElementById("input_"+_new)&&document.getElementById("input_"+_new).focus()}),$scope.$watch("ixTicketFocus",function(_new){$scope.scroll("ixt_item_",_new)}),$scope.scroll=function(pref,index){if(0<=index){var position=0,id=index;$timeout(function(){"ixm_item_"!==pref&&"ixt_item_"!==pref||(id=$scope[$scope.panel.array][$scope[$scope.panel.index]].detalle[index].idDetalleOrdenMenu),0<index&&(position=$("#"+pref+id).position().top-19),"ixm_item_"===pref?$(".body_lst_menu").animate({scrollTop:position},100):"ixt_item_"===pref?$(".body_lst_ticket").animate({scrollTop:position},100):$(".contenido-lst-orden").animate({scrollTop:position},100)})}},$scope.cambioEstadoOrden=function(idEstadoOrden,tipo){if($scope.$parent.loading)return!1;$scope.permitirAccion()&&("ticket"===tipo?($scope.idEstadoOrdenTk=idEstadoOrden,$scope.consultaOrdenTicket()):$scope.idEstadoOrden=idEstadoOrden)},$scope.permitirAccion=function(noMostrarAlerta){var respuesta=!0;return($scope.seleccionCocina.si||$scope.seleccionTicket.si)&&(noMostrarAlerta||(alertify.set("notifier","position","top-right"),alertify.notify("Existen elementos seleccionados","info",2)),respuesta=!1),respuesta},$scope.cambiarVista=function(tipoVista){$scope.permitirAccion()&&($scope.tipoVista=tipoVista)},$scope.seleccionCocina={},$scope.cantidadCocinar=function(menu,_index){var todoRecorrido=!1,aSeleccionar=angular.copy(menu.seleccionados);$scope.seleccionCocina={si:!1,index:_index,idMenu:angular.copy(menu.idMenu),menu:angular.copy(menu.menu),imagen:angular.copy(menu.imagen),seleccionados:angular.copy(menu.seleccionados),lstOrden:[],observaciones:""};for(var ixO=0;ixO<menu.lstOrden.length;ixO++){var seleccionados=0;aSeleccionar>=menu.lstOrden[ixO].total&&!todoRecorrido?seleccionados=angular.copy(menu.lstOrden[ixO].total):!todoRecorrido||!aSeleccionar||0<menu.lstOrden[ixO].seleccionados?todoRecorrido||(menu.lstOrden[ixO].seleccionados=0):seleccionados=aSeleccionar,0<seleccionados&&($scope.seleccionCocina.si=!0,menu.lstOrden[ixO].observacion.length&&($scope.seleccionCocina.observaciones+=menu.lstOrden[ixO].observacion),$scope.seleccionCocina.lstOrden.push({idOrdenCliente:angular.copy(menu.lstOrden[ixO].idOrdenCliente),numeroTicket:angular.copy(menu.lstOrden[ixO].numeroTicket),seleccionados:seleccionados,total:angular.copy(menu.lstOrden[ixO].total),observacion:angular.copy(menu.lstOrden[ixO].observacion)}),menu.lstOrden[ixO].seleccionados=angular.copy(seleccionados),aSeleccionar-=seleccionados),ixO+1!==menu.lstOrden.length||todoRecorrido||(todoRecorrido=!0,0<aSeleccionar&&(ixO=-1))}},$scope.guardarEstadoDetalleOrden=function(){if($scope.$parent.loading)return!1;if($scope.seleccionCocina.si){var datos={opcion:"cambioEstadoCocina",idEstadoOrden:$scope.idEstadoOrden+1,lstOrdenes:$scope.seleccionCocina};$scope.$parent.loading=!0,$http.post("consultas.php",datos).success(function(data){$scope.$parent.loading=!1,alertify.notify(data.mensaje||data,data.respuesta||"danger",5),$scope.lastId="","success"==data.respuesta&&$scope.descontarOrden(!0,$scope.seleccionCocina.idMenu,$scope.seleccionCocina.lstOrden,data.myId)})}},$scope.myId="",$scope.descontarOrden=function(_current,_idMenu,_lstOrden,_myId){var _ixMenu=-1,ordenEncontrada=!1;if($scope.myId==_myId)return!1;if($scope.myId=_myId,-1==(_ixMenu=_current?$scope.seleccionCocina.index:$scope.indexArray("lstMenus","idMenu",_idMenu))||null==$scope.lstMenus[_ixMenu])return!1;for(var ixOr=0;ixOr<_lstOrden.length;ixOr++)for(var ixO=0;ixO<$scope.lstMenus[_ixMenu].lstOrden.length;ixO++){var actual=angular.copy($scope.lstMenus[_ixMenu].lstOrden[ixO]);if(_lstOrden[ixOr].idOrdenCliente==actual.idOrdenCliente&&0<_lstOrden[ixOr].seleccionados){ordenEncontrada=!0,$scope.lstMenus[_ixMenu].lstOrden[ixO].seleccionados=0,$scope.lstMenus[_ixMenu].lstOrden[ixO].total-=_lstOrden[ixOr].seleccionados,$scope.lstMenus[_ixMenu].total-=_lstOrden[ixOr].seleccionados,0==$scope.lstMenus[_ixMenu].lstOrden[ixO].total&&$scope.lstMenus[_ixMenu].lstOrden.splice(ixO,1);break}}ordenEncontrada&&($scope.seleccionCocina.si=!1,$scope.lstMenus[_ixMenu].seleccionados=""),0==$scope.lstMenus[_ixMenu].total&&($scope.lstMenus.splice(_ixMenu,1),$scope.seleccionCocina.idMenu==_idMenu&&($scope.seleccionCocina={}))},$scope.indexArray=function(arr,cmp,_value){for(var index=-1,i=0;i<$scope[arr].length;i++)if($scope[arr][i][cmp]==_value){index=i;break}return index},$scope.idEstadoOrdenTkt=0,$scope.focusElement=function(next){if($scope[$scope.panel.array][$scope[$scope.panel.index]]&&$scope[$scope.panel.array][$scope[$scope.panel.index]].detalle.length){var count=$scope[$scope.panel.array][$scope[$scope.panel.index]].detalle.length-1;next&&$scope[$scope.panel.focus]<count?$scope[$scope.panel.focus]++:!next&&0<$scope[$scope.panel.focus]&&$scope[$scope.panel.focus]--}},$scope._keyInicio=function(key,altDerecho){if(altDerecho&&85==key&&$scope.permitirAccion(!0))$scope.dialogoConsultaPersonal("mesero");else if(!altDerecho&&40==key&&$scope.permitirAccion(!0))$scope[$scope.panel.array].length&&-1==$scope[$scope.panel.index]?$scope[$scope.panel.index]=0:$scope[$scope.panel.index]+1<$scope[$scope.panel.array].length&&$scope[$scope.panel.index]++;else if(!altDerecho&&38==key&&$scope.permitirAccion(!0))-1!=$scope[$scope.panel.index]&&0<$scope[$scope.panel.index]?$scope[$scope.panel.index]--:-1==$scope[$scope.panel.index]&&($scope[$scope.panel.index]=$scope[$scope.panel.array].length-1);else if(!altDerecho&&32==key&&0<=$scope[$scope.panel.focus]){var item=$scope[$scope.panel.array][$scope[$scope.panel.index]].detalle[$scope[$scope.panel.focus]];"left"==$scope.keyPanel?$scope.selItemMenu(!item.selected,$scope[$scope.panel.focus]):"right"==$scope.keyPanel&&$scope.selItemTicket(!item.selected,$scope[$scope.panel.focus])}else 117==key?$scope.guardarEstadoDetalleOrden():altDerecho&&80==key?$scope.cambioEstadoOrden(1):altDerecho&&67==key?$scope.cambioEstadoOrden(2):altDerecho&&76==key?$scope.cambioEstadoOrden(3):altDerecho&&83==key?$scope.cambioEstadoOrden(4):altDerecho||75!=key?altDerecho||70!=key||$scope.cambioEstadoOrden(4,"ticket"):$scope.cambioEstadoOrden(1,"ticket")},$scope.nextElement=function(){document.getElementById("clave").focus()},$scope.indexArray=function(arr,cmp,_value){var index=-1,arreglo=[];arreglo=Array.isArray(arr)?angular.copy(arr):angular.copy($scope[arr]);for(var i=0;i<arreglo.length;i++)if(arreglo[i][cmp]==_value){index=i;break}return index},$scope.$on("keyPress",function(event,key,altDerecho,evento){if(32!=key&&38!=key&&40!=key||evento.preventDefault(),$scope.$parent.loading)return!1;$scope.modalOpen()?$scope.modalOpen("dial_orden_cliente"):altDerecho&&37==key&&$scope.permitirAccion(!0)?$scope.cambiarVista("menu"):altDerecho&&39==key&&$scope.permitirAccion(!0)?$scope.cambiarVista("ticket"):$scope._keyInicio(key,altDerecho)}),$scope.$on("infoNode",function(event,datos){switch(datos.accion){case"ordenNueva":case"ordenAgregar":for(var lstMO=angular.copy(datos.data.info.paraCocina),ixM=0;ixM<lstMO.length;ixM++)if($scope.idDestinoMenu==lstMO[ixM].idDestinoMenu&&$scope.idEstadoOrden==lstMO[ixM].idEstadoDetalleOrden){for(var ixMenu=$scope.indexArray("lstMenus","idMenu",lstMO[ixM].idMenu),orden=null,ixO=0;ixO<lstMO[ixM].lstOrden.length;ixO++){(actual=lstMO[ixM].lstOrden[ixO]).numeroGrupo!=$scope.numeroGrupo&&99!=$scope.numeroGrupo||(orden=angular.copy(actual))}if(-1==ixMenu&&null!=orden&&$scope.lstMenus.push(angular.copy(lstMO[ixM])),0<=ixMenu&&null!=orden){if(-1==(ixOrden=$scope.indexArray($scope.lstMenus[ixMenu].lstOrden,"idOrdenCliente",orden.idOrdenCliente)))$scope.lstMenus[ixMenu].lstOrden.push(angular.copy(orden)),$scope.lstMenus[ixMenu].total+=orden.total;else{var diferencia=parseInt(orden.total)-parseInt($scope.lstMenus[ixMenu].lstOrden[ixOrden].total);$scope.lstMenus[ixMenu].lstOrden[ixOrden]=angular.copy(orden),$scope.lstMenus[ixMenu].total+=diferencia}$scope.seleccionCocina.si&&$scope.seleccionCocina.idMenu==$scope.lstMenus[ixMenu].idMenu&&$scope.cantidadCocinar($scope.lstMenus[ixMenu],ixMenu)}}var ixTicket=$scope.indexArray("lstTickets","idOrdenCliente",datos.data.idOrdenCliente);orden=datos.data.info.paraTicket[0];0<=ixTicket?($scope.lstTickets[ixTicket]=orden,$scope.ticketActual.idOrdenCliente==datos.data.idOrdenCliente&&$scope.consultaDetalleOrden()):orden.numeroGrupo!=$scope.numeroGrupo&&99!=$scope.numeroGrupo||$scope.lstTickets.push(orden);break;case"ordenPrincipalCancelada":0<=(ixTicket=$scope.indexArray("lstTickets","idOrdenCliente",datos.idOrdenCliente))&&($scope.lstTickets.splice(ixTicket,1),ixTicket==$scope.ixTicketActual&&($scope.ixTicketActual=-1,$scope.ticketActual={}));for(ixMenu=0;ixMenu<$scope.lstMenus.length;ixMenu++){if(0<=(ixOrden=$scope.indexArray($scope.lstMenus[ixMenu].lstOrden,"idOrdenCliente",datos.idOrdenCliente))){var actual=angular.copy($scope.lstMenus[ixMenu].lstOrden[ixOrden]),eliminado=!1;$scope.lstMenus[ixMenu].total-=actual.total,$scope.lstMenus[ixMenu].lstOrden.splice(ixOrden,1),0==$scope.lstMenus[ixMenu].total&&($scope.lstMenus.splice(ixMenu,1),$scope.seleccionCocina={},eliminado=!0),$scope.seleccionCocina.si&&$scope.seleccionCocina.idMenu==$scope.lstMenus[ixMenu].idMenu&&$scope.cantidadCocinar($scope.lstMenus[ixMenu],ixMenu),eliminado&&ixMenu--}}break;case"cancelarOrdenParcial":for(lstMO=angular.copy(datos.data.info.paraCocina),ixMenu=0;ixMenu<$scope.lstMenus.length;ixMenu++){var ixOrden;if(0<=(ixOrden=$scope.indexArray($scope.lstMenus[ixMenu].lstOrden,"idOrdenCliente",datos.data.info.idOrdenCliente))){var restar=0;0<=(ixM=$scope.indexArray(lstMO,"idMenu",$scope.lstMenus[ixMenu].idMenu))?(restar=angular.copy($scope.lstMenus[ixMenu].lstOrden[ixOrden].total)-lstMO[ixM].total,$scope.lstMenus[ixMenu].lstOrden[ixOrden]=lstMO[ixM].lstOrden[0]):(restar=angular.copy($scope.lstMenus[ixMenu].lstOrden[ixOrden].total),$scope.lstMenus[ixMenu].lstOrden.splice(ixOrden,1)),$scope.lstMenus[ixMenu].total-=restar,$scope.seleccionCocina.idMenu==$scope.lstMenus[ixMenu].idMenu&&($scope.seleccionCocina.si&&0==$scope.lstMenus[ixMenu].total?$scope.seleccionCocina={}:$scope.cantidadCocinar($scope.lstMenus[ixMenu],ixMenu)),0==$scope.lstMenus[ixMenu].total&&($scope.lstMenus.splice(ixMenu,1),ixMenu=-1)}}ixTicket=$scope.indexArray("lstTickets","idOrdenCliente",datos.data.idOrdenCliente),orden=datos.data.info.paraTicket[0];0<=ixTicket&&(0==datos.data.info.paraTicket.length?($scope.ixTicketActual=-1,$scope.lstTickets.splice(ixTicket,1),$timeout(function(){$scope.lstTickets.length&&($scope.ixTicketActual=0)})):$scope.ticketActual.idOrdenCliente==datos.data.idOrdenCliente&&($scope.lstTickets[ixTicket]=orden,$scope.consultaDetalleOrden(!0)));break;case"cambioEstadoDetalleOrden":var estadoAnterior=datos.data.idEstadoOrden-1;$scope.idEstadoOrden==estadoAnterior&&$scope.descontarOrden(!1,datos.data.ordenCocina.idMenu,datos.data.ordenCocina.lstOrden,datos.data.myId);for(var i=0;i<datos.data.lstOrdenes.length;i++){var item=datos.data.lstOrdenes[i];if($scope.idEstadoOrden==estadoAnterior){var im=$scope.indexArray("lstMenus","idMenu",item.idMenu);if(0<=im){var id=$scope.indexArray($scope.lstMenus[im].detalle,"idDetalleOrdenMenu",item.idDetalleOrdenMenu);0<=id&&($scope.lstMenus[im].numMenus--,$scope.lstMenus[im].detalle.splice(id,1)),0==$scope.lstMenus[im].detalle.length&&($scope.ixMenuActual=-1,$scope.ixMenuFocus=-1,$scope.lstMenus.splice(im,1))}}var it=$scope.indexArray("lstTickets","numeroTicket",item.numeroTicket);if(0<=it){var index=$scope.indexArray($scope.lstTickets[it].detalle,"idDetalleOrdenMenu",item.idDetalleOrdenMenu);0<=index&&($scope.lstTickets[it].detalle[index].idEstadoDetalleOrden=datos.data.idEstadoOrden,$scope.lstTickets[it].detalle[index].selected=!1,1==estadoAnterior?($scope.lstTickets[it].total.pendientes--,$scope.lstTickets[it].total.cocinando++):2==estadoAnterior?($scope.lstTickets[it].total.cocinando--,$scope.lstTickets[it].total.listos++):3==estadoAnterior&&($scope.lstTickets[it].total.listos--,$scope.lstTickets[it].total.servidos++)),$scope.lstTickets[it].total.servidos==$scope.lstTickets[it].total.total&&1==$scope.idEstadoOrdenTk&&($scope.lstTickets.splice(it,1),$scope.ixTicketActual=-1),it==$scope.ixTicketActual&&($scope.ixMenuFocus=-1)}}break;case"cambioTipoServicio":0<=(ixTicket=$scope.indexArray("lstTickets","idOrdenCliente",datos.data.idOrdenCliente))&&$scope.ticketActual.idOrdenCliente==datos.data.idOrdenCliente&&$scope.consultaDetalleOrden()}$scope.$apply()}),$scope.modalOpen=function(_name){return null==_name?$("body>div").hasClass("modal")&&$("body>div").hasClass("top"):!(!$("#"+_name).data()||!$("#"+_name).data().$scope.$isShown)},$(function(){$(".contenido-lst-orden").attr("style","height:"+($(window).height()-125)+"px"),$(window).resize(function(){$(".contenido-lst-orden").attr("style","height:"+($(this).height()-125)+"px")})})}),app.controller("reporteCtrl",function($scope,$http,$filter){$scope.reporteMenu=1,$scope.fechaInicio=null,$scope.fechaFinal=null,$scope.fechaInicioC=null,$scope.fechaFinalC=null,$scope.fechaInicioOC=null,$scope.fechaFinalOC=null,$scope.fechaInicioD=null,$scope.fechaFinalD=null,$scope.fechaInicioCC=null,$scope.fechaFinalCC=null,$scope.ventas={},$scope.ordenesCanceladas={},$scope.cierreCaja={},$scope.descuentos={},$scope.filtro="combo",$scope.consultarOrdenesC=function(accion){if($scope.fechaInicioOC)if($scope.fechaFinalOC){var fechaInicio=$filter("date")($scope.fechaInicioOC,"yyyy-MM-dd"),fechaFinal=$filter("date")($scope.fechaFinalOC,"yyyy-MM-dd");"consultar"==accion?($scope.$parent.showLoading(),$http.post("consultas.php",{opcion:"getOrdenesCanceladas",fechaInicio:fechaInicio,fechaFinal:fechaFinal}).success(function(data){$scope.ordenesCanceladas=data||{},data.encontrado||alertify.notify("No se encontraron Resultados","warning"),$scope.$parent.hideLoading()}).error(function(data){$scope.$parent.hideLoading()})):"descargar"==accion&&window.open("reporte.ordCanceladas.php?fechaInicio="+fechaInicio+"&fechaFinal="+fechaFinal,"_blank")}else alertify.notify("Ingrese fecha Final","info",3);else alertify.notify("Ingrese fecha de Inicio","info",3)},$scope.consultarCierreCaja=function(accion){if($scope.fechaInicioCC)if($scope.fechaFinalCC){var fechaInicio=$filter("date")($scope.fechaInicioCC,"yyyy-MM-dd"),fechaFinal=$filter("date")($scope.fechaFinalCC,"yyyy-MM-dd");"consultar"==accion?($scope.$parent.showLoading(),$http.post("consultas.php",{opcion:"getCierreCaja",fechaInicio:fechaInicio,fechaFinal:fechaFinal}).success(function(data){$scope.cierreCaja=data||{},data.encontrado||alertify.notify("No se encontraron Resultados","warning"),$scope.$parent.hideLoading()}).error(function(data){$scope.$parent.hideLoading()})):"descargar"==accion&&window.open("reporte.cierre.php?fechaInicio="+fechaInicio+"&fechaFinal="+fechaFinal,"_blank")}else alertify.notify("Ingrese fecha Final","info",3);else alertify.notify("Ingrese fecha de Inicio","info",3)},$scope.consultarDescuentos=function(accion){if($scope.fechaInicioD)if($scope.fechaFinalD){var fechaInicio=$filter("date")($scope.fechaInicioD,"yyyy-MM-dd"),fechaFinal=$filter("date")($scope.fechaFinalD,"yyyy-MM-dd");"consultar"==accion?($scope.$parent.showLoading(),$http.post("consultas.php",{opcion:"getDescuentos",fechaInicio:fechaInicio,fechaFinal:fechaFinal}).success(function(data){$scope.descuentos=data||{},data.encontrado||alertify.notify("No se encontraron Resultados","warning"),$scope.$parent.hideLoading()}).error(function(data){$scope.$parent.hideLoading()})):"descargar"==accion&&window.open("reporte.descuentos.php?fechaInicio="+fechaInicio+"&fechaFinal="+fechaFinal,"_blank")}else alertify.notify("Ingrese fecha Final","info",3);else alertify.notify("Ingrese fecha de Inicio","info",3)},$scope.consultarVentas=function(accion){if($scope.fechaInicio)if($scope.fechaFinal){var fechaInicio=$filter("date")($scope.fechaInicio,"yyyy-MM-dd"),fechaFinal=$filter("date")($scope.fechaFinal,"yyyy-MM-dd");"consultar"==accion?($scope.$parent.showLoading(),$http.post("consultas.php",{opcion:"getVentasFecha",fechaInicio:fechaInicio,fechaFinal:fechaFinal}).success(function(data){$scope.ventas=data||{},data.encontrado||alertify.notify("No se encontraron Resultados","warning"),$scope.$parent.hideLoading()}).error(function(data){$scope.$parent.hideLoading()})):"descargar"==accion&&window.open("reporte.php?fechaInicio="+fechaInicio+"&fechaFinal="+fechaFinal+"&agruparVenta="+$scope.agruparVenta,"_blank")}else alertify.notify("Ingrese fecha Final","info",3);else alertify.notify("Ingrese fecha de Inicio","info",3)},$scope.compras={},$scope.consultarCompras=function(accion){if($scope.fechaInicioC)if($scope.fechaFinalC){var fechaInicio=$filter("date")($scope.fechaInicioC,"yyyy-MM-dd"),fechaFinal=$filter("date")($scope.fechaFinalC,"yyyy-MM-dd");"consultar"==accion?($scope.$parent.showLoading(),$http.post("consultas.php",{opcion:"getComprasFecha",fechaInicio:fechaInicio,fechaFinal:fechaFinal}).success(function(data){$scope.compras=data||{},data.encontrado||alertify.notify("No se encontraron Resultados","warning"),$scope.$parent.hideLoading()}).error(function(data){$scope.$parent.hideLoading()})):"descargar"==accion&&window.open("reporte.compras.php?fechaInicio="+fechaInicio+"&fechaFinal="+fechaFinal,"_blank")}else alertify.notify("Ingrese fecha Final","info",3);else alertify.notify("Ingrese fecha de Inicio","info",3)}}),app.controller("crtlMantenimiento",function($scope,$http,$modal,$timeout){$scope.menuTab="menu",$scope.lstDestinoMenu=[],$scope.lstTipoMenu=[],$scope.lstTipoServicio=[],$scope.lstEstadosMenu=[],$scope.lstCombos=[],$scope.lstMenu=[],$scope.menu={},$scope.combo={},$scope.resetValores=function(accion){$scope.accion,$scope.filter.busqueda="","menu"==accion?$scope.menu={idEstadoMenu:1,menu:"",idDestinoMenu:1,idTipoMenu:1,tiempoAlerta:0,descripcion:"",imagen:"",subirImagen:!0,tabMenu:"precios",lstPrecios:angular.copy($scope.lstTipoServicio),lstRecetaMenu:[]}:"combo"==accion?$scope.combo={idEstadoMenu:1,combo:"",descripcion:"",subirImagen:!0,imagen:"",tabMenu:"precios",lstPrecios:angular.copy($scope.lstTipoServicio),lstMenusCombo:[]}:"producto"==accion?($scope.lstBusqueda=[],$scope.prod={idMenu:null,idProducto:null,nombreProducto:"",medida:"",cantidad:null,observacion:"",seleccionado:!1},$timeout(function(){$("#producto").focus()},100)):"comboDetalle"==accion?($scope.menuD={idCombo:null,idMenu:null,menu:"",cantidad:null,seleccionado:!1},$timeout(function(){$("#menu").focus()},100)):"receta"==accion&&($scope.objMenu={},$scope.lstBusqueda=[],$scope.resetValores("producto"))},document.getElementById("dial.adminMenu.html")&&($scope.dialAdminMenu=$modal({scope:$scope,template:"dial.adminMenu.html",show:!1,backdrop:"static",keyboard:!1})),document.getElementById("dial.recetaMenu.html")&&($scope.dialRecetaMenu=$modal({scope:$scope,template:"dial.recetaMenu.html",show:!1,backdrop:"static",keyboard:!1})),document.getElementById("dial.adminCombo.html")&&($scope.dialAdminCombo=$modal({scope:$scope,template:"dial.adminCombo.html",show:!1,backdrop:"static",keyboard:!1})),document.getElementById("dial.detalleCombo.html")&&($scope.dialDetalleCombo=$modal({scope:$scope,template:"dial.detalleCombo.html",show:!1,backdrop:"static",keyboard:!1})),document.getElementById("dialAdmin.producto.html")&&($scope.dialAdministrar=$modal({scope:$scope,template:"dialAdmin.producto.html",show:!1,backdrop:"static"})),document.getElementById("dial.editarPrecios.html")&&($scope.dialEditarPrecios=$modal({scope:$scope,template:"dial.editarPrecios.html",show:!1,backdrop:"static",keyboard:!1})),document.getElementById("dial.editarPreciosC.html")&&($scope.dialEditarPreciosC=$modal({scope:$scope,template:"dial.editarPreciosC.html",show:!1,backdrop:"static",keyboard:!1})),$scope.$on("keyPress",function(event,key,altDerecho){if($scope.$parent.loading)return!1;117==key?$scope.modalOpen("dialAdminCombo")?$scope.consultaCombo():$scope.modalOpen("dialDetalleCombo")?$scope.actualizarLstDetalleCombo():$scope.modalOpen("dialRecetaMenu")?$scope.actualizarLstReceta():$scope.modalOpen("dialAdminMenu")?$scope.consultaMenu():$scope.modalOpen("dialEditarPrecios")?$scope.actualizarPrecios():$scope.modalOpen("dialEditarPreciosC")&&$scope.actualizarPreciosCombo():!altDerecho||65!=key&&69!=key||($scope.modalOpen()?alertify.notify("Acción no válida","info",3):"menu"==$scope.menuTab?65==key?$scope.agregarMenuCombo("menu"):69==key&&$scope.consultarMenusPrecios():"combo"==$scope.menuTab&&(65==key?$scope.agregarMenuCombo("combo"):69==key&&$scope.consultarComboPrecios()),$timeout(function(){$("#nit").focus()},175))}),$scope.modalOpen=function(_name){return null==_name?$("body>div").hasClass("modal")&&$("body>div").hasClass("top"):!(!$("#"+_name).data()||!$("#"+_name).data().$scope.$isShown)},$scope.$on("cargarLista",function(event,data){"menu"==data?$scope.verListaMenu():"combo"==data?$scope.verListaCombos():"superCombo"==data&&$scope.verListaSuperCombos()}),$scope.lstPorPagina=[{limite:"25"},{limite:"50"},{limite:"75"},{limite:"100"}],$scope.filter={pagina:1,limite:"25",orden:"ASC",busqueda:""},$scope.actualizarLstReceta=function(){var objMenu=$scope.objMenu;objMenu.lstRecetaMenu&&0<objMenu.lstRecetaMenu.length?$http.post("consultas.php",{opcion:"actualizarLstReceta",accion:"update",datos:objMenu.lstRecetaMenu}).success(function(data){alertify.set("notifier","position","top-right"),alertify.notify(data.mensaje,data.respuesta,data.tiempo),"success"==data.respuesta&&$scope.dialRecetaMenu.hide()}):alertify.notify("No hay productos ingresados en la lista de recetas","warning",5)},$scope.eliminarProdReceta=function(idMenu,idProducto){$http.post("consultas.php",{opcion:"consultaReceta",accion:"delete",datos:{idMenu:idMenu,idProducto:idProducto}}).success(function(data){alertify.set("notifier","position","top-right"),alertify.notify(data.mensaje,data.respuesta,data.tiempo),"success"==data.respuesta&&$scope.lstRecetaMenu($scope.objMenu.idMenu,!1)})},$scope.resetValores("comboDetalle"),$scope.buscarMenu=function(nombreMenu){nombreMenu.length&&!$scope.menuD.seleccionado?$http.post("consultas.php",{opcion:"buscarMenu",nombreMenu:nombreMenu}).success(function(data){$scope.lstBusqueda=data}):$scope.lstBusqueda=[]},$scope.agregarMenuDetalleCombo=function(){var menuD=$scope.menuD;menuD.idMenu?0<menuD.idMenu?menuD.cantidad&&0<menuD.cantidad?$http.post("consultas.php",{opcion:"consultaComboDetalle",accion:"insert",datos:$scope.menuD}).success(function(data){alertify.set("notifier","position","top-right"),alertify.notify(data.mensaje,data.respuesta,data.tiempo),"success"==data.respuesta&&($scope.resetValores("comboDetalle"),$scope.lstComboDetalle($scope.objCombo.idCombo,!1))}):alertify.notify("La cantidad ingresada debe ser mayor a 0","danger",5):alertify.notify("El código del Menu no es válido","danger",5):alertify.notify("Ingrese una cantidad entera","danger",5)},$scope.actualizarLstDetalleCombo=function(){var objCombo=$scope.objCombo;objCombo.lstDetalleCombo&&0<objCombo.lstDetalleCombo.length?$http.post("consultas.php",{opcion:"actualizarLstDetalleCombo",accion:"update",datos:objCombo.lstDetalleCombo}).success(function(data){alertify.set("notifier","position","top-right"),alertify.notify(data.mensaje,data.respuesta,data.tiempo),"success"==data.respuesta&&$scope.dialDetalleCombo.hide()}):alertify.notify("No hay productos ingresados en la lista de recetas","warning",5)},$scope.eliminarDetalleCombo=function(idCombo,idMenu){$http.post("consultas.php",{opcion:"consultaComboDetalle",accion:"delete",datos:{idCombo:idCombo,idMenu:idMenu}}).success(function(data){alertify.set("notifier","position","top-right"),alertify.notify(data.mensaje,data.respuesta,data.tiempo),"success"==data.respuesta&&$scope.lstComboDetalle($scope.objCombo.idCombo,!1)})},$scope.consultarMenusPrecios=function(){$http.post("consultas.php",{opcion:"consultarMenusPrecios"}).success(function(data){$scope.lstMenusPrecios=data||[],data.length&&$scope.dialEditarPrecios.show()})},$scope.consultarComboPrecios=function(){$http.post("consultas.php",{opcion:"consultarComboPrecios"}).success(function(data){$scope.lstCombosPrecios=data||[],data.length&&$scope.dialEditarPreciosC.show()})},$scope.objCombo={},$scope.cargarDetalleCombo=function(combo){$scope.objCombo=combo,0<$scope.objCombo.idCombo&&$scope.lstComboDetalle($scope.objCombo.idCombo,!0)},$scope.lstComboDetalle=function(idCombo,abrirModal){$http.post("consultas.php",{opcion:"lstComboDetalle",idCombo:idCombo}).success(function(data){$scope.objCombo.lstDetalleCombo=data,abrirModal&&$scope.dialDetalleCombo.show()})},$scope.cargarRecetaMenu=function(menu){$scope.objMenu=angular.copy(menu),0<$scope.objMenu.idMenu&&$scope.lstRecetaMenu($scope.objMenu.idMenu,!0)},$scope.lstRecetaMenu=function(idMenu,abrirModal){$http.post("consultas.php",{opcion:"lstRecetaMenu",idMenu:idMenu}).success(function(data){$scope.objMenu.lstRecetaMenu=data,abrirModal&&$scope.dialRecetaMenu.show()})},$scope.agregarIngresoProducto=function(){var prod=$scope.prod;prod.idProducto&&0<prod.idProducto?prod.cantidad&&0<prod.cantidad?$http.post("consultas.php",{opcion:"consultaReceta",accion:"insert",datos:$scope.prod}).success(function(data){alertify.set("notifier","position","top-right"),alertify.notify(data.mensaje,data.respuesta,data.tiempo),"success"==data.respuesta&&($scope.resetValores("producto"),$scope.lstRecetaMenu($scope.objMenu.idMenu,!1))}):alertify.notify("La cantidad ingresada debe ser mayor a 0","danger",5):alertify.notify("El código del Producto no es válido","danger",5)},$scope.idxElSeleccionado=-1,$scope.seleccionKeyElemento=function(key,elemento){13==key?$scope.lstBusqueda.length?1==$scope.lstBusqueda.length?$scope.seleccionarElemento($scope.lstBusqueda[0],elemento):-1!=$scope.idxElSeleccionado&&$scope.seleccionarElemento($scope.lstBusqueda[$scope.idxElSeleccionado],elemento):alertify.notify("No se encontraron resultados","info",5):38==key?$scope.lstBusqueda.length&&0<$scope.idxElSeleccionado?$scope.idxElSeleccionado--:0==$scope.idxElSeleccionado&&($scope.idxElSeleccionado=$scope.lstBusqueda.length-1):40==key&&($scope.lstBusqueda.length&&$scope.idxElSeleccionado+1<$scope.lstBusqueda.length?$scope.idxElSeleccionado++:$scope.lstBusqueda.length&&$scope.idxElSeleccionado+1&&($scope.idxElSeleccionado=0))},$scope.seleccionarElemento=function(valores,elemento){"producto"==elemento?valores.idProducto&&0<valores.idProducto?($scope.prod={idMenu:$scope.objMenu.idMenu,idProducto:valores.idProducto,producto:valores.producto,medida:valores.medida,tipoProducto:valores.tipoProducto,observacion:"",cantidad:null,seleccionado:!0},$("#cantidad").focus()):alertify.notify("El código del Producto no es válido","danger",5):"menu"==elemento&&(valores.idMenu&&0<valores.idMenu?($scope.menuD={idCombo:$scope.objCombo.idCombo,idMenu:valores.idMenu,menu:valores.menu,estadoMenu:valores.estadoMenu,cantidad:null,seleccionado:!0},$("#cantidad").focus()):alertify.notify("El código del Menu no es válido","danger",5)),$scope.lstBusqueda=[]},$scope.buscarProducto=function(nombreProducto){nombreProducto.length&&!$scope.prod.seleccionado?$http.post("consultas.php",{opcion:"buscarProducto",nombreProducto:nombreProducto}).success(function(data){$scope.lstBusqueda=data}):$scope.lstBusqueda=[]},$scope.realizarBusqueda=function(){"menu"==$scope.menuTab?$scope.verListaMenu():"combo"==$scope.menuTab&&$scope.verListaCombos()},$scope.cargarPaginacion=function(pagina){$scope.filter.pagina=pagina,"menu"==$scope.menuTab?$scope.verListaMenu():"combo"==$scope.menuTab?$scope.verListaCombos():"superCombo"==$scope.menuTab&&$scope.inventario()},($scope.inicio=function(){$http.post("consultas.php",{opcion:"inicioAdmin"}).success(function(data){$scope.lstDestinoMenu=data.lstDestinoMenu||[],$scope.lstTipoMenu=data.lsTipoMenu||[],$scope.lstTipoServicio=data.lstTiposServicio||[],$scope.lstEstadosMenu=data.lstEstadosMenu||[]})})(),$scope.cargarLstPreciosMenu=function(idMenu){$http.post("consultas.php",{opcion:"cargarLstPreciosMenu",idMenu:idMenu}).success(function(data){$scope.menu.lstPrecios=data})},$scope.cargarLstPreciosCombo=function(idCombo){$http.post("consultas.php",{opcion:"lstComboPrecio",idCombo:idCombo}).success(function(data){$scope.combo.lstPrecios=data})},$scope.lstPaginacion=[],$scope.generarPaginacion=function(totalPaginas){$scope.lstPaginacion=[];for(var i=1;i<=totalPaginas;i++)$scope.lstPaginacion.push({noPagina:i})},$scope.verListaMenu=function(){$http.post("consultas.php",{opcion:"getListaMenus",filtro:$scope.filter}).success(function(data){$scope.lstMenu=data.lstMenus||[],$scope.generarPaginacion(data.totalPaginas)})},$scope.verListaMenu(),$scope.verListaCombos=function(){$http.post("consultas.php",{opcion:"getListaCombos",filtro:$scope.filter}).success(function(data){$scope.lstCombos=data.lstCombos||[],$scope.generarPaginacion(data.totalPaginas)})},$scope.actualizarMenuCombo=function(tipo,data){$scope.accion="update","menu"==tipo?($scope.menu=angular.copy(data),$scope.menu.tabMenu="precios",$scope.cargarLstPreciosMenu($scope.menu.idMenu),$timeout(function(){$scope.dialAdminMenu.show()}),$timeout(function(){$("#nombreMenu").focus()},125)):"combo"==tipo&&($scope.combo=angular.copy(data),$scope.combo.tabMenu="precios",$scope.cargarLstPreciosCombo($scope.combo.idCombo),$timeout(function(){$scope.dialAdminCombo.show()}),$timeout(function(){$("#nombreCombo").focus()},125))},$scope.agregaReceta=function(){var prod=$scope.prod,encontrado=!1;if(prod.cantidad&&0<prod.cantidad){for(var i=0;i<$scope.menu.lstRecetaMenu.length;i++)if($scope.menu.lstRecetaMenu[i].idProducto==$scope.prod.idProducto){alertify.notify("El Producto ya se encuentra agregado","info",5),encontrado=!0;break}}else alertify.notify("La cantidad ingresada debe ser mayor a 0","danger",5);encontrado||($scope.menu.lstRecetaMenu.push($scope.prod),$scope.resetValores("producto"))},$scope.eliminarProductoReceta=function(index){$scope.menu.lstRecetaMenu.splice(index,1)},$scope.consultaMenu=function(){var menu=$scope.menu;"update"!=$scope.accion||menu.idMenu&&0<menu.idMenu?menu.idEstadoMenu&&0<menu.idEstadoMenu?menu.menu&&3<menu.menu.length?menu.codigo&&0<menu.codigo?menu.idDestinoMenu&&0<menu.idDestinoMenu?menu.idTipoMenu&&0<menu.idTipoMenu?menu.tiempoAlerta&&0<menu.tiempoAlerta?$scope.validarPreciosCM(menu,menu.menu)||$http.post("consultas.php",{opcion:"consultaMenu",accion:$scope.accion,datos:$scope.menu}).success(function(data){alertify.set("notifier","position","top-right"),alertify.notify(data.mensaje,data.respuesta,data.tiempo),"success"==data.respuesta&&($scope.menu={},$scope.dialAdminMenu.hide(),$scope.verListaMenu())}):alertify.notify("El tiempo límite debe ser mayor a 0","info",4):alertify.notify("Seleccione el tipo de Menú","info",3):alertify.notify("Seleccione el destino del Menú","info",4):alertify.notify("Ingrese el código del Menu","info",3):alertify.notify("El nombre del menú debe ser mayor a 3 caracteres","info",5):alertify.notify("Seleccione el estado del Menú","info",4):alertify.notify("No. de menú no válido","info",3)},$scope.actualizarPreciosCombo=function(){for(var error=!1,i=0;i<$scope.lstCombosPrecios.length;i++){var combo=$scope.lstCombosPrecios[i];if($scope.validarPreciosCM(combo,combo.combo)){error=!0;break}}error||$http.post("consultas.php",{opcion:"actualizarPreciosCombo",datos:$scope.lstCombosPrecios}).success(function(data){alertify.set("notifier","position","top-right"),alertify.notify(data.mensaje,data.respuesta,data.tiempo),0<data.data&&$scope.dialEditarPreciosC.hide()})},$scope.actualizarPrecios=function(){for(var error=!1,i=0;i<$scope.lstMenusPrecios.length;i++){var menuPrecio=$scope.lstMenusPrecios[i];if($scope.validarPreciosCM(menuPrecio,menuPrecio.menu)){error=!0;break}}error||$http.post("consultas.php",{opcion:"actualizarPrecios",datos:$scope.lstMenusPrecios}).success(function(data){alertify.set("notifier","position","top-right"),alertify.notify(data.mensaje,data.respuesta,data.tiempo),0<data.data&&$scope.dialEditarPrecios.hide()})},$scope.validarPreciosCM=function(menuCombo,descripcion){var error=!1;descripcion.length&&(descripcion=" <b>=> "+descripcion+"</b>");for(var i=0;i<menuCombo.lstPrecios.length;i++)if(!(menuCombo.lstPrecios[i].precio&&0<=menuCombo.lstPrecios[i].precio)){alertify.notify("Ingrese un precio válido en servicio "+menuCombo.lstPrecios[i].tipoServicio+descripcion,"warning",5),error=!0;break}return error},$scope.resetValores("receta"),$scope.agregarMenuCombo=function(tipo){$scope.accion="insert",$scope.resetValores(tipo),"menu"==tipo?($scope.resetValores("producto"),$scope.dialAdminMenu.show(),$timeout(function(){$("#nombreMenu").focus()},175)):"combo"==tipo&&($scope.resetValores("comboDetalle"),$scope.dialAdminCombo.show(),$timeout(function(){$("#nombreCombo").focus()},175))},$scope.agregarMenuC=function(){var menuD=$scope.menuD;menuD.idMenu?0<menuD.idMenu?menuD.cantidad&&0<menuD.cantidad?($scope.combo.lstMenusCombo.push($scope.menuD),$scope.resetValores("comboDetalle")):alertify.notify("La cantidad ingresada debe ser mayor a 0","danger",5):alertify.notify("El código del Menu no es válido","danger",5):alertify.notify("Ingrese una cantidad entera","danger",5)},$scope.eliminarMenuCombo=function(index){$scope.combo.lstMenusCombo.splice(index,1)},$scope.consultaCombo=function(){var combo=$scope.combo;"update"!=$scope.accion||combo.idCombo&&0<combo.idCombo?combo.idEstadoMenu&&0<combo.idEstadoMenu?combo.combo&&3<combo.combo.length?combo.codigo&&0<combo.codigo?$scope.validarPreciosCM(combo,combo.combo)||$http.post("consultas.php",{opcion:"consultaCombo",accion:$scope.accion,datos:$scope.combo}).success(function(data){alertify.set("notifier","position","top-right"),alertify.notify(data.mensaje,data.respuesta,data.tiempo),"success"==data.respuesta&&($scope.verListaCombos(),$scope.dialAdminCombo.hide(),combo.subirImagen&&$scope.$parent.asignarValorImagen(data.data,"combo"),$scope.resetValores("combo"))}):(!0,alertify.notify("Ingrese el código del combo","info",4)):(!0,alertify.notify("El nombre del combo debe ser mayor a 3 caracteres","info",5)):(!0,alertify.notify("Seleccione el estado del combo","info",4)):(!0,alertify.notify("No. de combo no válido, vuelve a seleccionarlo","info",4))},($scope.resetValoresProducto=function(accion){$scope.accionProducto="insert",$scope.buscarTipoProducto="",$scope.buscarMedida="",$scope.producto={producto:"",idUbicacion:1,idTipoProducto:null,idMedida:null,perecedero:!0,cantidadMinima:null,cantidadMaxima:null,disponibilidad:"",importante:!0}})(),($scope.cargarInicio=function(){$http.post("consultas.php",{opcion:"inicioInventario"}).success(function(data){$scope.lstMedidas=data.catMedidas||[],$scope.lstTipoProducto=data.catTipoProducto||[],$scope.lstUbicacion=data.catUbicacion||[]})})(),$scope.consultaProducto=function(){if($scope.$parent.loading)return!1;var producto=$scope.producto,accion=$scope.accionProducto;"update"!=accion||0<producto.idProducto?producto.producto&&3<=producto.producto.length?producto.idUbicacion&&0<producto.idUbicacion?producto.idTipoProducto&&0<producto.idTipoProducto?producto.idMedida&&0<producto.idMedida?producto.cantidadMinima&&0<producto.cantidadMinima?producto.cantidadMinima&&0<producto.cantidadMinima?producto.disponibilidad&&0<producto.disponibilidad?($scope.$parent.showLoading("Guardando..."),$http.post("consultas.php",{opcion:"consultaProducto",accion:accion,datos:$scope.producto}).success(function(data){console.log(data),alertify.set("notifier","position","top-right"),alertify.notify(data.mensaje,data.respuesta,data.tiempo),$scope.$parent.hideLoading(),"success"==data.respuesta&&($scope.dialAdministrar.hide(),$scope.dialRecetaMenu.show(),$scope.resetValoresProducto())})):alertify.notify("La disponibilidad debe ser mayor a 0","warning",5):alertify.notify("La cantidad máxima debe ser mayor a 0","warning",5):alertify.notify("La cantidad mínima debe ser mayor a 0","warning",5):alertify.notify("Seleccione la medida","warning",5):alertify.notify("Seleccione el tipo de producto","warning",5):alertify.notify("Seleccione la ubicacion del producto","warning",5):alertify.notify("El nombre del producto debe ser mayor a 3 caracteres","warning",5):alertify.notify("No. de producto no definido","warning",5)}}),app.controller("facturaCtrl",function($scope,$http,$modal,$timeout,$routeParams){$scope.accionCliente="ninguna",$scope.buscarTicket=null,$scope.idTab="",$scope.idEstadoOrden=1,$scope.lstFacturas=[],$scope.resetValores=function(accion){$scope.accion="insert","cliente"==accion?$scope.cliente={nit:null,nombre:"",cui:null,correo:"",telefono:null,direccion:"",idTipoCliente:1}:"lstClientes"==accion?$scope.lstClientes=[]:($scope.lstFacturas=[],$scope.facturacion={datosCliente:{nit:"",nombre:"",direccion:""},agrupado:!0,idEstadoFactura:1,idOrdenCliente:null,numeroTicket:null,noFactura:null,total:0,lstFormasPago:[],lstOrden:[]})},$scope.resetValores("facturacion"),$scope.resetValores("cliente"),$scope.$watch("buscarTicket",function(_new,_old){_old!=_new&&($scope.numeroTicket=null,$scope.facturacion.lstOrden=[])}),$scope.lstOrdenCliente=[],$scope.consultaOrdenCliente=function(){if($scope.$parent.loading)return!1;$scope.lstOrdenCliente=[],0<$scope.idEstadoOrden&&($scope.miIndex=-1,$scope.$parent.loading=!0,$http.post("consultas.php",{opcion:"lstOrdenCliente",idEstadoOrden:$scope.idEstadoOrden}).success(function(data){console.log(data),$scope.$parent.loading=!1,Array.isArray(data)&&($scope.lstOrdenCliente=data),$timeout(function(){$scope.lstOrdenCliente.length&&($scope.miIndex=0)})}))},$scope.seleccionarTicket=function(idOrdenCliente){if($scope.miIndex=-1,idOrdenCliente&&0<idOrdenCliente)for(var i=0;i<$scope.lstOrdenCliente.length;i++)if($scope.lstOrdenCliente[i].idOrdenCliente==idOrdenCliente){$scope.miIndex=i;break}},$scope.$watch("miIndex",function(_new){$scope.infoOrden={},0<=_new&&$scope.lstOrdenCliente[_new]&&$scope.consultaDetalleOrdenes($scope.lstOrdenCliente[_new])}),$scope.infoOrden={},$scope.deBusqueda=!1,$scope.lstEstados=[{abr:"P",title:"Pendiente",css:"default"},{abr:"C",title:"Cocinando",css:"info"},{abr:"L",title:"Listo",css:"primary"},{abr:"S",title:"Servido",css:"success"}],$scope.consultaDetalleOrdenes=function(orden,deBusqueda,force){return(!$scope.$parent.loading||void 0!==force)&&(void 0!==orden&&($scope.deBusqueda=null!=deBusqueda&&!($scope.idEstadoOrden=0),$scope.infoOrden=orden),0<$scope.infoOrden.idOrdenCliente&&($scope.$parent.loading=!0,void $http.post("consultas.php",{opcion:"lstDetalleOrdenCliente",idOrdenCliente:$scope.infoOrden.idOrdenCliente,todo:$scope.todoDetalle}).success(function(data){if($scope.$parent.loading=!1,data.lst){for(var ix=0;ix<data.lst.length;ix++){for(var lstEstados=[],im=0;im<data.lst[ix].lstMenus.length;im++){for(var menu=data.lst[ix].lstMenus[im],ixT=-1,idEstadoActual=parseInt(menu.perteneceCombo?menu.idEstadoDetalleOrdenCombo:menu.idEstadoDetalleOrden),ie=0;ie<lstEstados.length;ie++)if(idEstadoActual==lstEstados[ie].idEstado){ixT=ie;break}if(-1==ixT){var estado=$scope.lstEstados[idEstadoActual-1]||{};ixT=lstEstados.length,lstEstados.push({idEstado:idEstadoActual,abr:estado.abr,title:estado.title,css:estado.css,total:0})}lstEstados[ixT].total++}data.lst[ix].estados=lstEstados}$scope.infoOrden.lstOrden=data.lst,$scope.infoOrden.lstOtros=data.lstOtros,$scope.infoOrden.total=data.total}})))},($scope.catFormasPago=function(){$http.post("consultas.php",{opcion:"catFormasPago"}).success(function(data){$scope.lstFormasPago=data,$scope.facturacion.lstFormasPago=data,$scope.lstEstadosFactura.length||$scope.catEstadosFactura()})})(),$scope.editFactura={},$scope.editarFactura=function(factura,idEstadoFactura){$scope.editFactura=angular.copy(factura),$scope.editFactura.idEstadoNuevo=idEstadoFactura,$scope.dialMantenimientoF.hide(),$scope.dialEditarFactura.show()},$scope.actualizarEstadoFactura=function(){$scope.$parent.loading=!0,$http.post("consultas.php",{opcion:"consultaEstadoFacturaCli",datos:$scope.editFactura}).success(function(data){console.log(data),$scope.$parent.loading=!1,alertify.set("notifier","position","top-right"),alertify.notify(data.mensaje,data.respuesta,data.tiempo),"success"==data.respuesta&&($scope.cargarlstFacturasDia(),$scope.dialEditarFactura.hide())})},$scope.lstFacturasDia=[],$scope.lstFactPendientes=[],$scope.tabFactura=1,$scope.cargarlstFacturasDia=function(){$http.post("consultas.php",{opcion:"lstFacturas"}).success(function(data){$scope.lstFacturasDia=data.lstFacturas||[],$scope.lstFactPendientes=data.lstFactPendientes||[],$scope.lstFacturasDia.length||$scope.lstFactPendientes.length?$scope.dialMantenimientoF.show():alertify.notify("No hay facturas registradas el día de hoy","info",4)})},document.getElementById("dial.accionCliente.html")&&($scope.dialAccionCliente=$modal({scope:$scope,template:"dial.accionCliente.html",show:!1,backdrop:!1,keyboard:!0})),document.getElementById("dial.orden-busqueda.html")&&($scope.dialOrdenBusqueda=$modal({scope:$scope,template:"dial.orden-busqueda.html",show:!1,backdrop:!1,keyboard:!0})),document.getElementById("dial.mantenimientoFact.html")&&($scope.dialMantenimientoF=$modal({scope:$scope,template:"dial.mantenimientoFact.html",show:!1,backdrop:!1,keyboard:!0})),document.getElementById("dial.caja.html")&&($scope.dialCaja=$modal({scope:$scope,template:"dial.caja.html",show:!1,backdrop:!1,keyboard:!0})),document.getElementById("dial.editarFactura.html")&&($scope.dialEditarFactura=$modal({scope:$scope,template:"dial.editarFactura.html",show:!1,backdrop:!1,keyboard:!0})),document.getElementById("dial.ordenesPendientes.html")&&($scope.dialOrdenesPendientes=$modal({scope:$scope,template:"dial.ordenesPendientes.html",show:!1,backdrop:!1,keyboard:!0})),$scope.abrirOrdenesPendientes=function(){$scope.consultaOrdenCliente(),$scope.dialOrdenesPendientes.show()},$scope.seleccionarDeBusqueda=function(orden){$scope.miIndex=-1,$scope.dialOrdenBusqueda.hide(),$scope.facturacion.numeroTicket=angular.copy(parseInt(orden.numeroTicket)),$scope.facturacion.idOrdenCliente=angular.copy(parseInt(orden.idOrdenCliente)),$scope.consultaDetalleOrden(orden),$timeout(function(){$scope.modalInfo(orden,!0)})},$scope.infoOrden={},$scope.deBusqueda=!1,$scope.modalInfo=function(orden,deBusqueda){if($scope.$parent.loading)return!1;$scope.deBusqueda=null!=deBusqueda&&!($scope.idEstadoOrden=0),$scope.$parent.loading=!0,$scope.infoOrden=orden,$http.post("consultas.php",{opcion:"lstDetalleOrden",idOrdenCliente:orden.idOrdenCliente,todo:$scope.todoDetalle,agrupado:$scope.facturacion.agrupado}).success(function(data){console.log(data),$scope.$parent.loading=!1,data.length?$scope.facturacion.lstOrden=data:(alertify.set("notifier","position","top-right"),alertify.notify("No se encontraron ordenes con el No. de Ticket","info",7))})},$scope.$on("keyPress",function(event,key,altDerecho){if($scope.$parent.loading)return!1;var indexFactura;($scope.modalOpen("dial_accionCliente")&&117==key&&$scope.consultaCliente(),$scope.modalOpen("ordenesPendientes")?(altDerecho&&80==key&&($scope.idEstadoOrden=1),altDerecho&&76==key&&($scope.idEstadoOrden=3),altDerecho&&70==key&&($scope.idEstadoOrden=4)):$scope.modalOpen()||117!=key||$scope.facturarOrden(),altDerecho&&32==key&&$scope.lstFacturas.length&&$scope.agregarFactura({}),altDerecho&&39==key&&$scope.lstFacturas.length)&&(-1!==(indexFactura=$scope.indexArray("lstFacturas","idTab",$scope.idTab))&&void 0!==$scope.lstFacturas[indexFactura+1]&&($scope.idTab=$scope.lstFacturas[indexFactura+1].idTab));27==key&&$scope.lstFacturas.length&&(0<=(indexFactura=$scope.indexArray("lstFacturas","idTab",$scope.idTab))&&($scope.lstFacturas[indexFactura].ixDetalle=-1,$scope.lstFacturas[indexFactura].ixDesc=-1));(altDerecho&&80==key&&$scope.lstFacturas.length&&$scope.focusHtml("efectivo_"+$scope.idTab),altDerecho&&67==key&&$scope.lstFacturas.length&&$scope.focusHtml("searchPrincipal_"+$scope.idTab),altDerecho&&46==key&&$scope.lstFacturas.length&&$scope.quitarFactura($scope.idTab),altDerecho&&37==key&&$scope.lstFacturas.length)&&(0<(indexFactura=$scope.indexArray("lstFacturas","idTab",$scope.idTab))&&($scope.idTab=$scope.lstFacturas[indexFactura-1].idTab));altDerecho&&67==key&&""==$scope.accionCliente?$scope.buscarCliente("CF","cf"):altDerecho&&69==key?($scope.modalOpen()?alertify.notify("Acción no válida","info",3):1==$scope.facturacion.datosCliente.idCliente?alertify.notify("Acción no válida para el tipo de cliente","info",4):$scope.editarCliente($scope.facturacion.datosCliente,"mostrar"),$timeout(function(){$("#nit").focus()},175)):altDerecho&&65==key&&($scope.accionCliente="agregar",$scope.modalOpen()||$scope.dialAccionCliente.show(),$timeout(function(){$("#nit").focus()},175))}),$scope.lstDetalleTicket=[],$scope.$watch("accionCliente",function(){"agregar"==$scope.accionCliente&&($scope.resetValores("cliente"),$scope.accion="insert",$timeout(function(){$("#nit").focus()}))}),$scope.$watch("idEstadoOrden",function(){console.log("data"),$scope.todoDetalle=!1,$scope.consultaOrdenCliente()}),$scope.dividirOrden=function(){var agregados=0,ixIndividual=-1;if($scope.facturacion.lstOrdenRestantes.length){for(var ix=0;ix<$scope.facturacion.lstOrdenRestantes.length;ix++){var ordenRestante=angular.copy($scope.facturacion.lstOrdenRestantes[ix]);ordenRestante.cobrarTodo&&ordenRestante.cantidad&&(-1==ixIndividual&&($scope.facturacion.lstOrdenesInd.push({lstOrden:[]}),ixIndividual=$scope.facturacion.lstOrdenesInd.length-1),agregados++,$scope.facturacion.lstOrdenesInd[ixIndividual].lstOrden.push(ordenRestante),$scope.facturacion.lstOrdenRestantes[ix].cantidadRestante-=ordenRestante.cantidad,$scope.facturacion.lstOrdenRestantes[ix].cantidad=ordenRestante.cantidadRestante-ordenRestante.cantidad,0==$scope.facturacion.lstOrdenRestantes[ix].cantidadRestante&&$scope.facturacion.lstOrdenRestantes.splice(ix,1)),$scope.facturacion.lstOrdenRestantes.length||($scope.facturacion.ixSeleccionado=0)}agregados?alertify.notify("Orden Creada","success",3):alertify.notify("No selecciono el detalle para la orden Individual","warning",8)}else alertify.notify("No se encontrarón ordenes pendientes","info",5)},$scope.lstFacturas=[],$scope.lstDetalleOrden=[],$scope.consultaDetalleOrden=function(orden,deBusqueda){if($scope.$parent.loading)return!1;$scope.deBusqueda=null!=deBusqueda&&!($scope.idEstadoOrden=0),$scope.ordenesCliente=[],$scope.idTab="",$scope.$parent.loading=!0,$scope.infoOrden=orden,$http.post("consultas.php",{opcion:"detalleOrdenFactura",idOrdenCliente:orden.idOrdenCliente}).success(function(data){$scope.$parent.loading=!1,console.log(data),Array.isArray(data)&&($scope.agregarFactura({lstDetalle:data}),data.length&&($scope.idTab=1))})},$scope.agregarFactura=function(factura){return factura.idTab=1,factura.tab="Orden Principal",factura.principal=!0,$scope.lstFacturas.length?($scope.lstFacturas[0].numeroOrden++,factura.idTab=$scope.lstFacturas[0].numeroOrden,factura.tab="Orden #"+factura.idTab,factura.principal=!1):factura.numeroOrden=1,$scope.lstFacturas.push({numeroOrden:factura.numeroOrden,idTab:factura.idTab,facturado:!1,idFactura:null,idEstadoFactura:1,tab:factura.tab,principal:factura.principal,lstDetalle:factura.lstDetalle||[],cliente:{idCliente:factura.idCliente||"",nit:factura.nit||"",nombre:factura.nombre||"",direccion:factura.direccion||"",correo:factura.correo||"",cui:factura.cui||"",idTipoCliente:factura.idTipoCliente||""},detallePago:{totalPago:"",totalDescuento:"",total:"",cambio:"",efectivo:"",tarjeta:"",tipo:"d",descripcion:""}}),factura.idTab},$scope.focusDetalle=function(ixDetalle){var indexFactura=$scope.indexArray("lstFacturas","idTab",$scope.idTab);if(0<=indexFactura){$scope.lstFacturas[indexFactura].ixDetalle=ixDetalle;var cantidad=angular.copy($scope.lstFacturas[indexFactura].lstDetalle[ixDetalle].cantidad);$scope.lstFacturas[indexFactura].lstDetalle[ixDetalle].cantidadTrasladar=cantidad,$scope.focusHtml("fact_orden_"+ixDetalle)}},$scope.calculoFactura=function(tipoCalculo){var ixFactura=$scope.indexArray("lstFacturas","idTab",$scope.idTab);if(-1==ixFactura)return!1;switch(tipoCalculo){case"totalFactura":for(var totalDescuento=0,total=0,ixF=0;ixF<$scope.lstFacturas[ixFactura].lstDetalle.length;ixF++){var detalle=angular.copy($scope.lstFacturas[ixFactura].lstDetalle[ixF]);0<detalle.cantidad&&(0<detalle.descuento||(detalle.descuento=0),total+=detalle.cantidad*detalle.precio-detalle.descuento,totalDescuento+=detalle.descuento)}$scope.lstFacturas[ixFactura].detallePago.total=angular.copy(total),$scope.lstFacturas[ixFactura].detallePago.totalDescuento=angular.copy(totalDescuento);break;case"totalPago":var detallePago=angular.copy($scope.lstFacturas[ixFactura].detallePago);detallePago.tarjeta=$scope.convert(detallePago.tarjeta,"float",0),detallePago.efectivo=$scope.convert(detallePago.efectivo,"float",0),detallePago.total=$scope.convert(detallePago.total,"float",0);var totalPago=detallePago.tarjeta+detallePago.efectivo,cambio=0;totalPago>detallePago.total&&(cambio=totalPago-detallePago.total),$scope.lstFacturas[ixFactura].detallePago.cambio=cambio,$scope.lstFacturas[ixFactura].detallePago.totalPago=totalPago}return null},$scope.quitarFactura=function(idTab){var ixFactura=$scope.indexArray("lstFacturas","idTab",idTab);if($scope.lstFacturas[ixFactura].principal||$scope.lstFacturas[ixFactura].facturado)return!1;for(var ix=0;ix<$scope.lstFacturas[ixFactura].lstDetalle.length;ix++){var cantidad=angular.copy($scope.lstFacturas[ixFactura].lstDetalle[ix].cantidad);$scope.lstFacturas[ixFactura].lstDetalle[ix].cantidadTrasladar=cantidad,$scope.asignarDetalle(idTab,1,$scope.lstFacturas[ixFactura].lstDetalle[ix],ix),$scope.lstFacturas[ixFactura].lstDetalle.length&&ix--}for(ix=0;ix<$scope.lstFacturas.length;ix++)$scope.lstFacturas[ix].idTabDestino==idTab&&($scope.lstFacturas[ix].idTabDestino="");$scope.lstFacturas.splice(ixFactura,1),$scope.idTab="1",$scope.calculoFactura("totalFactura")},$scope.asignarDetalle=function(idTabActual,idTabDestino,orden,ixDetalle){var ixFacturaA=$scope.indexArray("lstFacturas","idTab",idTabActual);if(angular.copy($scope.lstFacturas[ixFacturaA]).facturado)alertify.notify("El detalle de la orden ya está facturado en la <b>ORDEN ACTUAL</b>","warning",6);else{if(null!=idTabDestino&&0<idTabDestino){var ixFacturaD=$scope.indexArray("lstFacturas","idTab",idTabDestino);if(angular.copy($scope.lstFacturas[ixFacturaD]).facturado)return void alertify.notify("El # de ORDEN ya se encuentra facturado, no es posible asignar el detalle de la orden","warning",8)}0<idTabDestino||(idTabDestino=$scope.agregarFactura({})),orden=angular.copy(orden);var ixFacturaActual=$scope.indexArray("lstFacturas","idTab",idTabActual),ixFacturaDestino=$scope.indexArray("lstFacturas","idTab",idTabDestino);if($scope.lstFacturas[ixFacturaActual].idTabDestino=idTabDestino.toString(),0<orden.cantidadTrasladar&&0<=ixFacturaDestino){for(var cantidadTrasladar,ixDetalleDestino=-1,ixD=0;ixD<$scope.lstFacturas[ixFacturaDestino].lstDetalle.length;ixD++){var actual=$scope.lstFacturas[ixFacturaDestino].lstDetalle[ixD];if(actual.idTipoServicio==orden.idTipoServicio&&actual.idMenu==orden.idMenu&&actual.idCombo==orden.idCombo){ixDetalleDestino=ixD;break}}(cantidadTrasladar=angular.copy(orden.cantidadTrasladar))==orden.pendiente?(orden.cantidadTrasladar="",-1==ixDetalleDestino&&$scope.lstFacturas[ixFacturaDestino].lstDetalle.push(orden),$scope.lstFacturas[ixFacturaActual].lstDetalle.splice(ixDetalle,1)):(-1==ixDetalleDestino&&(orden.cantidad=cantidadTrasladar,orden.pendiente=cantidadTrasladar,orden.cantidadTrasladar="",$scope.lstFacturas[ixFacturaDestino].lstDetalle.push(orden)),$scope.lstFacturas[ixFacturaActual].lstDetalle[ixDetalle].cantidadTrasladar="",$scope.lstFacturas[ixFacturaActual].lstDetalle[ixDetalle].cantidad-=cantidadTrasladar,$scope.lstFacturas[ixFacturaActual].lstDetalle[ixDetalle].pendiente-=cantidadTrasladar),0<=ixDetalleDestino&&($scope.lstFacturas[ixFacturaDestino].lstDetalle[ixDetalleDestino].cantidadTrasladar="",$scope.lstFacturas[ixFacturaDestino].lstDetalle[ixDetalleDestino].cantidad+=cantidadTrasladar,$scope.lstFacturas[ixFacturaDestino].lstDetalle[ixDetalleDestino].pendiente+=cantidadTrasladar)}$scope.focusHtml("fact_orden_"+ixDetalle),$scope.calculoFactura("totalFactura")}},$scope.facturarOrden=function(){var ixFactura=$scope.indexArray("lstFacturas","idTab",$scope.idTab);if(-1==ixFactura)return!1;var msgError="",factura=angular.copy($scope.lstFacturas[ixFactura]);if(factura.facturado?msgError="Orden ya facturada":factura.cliente.idCliente&&0<factura.cliente.idCliente?factura.detallePago.totalPago<factura.detallePago.total?msgError="El Pago TOTAL No puede ser menor a: Q. "+factura.detallePago.total:factura.detallePago.tarjeta>factura.detallePago.total?msgError="El monto de pago con TARJETA no debe ser mayor al TOTAL":0<factura.detallePago.total||(msgError="El monto total de la orden debe ser mayor a cero"):msgError="Cliente no definido para esta factura",""===msgError)for(var ix=0;ix<factura.lstDetalle.length&&(factura.lstDetalle[ix].descuento=$scope.convert(factura.lstDetalle[ix].descuento,"float",0),factura.lstDetalle[ix].conDescuento&&0==factura.lstDetalle[ix].descuento?msgError="Revise MONTO de Descuento de Detalle Orden: <b>#"+(ix+1)+"</b>":!factura.lstDetalle[ix].conDescuento||5<factura.lstDetalle[ix].justificacion.length||(msgError="Revise JUSTIFICACION de Descuento de Detalle Orden: <b>#"+(ix+1)+"</b>"),""===msgError);ix++);if(null!=msgError&&msgError.length)return alertify.notify(msgError,"warning",5),!1;$scope.facturacion.total=$scope.retornarTotalOrden(),$scope.$parent.showLoading("Guardando...");var winFactEvent=window.open("","_blank");winFactEvent.document.body.innerHTML="<h4>Espere, guardando...</h4>",window.focus(),$http.post("consultas.php",{opcion:"consultaFacturaCliente",accion:$scope.accion,data:factura}).success(function(data){console.log(data),alertify.set("notifier","position","top-right"),alertify.notify(data.mensaje,data.respuesta,data.tiempo),"success"==data.respuesta?($scope.lstFacturas[ixFactura].facturado=!0,$scope.lstFacturas[ixFactura].idFactura=data.data,winFactEvent.location="print.php?id="+data.data,winFactEvent.focus()):winFactEvent.close(),$scope.$parent.hideLoading()})},$scope.$watch("idTab",function(_new){0<_new&&$timeout(function(){document.getElementById("searchPrincipal_"+_new)&&document.getElementById("searchPrincipal_"+_new).focus(),$scope.calculoFactura("totalFactura")})}),$scope.lstTicketBusqueda=[],$scope.buscarOrdenTicket=function(idOrdenCliente){if($scope.$parent.loading)return!1;0<$scope.buscarTicket||idOrdenCliente&&0<idOrdenCliente?($scope.lstTicketBusqueda=[],$scope.$parent.loading=!0,$http.post("consultas.php",{opcion:"busquedaTicket",ticket:$scope.buscarTicket,idOrdenCliente:idOrdenCliente}).success(function(data){console.log(data),$scope.$parent.loading=!1,Array.isArray(data)&&data.length?1==data.length?($scope.lstTicketBusqueda=data,$scope.seleccionarDeBusqueda($scope.lstTicketBusqueda[0]),$scope.consultaDetalleOrden($scope.lstTicketBusqueda[0])):1<data.length&&($scope.lstTicketBusqueda=data,$scope.dialOrdenBusqueda.show()):(alertify.set("notifier","position","top-right"),alertify.notify("No se encontró Ordenes con este <b>No. de TICKET</b>","info"))})):alertify.notify("El No. de Ticket debe ser mayor a 0","info",3)},$scope.retornarTotalOrden=function(){var total=0;return"agrupado"==$scope.facturacion.tipoGrupo&&$scope.facturacion.lstOrden&&$scope.facturacion.lstOrden.length?total=$scope.obtenerTotalModel("lstOrden"):"individual"==$scope.facturacion.tipoGrupo&&(total="pendientes"==$scope.facturacion.ixSeleccionado?$scope.obtenerTotalModel("lstOrdenRestantes"):$scope.obtenerTotalModel("lstOrdenesInd",$scope.facturacion.ixSeleccionado)),total},$scope.obtenerTotalModel=function(modelo,ixSeleccionado){for(var total=0,i=0;i<$scope.facturacion[modelo].length;i++){var orden=$scope.facturacion[modelo][i];total+=orden.cantidad*orden.precio-orden.descuento}return total},$scope.consultaCliente=function(){var cliente=$scope.cliente;cliente.nombre&&3<=cliente.nombre.length?null!=cliente.cui&&1<=cliente.cui.length&&13!=cliente.cui.length?alertify.notify("El No. de CUI debe tener 13 dígitos","warning",3):$http.post("consultas.php",{opcion:"consultaCliente",accion:$scope.accion,cliente:$scope.cliente}).success(function(data){if(alertify.set("notifier","position","top-right"),alertify.notify(data.mensaje,data.respuesta,data.tiempo),"success"==data.respuesta){"insert"==$scope.accion&&($scope.cliente.idCliente=data.data);var cliente=angular.copy($scope.cliente),ixFacturaActual=$scope.indexArray("lstFacturas","idTab",$scope.idTab);$scope.lstFacturas[ixFacturaActual].cliente.idCliente=cliente.idCliente,$scope.lstFacturas[ixFacturaActual].cliente.nit=cliente.nit,$scope.lstFacturas[ixFacturaActual].cliente.nombre=cliente.nombre,$scope.lstFacturas[ixFacturaActual].cliente.direccion=cliente.direccion,$scope.lstFacturas[ixFacturaActual].cliente.idTipoCliente=cliente.idTipoCliente,$scope.resetValores("cliente"),$scope.dialAccionCliente.hide(),$scope.txtCliente="",$scope.focusHtml("efectivo_"+$scope.idTab)}}).error(function(error,status){$scope.data.error={message:error,status:status},console.log($scope.data.error.status)}):alertify.notify("El nombre debe tener más de 2 caracteres","warning",4)},$scope.seleccionarCliente=function(cliente){$scope.facturacion.datosCliente=angular.copy(cliente),$scope.dialAccionCliente.hide(),$scope.txtCliente="",$timeout(function(){$("#ticket").focus()},150)},$scope.editarCliente=function(cliente,accion){$scope.accionCliente="actualizar",$scope.accion="update",$scope.cliente=angular.copy(cliente),"mostrar"==accion&&$scope.dialAccionCliente.show()},$scope.lstClientes=[],$scope.txtCliente="",$scope.buscarCliente=function(valor,accion){0==valor.length&&($scope.accionCliente="ninguna",$scope.facturacion.datosCliente.nombre="",$scope.facturacion.datosCliente.direccion="",$scope.txtCliente="",$scope.lstClientes=[],accion=valor="cf",$timeout(function(){$("#buscador").focus()})),1<=valor.length?("principal"==accion&&($scope.accionCliente="ninguna"),$http.post("consultas.php",{opcion:"consultarCliente",valor:valor}).success(function(data){if(console.log(data),"principal"==accion&&0==data.lstResultados.length&&($scope.accionCliente="ninguna",$scope.txtCliente="",$scope.dialAccionCliente.show(),$scope.accionCliente="agregar",$timeout(function(){$("#nit").focus()})),"busqueda"==accion&&0==data.lstResultados.length)alertify.notify("No se encontraron resultados","info",3),$scope.lstClientes=[];else if("principal"!=accion&&"cf"!=accion||1!=data.lstResultados.length||!data.encontrado)"principal"!=accion&&"busqueda"!=accion||1!=data.lstResultados.length||data.encontrado?1<=data.lstResultados.length&&($scope.lstClientes=data.lstResultados,$scope.accionCliente="ninguna",$scope.dialAccionCliente.show()):($scope.dialAccionCliente.show(),$scope.accionCliente="agregar",$timeout(function(){$scope.cliente=data.lstResultados[0]}));else{var ixFacturaActual=$scope.indexArray("lstFacturas","idTab",$scope.idTab);$scope.lstFacturas[ixFacturaActual].cliente.idCliente=data.lstResultados[0].idCliente,$scope.lstFacturas[ixFacturaActual].cliente.nit=data.lstResultados[0].nit,$scope.lstFacturas[ixFacturaActual].cliente.nombre=data.lstResultados[0].nombre,$scope.lstFacturas[ixFacturaActual].cliente.correo=data.lstResultados[0].correo,$scope.lstFacturas[ixFacturaActual].cliente.cui=data.lstResultados[0].cui,$scope.lstFacturas[ixFacturaActual].cliente.telefono=data.lstResultados[0].telefono,$scope.lstFacturas[ixFacturaActual].cliente.direccion=data.lstResultados[0].direccion,$scope.lstFacturas[ixFacturaActual].cliente.idTipoCliente=data.lstResultados[0].idTipoCliente,$scope.txtCliente="","cf"==accion&&$scope.dialAccionCliente.hide(),"CF"==data.lstResultados[0].nit?$scope.focusHtml("nombreCliente_"+$scope.idTab,!0):$scope.focusHtml("efectivo_"+$scope.idTab)}})):alertify.notify("Ingrese un dato para consultar","info",3)},$routeParams.idOrdenCliente&&0<$routeParams.idOrdenCliente?($scope.$parent.loading=!1,$scope.buscarOrdenTicket($routeParams.idOrdenCliente),$timeout(function(){$("#searchPrincipal").focus()})):$timeout(function(){$("#ticket").focus()}),$scope.modalOpen=function(_name){return null==_name?$("body>div").hasClass("modal")&&$("body>div").hasClass("top"):!(!$("#"+_name).data()||!$("#"+_name).data().$scope.$isShown)},$scope.indexArray=function(arr,cmp,_value){var index=-1,arreglo=[];arreglo=Array.isArray(arr)?angular.copy(arr):angular.copy($scope[arr]);for(var i=0;i<arreglo.length;i++)if(arreglo[i][cmp]==_value){index=i;break}return index},$scope.focusHtml=function(element,select){$timeout(function(){document.getElementById(element)&&document.getElementById(element).focus(),select&&document.getElementById(element)&&document.getElementById(element).select()})},$scope.convert=function(valor,tipo,_default){return"float"==tipo&&(valor=null==valor||null==valor||""==valor?_default:parseFloat(valor)),valor}}),app.controller("ctrlCaja",function($scope,$http,$modal,$timeout,$filter){$scope.menuCaja="verCaja",$scope.accionCaja="",$scope.accion="insert",$scope.caja={cajero:"",cajaAtrasada:!1,usuario:"",codigoUsuario:null,idCaja:null,fechaApertura:angular.copy($scope.$parent.fechaActual),fechaHoraApertura:null,efectivoInicial:null,efectivoFinal:null,efectivoSobrante:null,efectivoFaltante:null},$scope.$watch("accionCaja",function(){"cierreCaja"==$scope.accionCaja&&$timeout(function(){$("#efectivoFinal").focus()},150)}),document.getElementById("dial.historialCaja.html")&&($scope.dialHistorialCaja=$modal({scope:$scope,template:"dial.historialCaja.html",show:!1,backdrop:"static",keyboard:!1})),$scope.abrirDialogoHistorial=function(){$scope.dialHistorialCaja.show()},$scope.fechaCaja=null,$scope.historialCaja={},$scope.cargarHistorialCaja=function(fechaCaja){if(fechaCaja){fechaCaja=$filter("date")(fechaCaja,"yyyy-MM-dd");$http.post("consultas.php",{opcion:"historialCaja",fechaCaja:fechaCaja}).success(function(data){console.log(data),$scope.historialCaja=data||{}})}},$scope.$on("keyPress",function(event,key,altDerecho){if($scope.$parent.loading)return!1;117==key&&("insert"==$scope.accion?"aperturarCaja"==$scope.accionCaja?$scope.consultaCaja():alertify.notify("Clic en <b>APERTURAR CAJA</b>","info",3):"cierre"==$scope.accion?"cierreCaja"==$scope.accionCaja?$scope.consultaCaja():alertify.notify("Clic en <b>CERRAR CAJA</b>","info",3):"cierre"!=$scope.accion&&"insert"!=$scope.accion&&alertify.notify("Acción no válida","info",3))}),($scope.inicioCaja=function(){$http.post("consultas.php",{opcion:"inicioCaja"}).success(function(data){$scope.caja=data,$scope.caja.fechaApertura=moment(data.fechaApertura),0<$scope.caja.idCaja?$scope.accion="cierre":($scope.accion="insert",$timeout(function(){$("#efectivoInicio").focus()},150))})})(),$scope.retornarTotal=function(){var total=0;if($scope.caja.lstDenominaciones)for(var i=0;i<$scope.caja.lstDenominaciones.length;i++)$scope.caja.lstDenominaciones[i].cantidad&&0<$scope.caja.lstDenominaciones[i].cantidad&&(total+=$scope.caja.lstDenominaciones[i].cantidad*$scope.caja.lstDenominaciones[i].denominacion);return total},$scope.consultaCaja=function(){var caja=$scope.caja;if("cierre"!=$scope.accion||caja.idCaja&&0<caja.idCaja)if("insert"!=$scope.accion||$scope.retornarTotal()&&0<$scope.retornarTotal())if("cierre"!=$scope.accion||$scope.retornarTotal()&&0<$scope.retornarTotal())if("cierre"==$scope.accion&&!caja.agregarFaltante&&0<caja.totalIngresos+caja.efectivoInicial-caja.totalEgresos-$scope.retornarTotal()){var faltante=parseFloat(caja.totalIngresos+caja.efectivoInicial-caja.totalEgresos-$scope.retornarTotal()).toFixed(2);$scope.caja.efectivoFaltante=parseFloat(faltante),alertify.notify("Existe un faltante de <h3><b>Q. "+parseFloat(faltante).toFixed(2)+"</b></h3>","warning",4)}else $scope.$parent.showLoading("Guardando..."),$http.post("consultas.php",{opcion:"consultaCaja",accion:$scope.accion,data:$scope.caja,total:$scope.retornarTotal()}).success(function(data){alertify.set("notifier","position","top-right"),alertify.notify(data.mensaje,data.respuesta,data.tiempo),"success"==data.respuesta&&($scope.accionCaja="",$scope.inicioCaja()),$scope.$parent.hideLoading()}).error(function(data){$scope.$parent.hideLoading()});else alertify.notify("El <b>EFECTIVO FINAL</b> debe ser mayor a 0","warning",4);else alertify.notify("El <b>EFECTIVO INICIAL</b> debe ser mayor a 0","warning",4);else alertify.notify("El Cierre de caja no es válido","danger",3)},$scope.movimiento={idTipoMovimiento:"3",motivo:"",monto:""},$scope.guardarMovimiento=function(){0<$scope.movimiento.idTipoMovimiento?0<$scope.movimiento.monto?3<$scope.movimiento.motivo.length?$http.post("consultas.php",{opcion:"guardarMovimientoCaja",movimiento:{accion:"insert",idTipoMovimiento:$scope.movimiento.idTipoMovimiento,motivo:$scope.movimiento.motivo,monto:$scope.movimiento.monto}}).success(function(data){alertify.notify(data.mensaje||data,data.respuesta||"danger",5),"success"==data.respuesta&&($scope.getMovimientos(),$scope.inicioCaja(),$scope.movimiento={idTipoMovimiento:"3",motivo:"",monto:""})}):alertify.notify("Motivo muy corto","warning",4):alertify.notify("Monto debe ser mayor a cero","warning",4):alertify.notify("Tipo Movimiento no definido","danger",3)},$scope.lstMovimientos=[],$scope.totalIngresos=0,$scope.totalEgresos=0,($scope.getMovimientos=function(){$scope.lstMovimientos=[],$scope.totalIngresos=0,$scope.totalEgresos=0,$http.post("consultas.php",{opcion:"lstMovimientos"}).success(function(data){$scope.lstMovimientos=data.lstMovimientos,$scope.totalIngresos=data.ingresos,$scope.totalEgresos=data.egresos})})()}),app.controller("crtlEvento",function($scope,$http,$timeout,$modal,$sce){$scope.idEstadoEvento=1,$scope.idTab=1,$scope.accionEvento="insert",$scope.accionMenu="",$scope.tipo="menu",$scope.lstEvento=[],$scope.lstMenu=[],$scope.lstResultado=[],$scope.lstMenuEvento=[],$scope.lstSalon=[],$scope.lstFormaPago=[],$scope.accionMenu="",$scope.busquedaCliente="",$scope.evento={},$scope.filtroFecha="",$scope.menu={id:0,cantidad:0,precioUnitario:0,otroMenu:"",idMenu:null,comentario:""},($scope.setEvento=function(){$scope.evento={idEvento:null,idEstadoEvento:null,evento:"",idCliente:"",nombreCliente:"",fechaEvento:null,horaInicio:null,horaFinal:null,anticipo:"",numeroPersonas:0,observacion:"",descuento:"",descripcionDescuento:"",costoExtra:"",descripcionCostoExtra:"",estadoEvento:"",lstMovimiento:[],idSalon:$scope.lstSalon.length&&$scope.lstSalon[0].idSalon}})(),($scope.init=function(){$http.post("consultas.php",{opcion:"iniEvento"}).success(function(data){console.log(data),data.lstSalon&&data.lstFormaPago&&($scope.lstSalon=data.lstSalon,$scope.lstFormaPago=data.lstFormaPago)})})(),document.getElementById("dl.evento.html")&&($scope.dialEvento=$modal({scope:$scope,template:"dl.evento.html",show:!1,backdrop:!1,keyboard:!1})),document.getElementById("facturar.evento.html")&&($scope.dialFactEvento=$modal({scope:$scope,template:"facturar.evento.html",show:!1,backdrop:!1,keyboard:!1})),$scope.showDialOrden=function(_accion,evento,_status){if($scope.accionEvento=_accion,$scope.accionMenu="","insert"==_accion)$scope.setEvento(),$timeout(function(){document.getElementById("busquedaCliente")&&document.getElementById("busquedaCliente").focus()});else if("update"==_accion){for(var _idEstadoEvento=_status||"",totalAnticipo=0,ix=0;ix<evento.lstMovimiento.length;ix++)totalAnticipo+=parseFloat(evento.lstMovimiento[ix].monto);$scope.evento={idEvento:evento.idEvento,evento:evento.evento,idCliente:evento.idCliente,nombreCliente:$sce.trustAsHtml("<b>"+evento.nombre+"</b> ("+evento.nit+") - "+evento.direccion),fechaEvento:moment(evento.fechaEvento),horaInicio:5==evento.horaInicio.length?evento.horaInicio:$scope.$parent.formatoFecha(evento.horaInicio,"HH:mm"),horaFinal:5==evento.horaFinal.length?evento.horaFinal:$scope.$parent.formatoFecha(evento.horaFinal,"HH:mm"),anticipo:evento.anticipo,numeroPersonas:evento.numeroPersonas,observacion:evento.observacion,idEstadoEvento:evento.idEstadoEvento,idSalon:evento.idSalon,newIdEstadoEvento:_idEstadoEvento,estadoEvento:evento.estadoEvento,lstMovimiento:evento.lstMovimiento,totalAnticipo:totalAnticipo},$scope.lstMenuEvento=evento.lstMenu,$scope.totalEvento()}$scope.dialEvento.show(),$timeout(function(){10==_status&&document.getElementById("comentario")&&document.getElementById("comentario").focus()})},$scope.showDialFactura=function(evento,_status){$scope.accionEvento="update";for(var totalAnticipo=0,ix=0;ix<evento.lstMovimiento.length;ix++)totalAnticipo+=parseFloat(evento.lstMovimiento[ix].monto);$scope.evento={idEvento:evento.idEvento,idFactura:evento.idFactura,evento:evento.evento,idCliente:evento.idCliente,nombreCliente:$sce.trustAsHtml("<b>"+evento.nombre+"</b> ("+evento.nit+") - "+evento.direccion),nombre:evento.nombre,nit:evento.nit,direccion:evento.direccion,fechaEvento:moment(evento.fechaEvento),horaInicio:$scope.$parent.formatoFecha(evento.horaInicio,"HH:mm"),horaFinal:$scope.$parent.formatoFecha(evento.horaFinal,"HH:mm"),anticipo:evento.anticipo,numeroPersonas:evento.numeroPersonas,observacion:evento.observacion,idEstadoEvento:evento.idEstadoEvento,idSalon:evento.idSalon,newIdEstadoEvento:_status,estadoEvento:evento.estadoEvento,lstMovimiento:evento.lstMovimiento,totalAnticipo:totalAnticipo,lstMenuEvento:evento.lstMenu,totalEvento:0,montoEfectivo:"",montoTarjeta:"",cambio:"",siDetalle:!0,descripcion:""},$scope.evento.totalEvento=$scope.totalEvento(evento.lstMenu),$scope.dialFactEvento.show()},$scope.consultarCliente=function(){3<$scope.busquedaCliente.length?($scope.lstResultado=[],$http.post("consultas.php",{opcion:"consultarCliente",valor:$scope.busquedaCliente}).success(function(data){if(Array.isArray(data.lstResultados)&&data.lstResultados.length){for(var ic=0;ic<data.lstResultados.length;ic++)0<data.lstResultados[ic].idCliente&&$scope.lstResultado.push({idCliente:data.lstResultados[ic].idCliente,cliente:$sce.trustAsHtml("<b>"+data.lstResultados[ic].nombre+"</b> ("+data.lstResultados[ic].nit+") » "+data.lstResultados[ic].direccion),active:!1});$scope.lstResultado&&$scope.lstResultado.length&&($scope.lstResultado[0].active=!0)}})):$scope.lstResultado=[]},$scope.seleccionarCliente=function(item){$scope.busquedaCliente="",$scope.evento.idCliente=item.idCliente,$scope.evento.nombreCliente=item.cliente,$scope.lstResultado=[],document.getElementById("evento").focus()},$scope.guardarEvento=function(){0<$scope.evento.idCliente?$scope.evento.evento.length<4?alertify.notify("La descripción del Evento es muy corto","danger",3):null==$scope.evento.fechaEvento||null==$scope.evento.fechaEvento?alertify.notify("La fecha del evento no es válido","danger",2):null==$scope.evento.horaInicio||null==$scope.evento.horaInicio?alertify.notify("La hora de Inicio no es válida","danger",2):null==$scope.evento.horaFinal||null==$scope.evento.horaFinal?alertify.notify("La hora Final no es válida","danger",2):10!=$scope.evento.newIdEstadoEvento||$scope.evento.comentario&&3<$scope.evento.comentario.length?($scope.evento.fechaEventoTxt=moment($scope.evento.fechaEvento).format("YYYY[-]MM[-]DD"),0<$scope.evento.newIdEstadoEvento&&($scope.evento.idEstadoEvento=$scope.evento.newIdEstadoEvento),$http.post("consultas.php",{opcion:"guardarEvento",accion:$scope.accionEvento,evento:$scope.evento}).success(function(data){alertify.notify(data.mensaje,data.respuesta,3),"success"==data.respuesta&&("insert"==$scope.accionEvento&&($scope.idTab=2,$scope.accionMenu="insert",$scope.evento.idEvento=data.idEvento,$scope.menu.cantidad=angular.copy($scope.evento.numeroPersonas)),$scope.consultaEvento(),0<$scope.evento.newIdEstadoEvento&&$scope.dialEvento.hide())})):alertify.notify("Comentario demasiado corto","danger",5):alertify.notify("Debe seleccionar un cliente","danger",2)},$scope.consultarMenu=function(){var datos=null;$scope.lstMenu=[],0<$scope.menu.id||($scope.menu.otroMenu="",$scope.menu.idMenu=""),"menu"==$scope.tipo&&(datos={opcion:"lstMenu",idTipoMenu:0,idEstadoMenu:1}),"combo"==$scope.tipo&&(datos={opcion:"lstCombo",idEstadoMenu:1}),null!=datos&&$http.post("consultas.php",datos).success(function(data){"menu"==$scope.tipo?$scope.lstMenu=$scope.arrayLst(data,"idMenu","menu"):"combo"==$scope.tipo&&($scope.lstMenu=$scope.arrayLst(data,"idCombo","combo")),$timeout(function(){null!=$scope.menu.idMenuCurrent&&0<$scope.menu.idMenuCurrent?$scope.menu.idMenu=$scope.menu.idMenuCurrent.toString():$scope.lstMenu.length&&($scope.menu.idMenu=$scope.lstMenu[0].idMenu)})})},$scope.menuAccion=function(_accion,_menu){if("insert"==($scope.accionMenu=_accion))$scope.menu.id=0,$scope.menu.precioUnitario=0,$scope.menu.cantidad=angular.copy($scope.evento.numeroPersonas),$scope.menu.otroMenu="",$scope.menu.comentario="";else if("update"==_accion||"delete"==_accion){var otroMenu="otroMenu"==_menu.idTipo||"otroServicio"==_menu.idTipo?_menu.menu:"";$scope.menu={id:_menu.id,cantidad:parseInt(_menu.cantidad),precioUnitario:parseFloat(_menu.precioUnitario),otroMenu:otroMenu,idMenu:_menu.idTipo!=$scope.tipo?"":_menu.idMenu,horaDespacho:_menu.horaDespacho,idMenuCurrent:_menu.idMenu,menu:_menu.menu,comentario:_menu.comentario},_menu.idTipo!=$scope.tipo&&($scope.tipo=_menu.idTipo)}else"insertMove"==_accion?$scope.movimiento={idFormaPago:"1",monto:"",motivo:""}:"deleteMove"==_accion&&($scope.movimiento=_menu)},$scope.guardarMenu=function(){if(0<$scope.menu.cantidad)if(0<$scope.menu.precioUnitario)if("otroMenu"!=$scope.tipo&&"otroServicio"!=$scope.tipo||3<$scope.menu.otroMenu.length){var datos={opcion:"guardarMenuEvento",menu:{accion:$scope.accionMenu,id:$scope.menu.id,idMenu:$scope.menu.idMenu,cantidad:$scope.menu.cantidad,horaDespacho:$scope.menu.horaDespacho,precioUnitario:$scope.menu.precioUnitario,comentario:$scope.menu.comentario,otroMenu:$scope.menu.otroMenu,tipo:$scope.tipo,idEvento:$scope.evento.idEvento}};$http.post("consultas.php",datos).success(function(data){alertify.notify(data.mensaje,data.respuesta,3),"success"==data.respuesta&&($scope.lstMenuEvento=data.lstMenuEvento,$scope.accionMenu="",$scope.menu.id=0,$scope.menu.precioUnitario=0,$scope.menu.comentario="",$scope.menu.otroMenu="",$scope.totalEvento(),$scope.consultaEvento())})}else alertify.notify("Error, menú no se encuentra especificado","danger",3);else alertify.notify("El precio debe ser mayor a cero","danger",3);else alertify.notify("La cantidad debe ser mayor a cero","danger",3)},$scope.facturarEvento=function(){var totalMonto=$scope.evento.montoEfectivo+$scope.evento.montoTarjeta,montoEvento=$scope.evento.totalEvento-$scope.evento.totalAnticipo;if(0<$scope.evento.idCliente)if(0<$scope.evento.idEvento)if(totalMonto<montoEvento)alertify.notify("El monto ingresado no puede cubrir el total del evento","danger",4);else{var winFactEvent=window.open("","_blank");winFactEvent.document.body.innerHTML="<h4>Espere, guardando...</h4>",window.focus();var datos={opcion:"facturarEvento",evento:{idEvento:$scope.evento.idEvento,totalEvento:$scope.evento.totalEvento,totalAnticipo:$scope.evento.totalAnticipo,montoEfectivo:$scope.evento.montoEfectivo,montoTarjeta:$scope.evento.montoTarjeta,cambio:$scope.evento.cambio,idCliente:$scope.evento.idCliente,siDetalle:$scope.evento.siDetalle,descripcion:$scope.evento.descripcion,nombre:$scope.evento.nombre,nit:$scope.evento.nit,direccion:$scope.evento.direccion}};$http.post("consultas.php",datos).success(function(data){console.log(data),alertify.notify(data.mensaje||data,data.respuesta||"danger",5),"success"==data.respuesta?(winFactEvent.location="print.php?id="+data.idFactura+"&isEvent=1",winFactEvent.focus(),$scope.consultaEvento(),$scope.dialFactEvento.hide()):winFactEvent.close()})}else alertify.notify("El id del evento no esta definido","danger",3);else alertify.notify("Cliente no esta definido","danger",2)},$scope.montoTotalEvento=0,$scope.totalEvento=function(lstMenus){var total=0;if(Array.isArray(lstMenus))for(var i=0;i<lstMenus.length;i++){var menu=lstMenus[i];total+=parseInt(menu.cantidad)*parseFloat(menu.precioUnitario)}else if($scope.lstMenuEvento)for(i=$scope.montoTotalEvento=0;i<$scope.lstMenuEvento.length;i++){menu=$scope.lstMenuEvento[i];$scope.montoTotalEvento+=parseInt(menu.cantidad)*parseFloat(menu.precioUnitario)}return total},$scope.montoCambioEvento=function(){var cambio=0,totalMonto=$scope.evento.montoEfectivo+$scope.evento.montoTarjeta,montoEvento=$scope.evento.totalEvento-$scope.evento.totalAnticipo;montoEvento<totalMonto&&(cambio=totalMonto-montoEvento),$scope.evento.cambio=cambio},$scope.guardarMovimiento=function(){if(console.log($scope.movimiento,$scope.accionMenu),0<$scope.movimiento.idFormaPago)if(0<$scope.movimiento.monto)if(0<$scope.movimiento.motivo.length){var datos={opcion:"guardarMovimiento",movimiento:{accion:$scope.accionMenu,idEvento:$scope.evento.idEvento,idFormaPago:$scope.movimiento.idFormaPago,monto:$scope.movimiento.monto,motivo:$scope.movimiento.motivo,idMovimiento:$scope.movimiento.idMovimiento}};$http.post("consultas.php",datos).success(function(data){console.log(data),alertify.notify(data.mensaje,data.respuesta,3),"success"==data.respuesta&&($scope.evento.lstMovimiento=data.lstMovimiento,$scope.accionMenu="",$scope.movimiento.monto="",$scope.movimiento.motivo="")})}else alertify.notify("Debe especificar la descripción","danger",3);else alertify.notify("El monto debe ser mayor a cero","danger",3);else alertify.notify("Debe seleccionar una forma de pago","danger",3)},$scope.newClient=function(){$scope.dialEvento.hide(),$timeout(function(){window.location.href="#/cliente"})},$scope.$watch("busquedaCliente",function(_new){$scope.consultarCliente()}),$scope.$watch("tipo",function(_new){_new.length&&($scope.consultarMenu(),$timeout(function(){"otroMenu"!=_new&&"otroServicio"!=_new||null==document.getElementById("inputMenu")?null!=document.getElementById("selectMenu")&&document.getElementById("selectMenu").focus():document.getElementById("inputMenu").focus()}))}),$scope.$watch("idEstadoEvento",function(_new){0<_new&&($scope.consultaEvento(),$scope.filtroFecha="")}),$scope.$watch("filtroFecha",function(_new){var fecha=moment($scope.filtroFecha).format("YYYY[-]MM[-]DD");10==fecha.length?($scope.idEstadoEvento="",$scope.consultaEvento(fecha)):$scope.idEstadoEvento=1,console.log(fecha)}),$scope.consultaEvento=function(fecha){if($scope.$parent.loading)return!1;$scope.$parent.loading=!0,$scope.lstEvento=[],$http.post("consultas.php",{opcion:"consultaEvento",idEstadoEvento:$scope.idEstadoEvento,fecha:fecha||""}).success(function(data){$scope.$parent.loading=!1,Array.isArray(data)&&($scope.lstEvento=data)})},$scope.$on("keyPress",function(event,key,altDerecho,evento){if($scope.modalOpen("dl_evento"))if(40!=key&&38!=key||!$scope.lstResultado.length||evento.preventDefault(),40==key&&$scope.lstResultado.length)-1==(ix=$scope.indexActual())?$scope.lstResultado[0].active=!0:ix+1<$scope.lstResultado.length&&($scope.lstResultado[ix].active=!1,$scope.lstResultado[ix+1].active=!0);else if(38==key&&$scope.lstResultado.length){-1==(ix=$scope.indexActual())?$scope.lstResultado[$scope.lstResultado.length-1].active=!0:0<ix&&($scope.lstResultado[ix].active=!1,$scope.lstResultado[ix-1].active=!0)}else if(13==key){var ix;0<=(ix=$scope.indexActual())&&$scope.seleccionarCliente($scope.lstResultado[ix])}}),$scope.indexActual=function(){for(var index=-1,iac=0;iac<$scope.lstResultado.length;iac++)$scope.lstResultado[iac].active&&-1==index?index=iac:$scope.lstResultado[iac].active=!1;return index},$scope.arrayLst=function(_array,id,descr){for(var array=[],ix=0;ix<_array.length;ix++)array.push({idMenu:_array[ix][id],menu:_array[ix][descr],imagen:_array[ix].imagen});return array},$scope.modalOpen=function(_name){return null==_name?$("body>div").hasClass("modal")&&$("body>div").hasClass("top"):!(!$("#"+_name).data()||!$("#"+_name).data().$scope.$isShown)}}),app.controller("ctrlTendencia",function($scope,$http,$timeout,$location,$filter){$scope.tipoMenu="menu",$scope.menuTen="fechaMenu",$scope.paraFecha=new Date,$scope.deFecha=new Date($scope.paraFecha.getFullYear(),$scope.paraFecha.getMonth(),1),$scope.lstMenu=[],$scope.lstCombo=[],$scope.todos="1",$scope.busqueda="",$scope.menu={idMenu:"",idCombo:"",descripcion:"",codigo:""},$http.post("consultas.php",{opcion:"lstMenu",idTipoMenu:0}).success(function(data){$scope.lstMenu=data}),$http.post("consultas.php",{opcion:"lstCombo"}).success(function(data){$scope.lstCombo=data}),$scope.sel=function(idMenu,idCombo,descripcion,codigo){$scope.menu={idMenu:angular.copy(idMenu),idCombo:angular.copy(idCombo),descripcion:angular.copy(descripcion),codigo:angular.copy(codigo)}},$scope.topFechaMenu=function(){if(!$scope.$parent.loading){var deFecha=$filter("date")($scope.deFecha,"yyyy-MM-dd"),paraFecha=$filter("date")($scope.paraFecha,"yyyy-MM-dd");10==deFecha.length&&10==paraFecha.length&&(0!=$scope.todos||0<$scope.menu.idMenu||0<$scope.menu.idCombo)&&($scope.$parent.loading=!0,$http.post("consultas.php",{opcion:"topFechaMenu",tipoMenu:$scope.tipoMenu,deFecha:deFecha,paraFecha:paraFecha,idMenu:$scope.menu.idMenu,idCombo:$scope.menu.idCombo}).success(function(data){$scope.$parent.loading=!1,$scope.renderChar(data.lstResultado),"success"!=data.respuesta&&alertify.notify(data.mensaje||data,data.respuesta||"danger",4)}))}},$scope.renderChar=function(lst){for(;null!=window.charFechaMenu.series[0];)window.charFechaMenu.series[0].remove();for(var ix=0;ix<lst.length;ix++)window.charFechaMenu.addSeries(lst[ix])},window.charFechaMenu=new Highcharts.chart("container",{chart:{type:"column"},title:{text:""},xAxis:{categories:[""],crosshair:!0},yAxis:{min:0,title:{text:"Cantidad"}},plotOptions:{column:{pointPadding:.2,borderWidth:0,dataLabels:{enabled:!0}}},series:[],credits:!1})}),function(window){"use strict";var keys_ENTER=13,keys_ESC=27,keys_F1=112,keys_F12=123,keys_LEFT=37,keys_RIGHT=39,defaults={autoReset:!0,basic:!1,closable:!0,closableByDimmer:!0,frameless:!1,maintainFocus:!0,maximizable:!0,modal:!0,movable:!0,moveBounded:!1,overflow:!0,padding:!0,pinnable:!0,pinned:!0,preventBodyShift:!1,resizable:!0,startMaximized:!1,transition:"pulse",notifier:{delay:5,position:"bottom-right",closeButton:!1},glossary:{title:"AlertifyJS",ok:"ACEPTAR",cancel:"CANCELAR",acccpt:"Accept",deny:"Deny",confirm:"CONFIRMAR",decline:"DECLINAR",close:"CERRAR",maximize:"MAXIMIZAR",restore:"RESTAURAR"},theme:{input:"ajs-input",ok:"btn btn-success",cancel:"btn btn-danger"}},openDialogs=[];function addClass(element,classNames){element.className+=" "+classNames}function removeClass(element,classNames){for(var original=element.className.split(" "),toBeRemoved=classNames.split(" "),x=0;x<toBeRemoved.length;x+=1){var index=original.indexOf(toBeRemoved[x]);-1<index&&original.splice(index,1)}element.className=original.join(" ")}function isRightToLeft(){return"rtl"===window.getComputedStyle(document.body).direction}function getScrollTop(){return document.documentElement&&document.documentElement.scrollTop||document.body.scrollTop}function getScrollLeft(){return document.documentElement&&document.documentElement.scrollLeft||document.body.scrollLeft}function clearContents(element){for(;element.lastChild;)element.removeChild(element.lastChild)}function copy(src){if(null===src)return src;var cpy;if(Array.isArray(src)){cpy=[];for(var x=0;x<src.length;x+=1)cpy.push(copy(src[x]));return cpy}if(src instanceof Date)return new Date(src.getTime());if(src instanceof RegExp)return(cpy=new RegExp(src.source)).global=src.global,cpy.ignoreCase=src.ignoreCase,cpy.multiline=src.multiline,cpy.lastIndex=src.lastIndex,cpy;if("object"!=typeof src)return src;for(var prop in cpy={},src)src.hasOwnProperty(prop)&&(cpy[prop]=copy(src[prop]));return cpy}function destruct(instance,initialize){var root=instance.elements.root;root.parentNode.removeChild(root),delete instance.elements,instance.settings=copy(instance.__settings),instance.__init=initialize,delete instance.__internal}var on=document.addEventListener?function(el,event,fn,useCapture){el.addEventListener(event,fn,!0===useCapture)}:document.attachEvent?function(el,event,fn){el.attachEvent("on"+event,fn)}:void 0,off=document.removeEventListener?function(el,event,fn,useCapture){el.removeEventListener(event,fn,!0===useCapture)}:document.detachEvent?function(el,event,fn){el.detachEvent("on"+event,fn)}:void 0,transition=function(){var t,type,supported=!1,transitions={animation:"animationend",OAnimation:"oAnimationEnd oanimationend",msAnimation:"MSAnimationEnd",MozAnimation:"animationend",WebkitAnimation:"webkitAnimationEnd"};for(t in transitions)if(void 0!==document.documentElement.style[t]){type=transitions[t],supported=!0;break}return{type:type,supported:supported}}();function delegate(context,method){return function(){if(0<arguments.length){for(var args=[],x=0;x<arguments.length;x+=1)args.push(arguments[x]);return args.push(context),method.apply(context,args)}return method.apply(context,[null,context])}}function createCloseEvent(index,button){return{index:index,button:button,cancel:!1}}function dispatchEvent(eventType,instance){if("function"==typeof instance.get(eventType))return instance.get(eventType).call(instance)}var dialog=function(){var scrollX,scrollY,usedKeys=[],reflow=null,isSafari=-1<window.navigator.userAgent.indexOf("Safari")&&window.navigator.userAgent.indexOf("Chrome")<0,templates_dimmer='<div class="ajs-dimmer"></div>',templates_modal='<div class="ajs-modal" tabindex="0"></div>',templates_dialog='<div class="ajs-dialog" tabindex="0"></div>',templates_reset='<button class="ajs-reset"></button>',templates_commands='<div class="ajs-commands"><button class="ajs-pin"></button><button class="ajs-maximize"></button><button class="ajs-close"></button></div>',templates_header='<div class="ajs-header"></div>',templates_body='<div class="ajs-body"></div>',templates_content='<div class="ajs-content"></div>',templates_footer='<div class="ajs-footer"></div>',templates_buttons={primary:'<div class="ajs-primary ajs-buttons"></div>',auxiliary:'<div class="ajs-auxiliary ajs-buttons"></div>'},templates_button='<button class="ajs-button"></button>',templates_resizeHandle='<div class="ajs-handle"></div>',classes={animationIn:"ajs-in",animationOut:"ajs-out",base:"alertify",basic:"ajs-basic",capture:"ajs-capture",closable:"ajs-closable",fixed:"ajs-fixed",frameless:"ajs-frameless",hidden:"ajs-hidden",maximize:"ajs-maximize",maximized:"ajs-maximized",maximizable:"ajs-maximizable",modeless:"ajs-modeless",movable:"ajs-movable",noSelection:"ajs-no-selection",noOverflow:"ajs-no-overflow",noPadding:"ajs-no-padding",pin:"ajs-pin",pinnable:"ajs-pinnable",prefix:"ajs-",resizable:"ajs-resizable",restore:"ajs-restore",shake:"ajs-shake",unpinned:"ajs-unpinned"};function initialize(instance){if(!instance.__internal){var setup;delete instance.__init,instance.__settings||(instance.__settings=copy(instance.settings)),null===reflow&&document.body.setAttribute("tabindex","0"),"function"==typeof instance.setup?((setup=instance.setup()).options=setup.options||{},setup.focus=setup.focus||{}):setup={buttons:[],focus:{element:null,select:!1},options:{}},"object"!=typeof instance.hooks&&(instance.hooks={});var buttonsDefinition=[];if(Array.isArray(setup.buttons))for(var b=0;b<setup.buttons.length;b+=1){var ref=setup.buttons[b],cpy={};for(var i in ref)ref.hasOwnProperty(i)&&(cpy[i]=ref[i]);buttonsDefinition.push(cpy)}var internal=instance.__internal={isOpen:!1,activeElement:document.body,timerIn:void 0,timerOut:void 0,buttons:buttonsDefinition,focus:setup.focus,options:{title:void 0,modal:void 0,basic:void 0,frameless:void 0,pinned:void 0,movable:void 0,moveBounded:void 0,resizable:void 0,autoReset:void 0,closable:void 0,closableByDimmer:void 0,maximizable:void 0,startMaximized:void 0,pinnable:void 0,transition:void 0,padding:void 0,overflow:void 0,onshow:void 0,onclosing:void 0,onclose:void 0,onfocus:void 0,onmove:void 0,onmoved:void 0,onresize:void 0,onresized:void 0,onmaximize:void 0,onmaximized:void 0,onrestore:void 0,onrestored:void 0},resetHandler:void 0,beginMoveHandler:void 0,beginResizeHandler:void 0,bringToFrontHandler:void 0,modalClickHandler:void 0,buttonsClickHandler:void 0,commandsClickHandler:void 0,transitionInHandler:void 0,transitionOutHandler:void 0,destroy:void 0},elements={};elements.root=document.createElement("div"),elements.root.className=classes.base+" "+classes.hidden+" ",elements.root.innerHTML=templates_dimmer+templates_modal,elements.dimmer=elements.root.firstChild,elements.modal=elements.root.lastChild,elements.modal.innerHTML=templates_dialog,elements.dialog=elements.modal.firstChild,elements.dialog.innerHTML=templates_reset+templates_commands+templates_header+templates_body+templates_footer+templates_resizeHandle+templates_reset,elements.reset=[],elements.reset.push(elements.dialog.firstChild),elements.reset.push(elements.dialog.lastChild),elements.commands={},elements.commands.container=elements.reset[0].nextSibling,elements.commands.pin=elements.commands.container.firstChild,elements.commands.maximize=elements.commands.pin.nextSibling,elements.commands.close=elements.commands.maximize.nextSibling,elements.header=elements.commands.container.nextSibling,elements.body=elements.header.nextSibling,elements.body.innerHTML=templates_content,elements.content=elements.body.firstChild,elements.footer=elements.body.nextSibling,elements.footer.innerHTML=templates_buttons.auxiliary+templates_buttons.primary,elements.resizeHandle=elements.footer.nextSibling,elements.buttons={},elements.buttons.auxiliary=elements.footer.firstChild,elements.buttons.primary=elements.buttons.auxiliary.nextSibling,elements.buttons.primary.innerHTML=templates_button,elements.buttonTemplate=elements.buttons.primary.firstChild,elements.buttons.primary.removeChild(elements.buttonTemplate);for(var x=0;x<instance.__internal.buttons.length;x+=1){var button=instance.__internal.buttons[x];for(var key in usedKeys.indexOf(button.key)<0&&usedKeys.push(button.key),button.element=elements.buttonTemplate.cloneNode(),button.element.innerHTML=button.text,"string"==typeof button.className&&""!==button.className&&addClass(button.element,button.className),button.attrs)"className"!==key&&button.attrs.hasOwnProperty(key)&&button.element.setAttribute(key,button.attrs[key]);"auxiliary"===button.scope?elements.buttons.auxiliary.appendChild(button.element):elements.buttons.primary.appendChild(button.element)}for(var opKey in instance.elements=elements,internal.resetHandler=delegate(instance,onReset),internal.beginMoveHandler=delegate(instance,beginMove),internal.beginResizeHandler=delegate(instance,beginResize),internal.bringToFrontHandler=delegate(instance,bringToFront),internal.modalClickHandler=delegate(instance,modalClickHandler),internal.buttonsClickHandler=delegate(instance,buttonsClickHandler),internal.commandsClickHandler=delegate(instance,commandsClickHandler),internal.transitionInHandler=delegate(instance,handleTransitionInEvent),internal.transitionOutHandler=delegate(instance,handleTransitionOutEvent),internal.options)void 0!==setup.options[opKey]?instance.set(opKey,setup.options[opKey]):alertify.defaults.hasOwnProperty(opKey)?instance.set(opKey,alertify.defaults[opKey]):"title"===opKey&&instance.set(opKey,alertify.defaults.glossary[opKey]);"function"==typeof instance.build&&instance.build()}document.body.appendChild(instance.elements.root)}function restoreScrollPosition(){window.scrollTo(scrollX,scrollY)}function ensureNoOverflow(){for(var requiresNoOverflow=0,x=0;x<openDialogs.length;x+=1){var instance=openDialogs[x];(instance.isModal()||instance.isMaximized())&&(requiresNoOverflow+=1)}0===requiresNoOverflow&&0<=document.body.className.indexOf(classes.noOverflow)?(removeClass(document.body,classes.noOverflow),preventBodyShift(!1)):0<requiresNoOverflow&&document.body.className.indexOf(classes.noOverflow)<0&&(preventBodyShift(!0),addClass(document.body,classes.noOverflow))}var top="",topScroll=0;function preventBodyShift(add){alertify.defaults.preventBodyShift&&document.documentElement.scrollHeight>document.documentElement.clientHeight&&(add?(topScroll=scrollY,top=window.getComputedStyle(document.body).top,addClass(document.body,classes.fixed),document.body.style.top=-scrollY+"px"):(scrollY=topScroll,document.body.style.top=top,removeClass(document.body,classes.fixed),restoreScrollPosition()))}function updateTransition(instance,value,oldValue){"string"==typeof oldValue&&removeClass(instance.elements.root,classes.prefix+oldValue),addClass(instance.elements.root,classes.prefix+value),reflow=instance.elements.root.offsetWidth}function bringToFront(event,instance){for(var x=openDialogs.indexOf(instance)+1;x<openDialogs.length;x+=1)if(openDialogs[x].isModal())return;return document.body.lastChild!==instance.elements.root&&(document.body.appendChild(instance.elements.root),openDialogs.splice(openDialogs.indexOf(instance),1),openDialogs.push(instance),setFocus(instance)),!1}function optionUpdated(instance,option,oldValue,newValue){switch(option){case"title":instance.setHeader(newValue);break;case"modal":!function(instance){instance.get("modal")?(removeClass(instance.elements.root,classes.modeless),instance.isOpen()&&(unbindModelessEvents(instance),updateAbsPositionFix(instance),ensureNoOverflow())):(addClass(instance.elements.root,classes.modeless),instance.isOpen()&&(bindModelessEvents(instance),updateAbsPositionFix(instance),ensureNoOverflow()))}(instance);break;case"basic":!function(instance){instance.get("basic")?addClass(instance.elements.root,classes.basic):removeClass(instance.elements.root,classes.basic)}(instance);break;case"frameless":!function(instance){instance.get("frameless")?addClass(instance.elements.root,classes.frameless):removeClass(instance.elements.root,classes.frameless)}(instance);break;case"pinned":!function(instance){instance.get("pinned")?(removeClass(instance.elements.root,classes.unpinned),instance.isOpen()&&removeAbsPositionFix(instance)):(addClass(instance.elements.root,classes.unpinned),instance.isOpen()&&!instance.isModal()&&addAbsPositionFix(instance))}(instance);break;case"closable":!function(instance){instance.get("closable")?(addClass(instance.elements.root,classes.closable),function(instance){on(instance.elements.modal,"click",instance.__internal.modalClickHandler)}(instance)):(removeClass(instance.elements.root,classes.closable),function(instance){off(instance.elements.modal,"click",instance.__internal.modalClickHandler)}(instance))}(instance);break;case"maximizable":!function(instance){instance.get("maximizable")?addClass(instance.elements.root,classes.maximizable):removeClass(instance.elements.root,classes.maximizable)}(instance);break;case"pinnable":!function(instance){instance.get("pinnable")?addClass(instance.elements.root,classes.pinnable):removeClass(instance.elements.root,classes.pinnable)}(instance);break;case"movable":!function(instance){instance.get("movable")?(addClass(instance.elements.root,classes.movable),instance.isOpen()&&bindMovableEvents(instance)):(resetMove(instance),removeClass(instance.elements.root,classes.movable),instance.isOpen()&&unbindMovableEvents(instance))}(instance);break;case"resizable":!function(instance){instance.get("resizable")?(addClass(instance.elements.root,classes.resizable),instance.isOpen()&&bindResizableEvents(instance)):(resetResize(instance),removeClass(instance.elements.root,classes.resizable),instance.isOpen()&&unbindResizableEvents(instance))}(instance);break;case"transition":updateTransition(instance,newValue,oldValue);break;case"padding":newValue?removeClass(instance.elements.root,classes.noPadding):instance.elements.root.className.indexOf(classes.noPadding)<0&&addClass(instance.elements.root,classes.noPadding);break;case"overflow":newValue?removeClass(instance.elements.root,classes.noOverflow):instance.elements.root.className.indexOf(classes.noOverflow)<0&&addClass(instance.elements.root,classes.noOverflow);break;case"transition":updateTransition(instance,newValue,oldValue)}"function"==typeof instance.hooks.onupdate&&instance.hooks.onupdate.call(instance,option,oldValue,newValue)}function update(instance,obj,callback,key,value){var old,result={op:void 0,items:[]};if(void 0===value&&"string"==typeof key)result.op="get",obj.hasOwnProperty(key)?(result.found=!0,result.value=obj[key]):(result.found=!1,result.value=void 0);else if(result.op="set","object"==typeof key){var args=key;for(var prop in args)obj.hasOwnProperty(prop)?(obj[prop]!==args[prop]&&(old=obj[prop],obj[prop]=args[prop],callback.call(instance,prop,old,args[prop])),result.items.push({key:prop,value:args[prop],found:!0})):result.items.push({key:prop,value:args[prop],found:!1})}else{if("string"!=typeof key)throw new Error("args must be a string or object");obj.hasOwnProperty(key)?(obj[key]!==value&&(old=obj[key],obj[key]=value,callback.call(instance,key,old,value)),result.items.push({key:key,value:value,found:!0})):result.items.push({key:key,value:value,found:!1})}return result}function triggerClose(instance){var found;triggerCallback(instance,function(button){return found=!0===button.invokeOnClose}),!found&&instance.isOpen()&&instance.close()}function commandsClickHandler(event,instance){switch(event.srcElement||event.target){case instance.elements.commands.pin:instance.isPinned()?unpin(instance):pin(instance);break;case instance.elements.commands.maximize:instance.isMaximized()?restore(instance):maximize(instance);break;case instance.elements.commands.close:triggerClose(instance)}return!1}function pin(instance){instance.set("pinned",!0)}function unpin(instance){instance.set("pinned",!1)}function maximize(instance){dispatchEvent("onmaximize",instance),addClass(instance.elements.root,classes.maximized),instance.isOpen()&&ensureNoOverflow(),dispatchEvent("onmaximized",instance)}function restore(instance){dispatchEvent("onrestore",instance),removeClass(instance.elements.root,classes.maximized),instance.isOpen()&&ensureNoOverflow(),dispatchEvent("onrestored",instance)}function addAbsPositionFix(instance){var scrollLeft=getScrollLeft();instance.elements.modal.style.marginTop=getScrollTop()+"px",instance.elements.modal.style.marginLeft=scrollLeft+"px",instance.elements.modal.style.marginRight=-scrollLeft+"px"}function removeAbsPositionFix(instance){var marginTop=parseInt(instance.elements.modal.style.marginTop,10),marginLeft=parseInt(instance.elements.modal.style.marginLeft,10);if(instance.elements.modal.style.marginTop="",instance.elements.modal.style.marginLeft="",instance.elements.modal.style.marginRight="",instance.isOpen()){var top=0,left=0;""!==instance.elements.dialog.style.top&&(top=parseInt(instance.elements.dialog.style.top,10)),instance.elements.dialog.style.top=top+(marginTop-getScrollTop())+"px",""!==instance.elements.dialog.style.left&&(left=parseInt(instance.elements.dialog.style.left,10)),instance.elements.dialog.style.left=left+(marginLeft-getScrollLeft())+"px"}}function updateAbsPositionFix(instance){instance.get("modal")||instance.get("pinned")?removeAbsPositionFix(instance):addAbsPositionFix(instance)}var cancelClick=!1;function modalClickHandler(event,instance){var target=event.srcElement||event.target;return cancelClick||target!==instance.elements.modal||!0!==instance.get("closableByDimmer")||triggerClose(instance),cancelClick=!1}var cancelKeyup=!1;function triggerCallback(instance,check){for(var idx=0;idx<instance.__internal.buttons.length;idx+=1){var button=instance.__internal.buttons[idx];if(!button.element.disabled&&check(button)){var closeEvent=createCloseEvent(idx,button);"function"==typeof instance.callback&&instance.callback.apply(instance,[closeEvent]),!1===closeEvent.cancel&&instance.close();break}}}function buttonsClickHandler(event,instance){var target=event.srcElement||event.target;triggerCallback(instance,function(button){return button.element===target&&(cancelKeyup=!0)})}function keyupHandler(event){if(!cancelKeyup){var instance=openDialogs[openDialogs.length-1],keyCode=event.keyCode;return 0===instance.__internal.buttons.length&&keyCode===keys_ESC&&!0===instance.get("closable")?(triggerClose(instance),!1):-1<usedKeys.indexOf(keyCode)?(triggerCallback(instance,function(button){return button.key===keyCode}),!1):void 0}cancelKeyup=!1}function keydownHandler(event){var instance=openDialogs[openDialogs.length-1],keyCode=event.keyCode;if(keyCode===keys_LEFT||keyCode===keys_RIGHT){for(var buttons=instance.__internal.buttons,x=0;x<buttons.length;x+=1)if(document.activeElement===buttons[x].element)switch(keyCode){case keys_LEFT:return void buttons[(x||buttons.length)-1].element.focus();case keys_RIGHT:return void buttons[(x+1)%buttons.length].element.focus()}}else if(keyCode<keys_F12+1&&keys_F1-1<keyCode&&-1<usedKeys.indexOf(keyCode))return event.preventDefault(),event.stopPropagation(),triggerCallback(instance,function(button){return button.key===keyCode}),!1}function setFocus(instance,resetTarget){if(resetTarget)resetTarget.focus();else{var focus=instance.__internal.focus,element=focus.element;switch(typeof focus.element){case"number":instance.__internal.buttons.length>focus.element&&(element=!0===instance.get("basic")?instance.elements.reset[0]:instance.__internal.buttons[focus.element].element);break;case"string":element=instance.elements.body.querySelector(focus.element);break;case"function":element=focus.element.call(instance)}null==element&&0===instance.__internal.buttons.length&&(element=instance.elements.reset[0]),element&&element.focus&&(element.focus(),focus.select&&element.select&&element.select())}}function onReset(event,instance){if(!instance)for(var x=openDialogs.length-1;-1<x;x-=1)if(openDialogs[x].isModal()){instance=openDialogs[x];break}if(instance&&instance.isModal()){var resetTarget,target=event.srcElement||event.target,lastResetElement=target===instance.elements.reset[1]||0===instance.__internal.buttons.length&&target===document.body;lastResetElement&&(instance.get("maximizable")?resetTarget=instance.elements.commands.maximize:instance.get("closable")&&(resetTarget=instance.elements.commands.close)),void 0===resetTarget&&("number"==typeof instance.__internal.focus.element?target===instance.elements.reset[0]?resetTarget=instance.elements.buttons.auxiliary.firstChild||instance.elements.buttons.primary.firstChild:lastResetElement&&(resetTarget=instance.elements.reset[0]):target===instance.elements.reset[0]&&(resetTarget=instance.elements.buttons.primary.lastChild||instance.elements.buttons.auxiliary.lastChild)),setFocus(instance,resetTarget)}}function handleTransitionInEvent(event,instance){clearTimeout(instance.__internal.timerIn),setFocus(instance),restoreScrollPosition(),cancelKeyup=!1,dispatchEvent("onfocus",instance),off(instance.elements.dialog,transition.type,instance.__internal.transitionInHandler),removeClass(instance.elements.root,classes.animationIn)}function handleTransitionOutEvent(event,instance){clearTimeout(instance.__internal.timerOut),off(instance.elements.dialog,transition.type,instance.__internal.transitionOutHandler),resetMove(instance),resetResize(instance),instance.isMaximized()&&!instance.get("startMaximized")&&restore(instance),alertify.defaults.maintainFocus&&instance.__internal.activeElement&&(instance.__internal.activeElement.focus(),instance.__internal.activeElement=null),"function"==typeof instance.__internal.destroy&&instance.__internal.destroy.apply(instance)}var movable=null,offsetX=0,offsetY=0,xProp="pageX",yProp="pageY",bounds=null,refreshTop=!1,moveDelegate=null;function moveElement(event,element){var left=event[xProp]-offsetX,top=event[yProp]-offsetY;refreshTop&&(top-=document.body.scrollTop),element.style.left=left+"px",element.style.top=top+"px"}function moveElementBounded(event,element){var left=event[xProp]-offsetX,top=event[yProp]-offsetY;refreshTop&&(top-=document.body.scrollTop),element.style.left=Math.min(bounds.maxLeft,Math.max(bounds.minLeft,left))+"px",element.style.top=refreshTop?Math.min(bounds.maxTop,Math.max(bounds.minTop,top))+"px":Math.max(bounds.minTop,top)+"px"}function beginMove(event,instance){if(null===resizable&&!instance.isMaximized()&&instance.get("movable")){var eventSrc,left=0,top=0;if("touchstart"===event.type?(event.preventDefault(),eventSrc=event.targetTouches[0],xProp="clientX",yProp="clientY"):0===event.button&&(eventSrc=event),eventSrc){var element=instance.elements.dialog;if(addClass(element,classes.capture),element.style.left&&(left=parseInt(element.style.left,10)),element.style.top&&(top=parseInt(element.style.top,10)),offsetX=eventSrc[xProp]-left,offsetY=eventSrc[yProp]-top,instance.isModal()?offsetY+=instance.elements.modal.scrollTop:instance.isPinned()&&(offsetY-=document.body.scrollTop),instance.get("moveBounded")){for(var current=element,offsetLeft=-left,offsetTop=-top;offsetLeft+=current.offsetLeft,offsetTop+=current.offsetTop,current=current.offsetParent;);bounds={maxLeft:offsetLeft,minLeft:-offsetLeft,maxTop:document.documentElement.clientHeight-element.clientHeight-offsetTop,minTop:-offsetTop},moveDelegate=moveElementBounded}else bounds=null,moveDelegate=moveElement;return dispatchEvent("onmove",instance),refreshTop=!instance.isModal()&&instance.isPinned(),movable=instance,moveDelegate(eventSrc,element),addClass(document.body,classes.noSelection),!1}}}function move(event){var eventSrc;movable&&("touchmove"===event.type?(event.preventDefault(),eventSrc=event.targetTouches[0]):0===event.button&&(eventSrc=event),eventSrc&&moveDelegate(eventSrc,movable.elements.dialog))}function endMove(){if(movable){var instance=movable;movable=bounds=null,removeClass(document.body,classes.noSelection),removeClass(instance.elements.dialog,classes.capture),dispatchEvent("onmoved",instance)}}function resetMove(instance){movable=null;var element=instance.elements.dialog;element.style.left=element.style.top=""}var resizable=null,startingLeft=Number.Nan,startingWidth=0,minWidth=0,handleOffset=0;function beginResize(event,instance){var eventSrc;if(!instance.isMaximized()&&("touchstart"===event.type?(event.preventDefault(),eventSrc=event.targetTouches[0]):0===event.button&&(eventSrc=event),eventSrc)){dispatchEvent("onresize",instance),handleOffset=(resizable=instance).elements.resizeHandle.offsetHeight/2;var element=instance.elements.dialog;return addClass(element,classes.capture),startingLeft=parseInt(element.style.left,10),element.style.height=element.offsetHeight+"px",element.style.minHeight=instance.elements.header.offsetHeight+instance.elements.footer.offsetHeight+"px",element.style.width=(startingWidth=element.offsetWidth)+"px","none"!==element.style.maxWidth&&(element.style.minWidth=(minWidth=element.offsetWidth)+"px"),element.style.maxWidth="none",addClass(document.body,classes.noSelection),!1}}function resize(event){var eventSrc;resizable&&("touchmove"===event.type?(event.preventDefault(),eventSrc=event.targetTouches[0]):0===event.button&&(eventSrc=event),eventSrc&&function(event,element,pageRelative){for(var X,Y,current=element,offsetLeft=0,offsetTop=0;offsetLeft+=current.offsetLeft,offsetTop+=current.offsetTop,current=current.offsetParent;);Y=!0===pageRelative?(X=event.pageX,event.pageY):(X=event.clientX,event.clientY);var isRTL=isRightToLeft();if(isRTL&&(X=document.body.offsetWidth-X,isNaN(startingLeft)||(offsetLeft=document.body.offsetWidth-offsetLeft-element.offsetWidth)),element.style.height=Y-offsetTop+handleOffset+"px",element.style.width=X-offsetLeft+handleOffset+"px",!isNaN(startingLeft)){var diff=.5*Math.abs(element.offsetWidth-startingWidth);isRTL&&(diff*=-1),element.offsetWidth>startingWidth?element.style.left=startingLeft+diff+"px":element.offsetWidth>=minWidth&&(element.style.left=startingLeft-diff+"px")}}(eventSrc,resizable.elements.dialog,!resizable.get("modal")&&!resizable.get("pinned")))}function endResize(){if(resizable){var instance=resizable;resizable=null,removeClass(document.body,classes.noSelection),removeClass(instance.elements.dialog,classes.capture),cancelClick=!0,dispatchEvent("onresized",instance)}}function resetResize(instance){resizable=null;var element=instance.elements.dialog;"none"===element.style.maxWidth&&(element.style.maxWidth=element.style.minWidth=element.style.width=element.style.height=element.style.minHeight=element.style.left="",startingLeft=Number.Nan,startingWidth=minWidth=handleOffset=0)}function windowResize(){for(var x=0;x<openDialogs.length;x+=1){var instance=openDialogs[x];instance.get("autoReset")&&(resetMove(instance),resetResize(instance))}}function bindModelessEvents(instance){on(instance.elements.dialog,"focus",instance.__internal.bringToFrontHandler,!0)}function unbindModelessEvents(instance){off(instance.elements.dialog,"focus",instance.__internal.bringToFrontHandler,!0)}function bindMovableEvents(instance){on(instance.elements.header,"mousedown",instance.__internal.beginMoveHandler),on(instance.elements.header,"touchstart",instance.__internal.beginMoveHandler)}function unbindMovableEvents(instance){off(instance.elements.header,"mousedown",instance.__internal.beginMoveHandler),off(instance.elements.header,"touchstart",instance.__internal.beginMoveHandler)}function bindResizableEvents(instance){on(instance.elements.resizeHandle,"mousedown",instance.__internal.beginResizeHandler),on(instance.elements.resizeHandle,"touchstart",instance.__internal.beginResizeHandler)}function unbindResizableEvents(instance){off(instance.elements.resizeHandle,"mousedown",instance.__internal.beginResizeHandler),off(instance.elements.resizeHandle,"touchstart",instance.__internal.beginResizeHandler)}return{__init:initialize,isOpen:function(){return this.__internal.isOpen},isModal:function(){return this.elements.root.className.indexOf(classes.modeless)<0},isMaximized:function(){return-1<this.elements.root.className.indexOf(classes.maximized)},isPinned:function(){return this.elements.root.className.indexOf(classes.unpinned)<0},maximize:function(){return this.isMaximized()||maximize(this),this},restore:function(){return this.isMaximized()&&restore(this),this},pin:function(){return this.isPinned()||pin(this),this},unpin:function(){return this.isPinned()&&unpin(this),this},bringToFront:function(){return bringToFront(0,this),this},moveTo:function(x,y){if(!isNaN(x)&&!isNaN(y)){dispatchEvent("onmove",this);var element=this.elements.dialog,current=element,offsetLeft=0,offsetTop=0;for(element.style.left&&(offsetLeft-=parseInt(element.style.left,10)),element.style.top&&(offsetTop-=parseInt(element.style.top,10));offsetLeft+=current.offsetLeft,offsetTop+=current.offsetTop,current=current.offsetParent;);var left=x-offsetLeft,top=y-offsetTop;isRightToLeft()&&(left*=-1),element.style.left=left+"px",element.style.top=top+"px",dispatchEvent("onmoved",this)}return this},resizeTo:function(width,height){var w=parseFloat(width),h=parseFloat(height),regex=/(\d*\.\d+|\d+)%/;if(!isNaN(w)&&!isNaN(h)&&!0===this.get("resizable")){dispatchEvent("onresize",this),(""+width).match(regex)&&(w=w/100*document.documentElement.clientWidth),(""+height).match(regex)&&(h=h/100*document.documentElement.clientHeight);var element=this.elements.dialog;"none"!==element.style.maxWidth&&(element.style.minWidth=(minWidth=element.offsetWidth)+"px"),element.style.maxWidth="none",element.style.minHeight=this.elements.header.offsetHeight+this.elements.footer.offsetHeight+"px",element.style.width=w+"px",element.style.height=h+"px",dispatchEvent("onresized",this)}return this},setting:function(key,value){var self=this,result=update(this,this.__internal.options,function(k,o,n){optionUpdated(self,k,o,n)},key,value);if("get"===result.op)return result.found?result.value:void 0!==this.settings?update(this,this.settings,this.settingUpdated||function(){},key,value).value:void 0;if("set"===result.op){if(0<result.items.length)for(var callback=this.settingUpdated||function(){},x=0;x<result.items.length;x+=1){var item=result.items[x];item.found||void 0===this.settings||update(this,this.settings,callback,item.key,item.value)}return this}},set:function(key,value){return this.setting(key,value),this},get:function(key){return this.setting(key)},setHeader:function(content){return"string"==typeof content?(clearContents(this.elements.header),this.elements.header.innerHTML=content):content instanceof window.HTMLElement&&this.elements.header.firstChild!==content&&(clearContents(this.elements.header),this.elements.header.appendChild(content)),this},setContent:function(content){return"string"==typeof content?(clearContents(this.elements.content),this.elements.content.innerHTML=content):content instanceof window.HTMLElement&&this.elements.content.firstChild!==content&&(clearContents(this.elements.content),this.elements.content.appendChild(content)),this},showModal:function(className){return this.show(!0,className)},show:function(modal,className){if(initialize(this),this.__internal.isOpen){resetMove(this),resetResize(this),addClass(this.elements.dialog,classes.shake);var self=this;setTimeout(function(){removeClass(self.elements.dialog,classes.shake)},200)}else{if(this.__internal.isOpen=!0,openDialogs.push(this),alertify.defaults.maintainFocus&&(this.__internal.activeElement=document.activeElement),"function"==typeof this.prepare&&this.prepare(),instance=this,1===openDialogs.length&&(on(window,"resize",windowResize),on(document.body,"keyup",keyupHandler),on(document.body,"keydown",keydownHandler),on(document.body,"focus",onReset),on(document.documentElement,"mousemove",move),on(document.documentElement,"touchmove",move),on(document.documentElement,"mouseup",endMove),on(document.documentElement,"touchend",endMove),on(document.documentElement,"mousemove",resize),on(document.documentElement,"touchmove",resize),on(document.documentElement,"mouseup",endResize),on(document.documentElement,"touchend",endResize)),on(instance.elements.commands.container,"click",instance.__internal.commandsClickHandler),on(instance.elements.footer,"click",instance.__internal.buttonsClickHandler),on(instance.elements.reset[0],"focus",instance.__internal.resetHandler),on(instance.elements.reset[1],"focus",instance.__internal.resetHandler),cancelKeyup=!0,on(instance.elements.dialog,transition.type,instance.__internal.transitionInHandler),instance.get("modal")||bindModelessEvents(instance),instance.get("resizable")&&bindResizableEvents(instance),instance.get("movable")&&bindMovableEvents(instance),void 0!==modal&&this.set("modal",modal),scrollX=getScrollLeft(),scrollY=getScrollTop(),ensureNoOverflow(),"string"==typeof className&&""!==className&&(this.__internal.className=className,addClass(this.elements.root,className)),this.get("startMaximized")?this.maximize():this.isMaximized()&&restore(this),updateAbsPositionFix(this),removeClass(this.elements.root,classes.animationOut),addClass(this.elements.root,classes.animationIn),clearTimeout(this.__internal.timerIn),this.__internal.timerIn=setTimeout(this.__internal.transitionInHandler,transition.supported?1e3:100),isSafari){var root=this.elements.root;root.style.display="none",setTimeout(function(){root.style.display="block"},0)}reflow=this.elements.root.offsetWidth,removeClass(this.elements.root,classes.hidden),"function"==typeof this.hooks.onshow&&this.hooks.onshow.call(this),dispatchEvent("onshow",this)}var instance;return this},close:function(){var instance;return this.__internal.isOpen&&!1!==dispatchEvent("onclosing",this)&&(instance=this,1===openDialogs.length&&(off(window,"resize",windowResize),off(document.body,"keyup",keyupHandler),off(document.body,"keydown",keydownHandler),off(document.body,"focus",onReset),off(document.documentElement,"mousemove",move),off(document.documentElement,"mouseup",endMove),off(document.documentElement,"mousemove",resize),off(document.documentElement,"mouseup",endResize)),off(instance.elements.commands.container,"click",instance.__internal.commandsClickHandler),off(instance.elements.footer,"click",instance.__internal.buttonsClickHandler),off(instance.elements.reset[0],"focus",instance.__internal.resetHandler),off(instance.elements.reset[1],"focus",instance.__internal.resetHandler),on(instance.elements.dialog,transition.type,instance.__internal.transitionOutHandler),instance.get("modal")||unbindModelessEvents(instance),instance.get("movable")&&unbindMovableEvents(instance),instance.get("resizable")&&unbindResizableEvents(instance),removeClass(this.elements.root,classes.animationIn),addClass(this.elements.root,classes.animationOut),clearTimeout(this.__internal.timerOut),this.__internal.timerOut=setTimeout(this.__internal.transitionOutHandler,transition.supported?1e3:100),addClass(this.elements.root,classes.hidden),reflow=this.elements.modal.offsetWidth,void 0!==this.__internal.className&&""!==this.__internal.className&&removeClass(this.elements.root,this.__internal.className),"function"==typeof this.hooks.onclose&&this.hooks.onclose.call(this),dispatchEvent("onclose",this),openDialogs.splice(openDialogs.indexOf(this),1),this.__internal.isOpen=!1,ensureNoOverflow()),this},closeOthers:function(){return alertify.closeAll(this),this},destroy:function(){return this.__internal.isOpen?(this.__internal.destroy=function(){destruct(this,initialize)},this.close()):destruct(this,initialize),this}}}(),notifier=function(){var element,openInstances=[],classes={base:"alertify-notifier",message:"ajs-message",top:"ajs-top",right:"ajs-right",bottom:"ajs-bottom",left:"ajs-left",visible:"ajs-visible",hidden:"ajs-hidden",close:"ajs-close"};function initialize(instance){instance.__internal||(instance.__internal={position:alertify.defaults.notifier.position,delay:alertify.defaults.notifier.delay},element=document.createElement("DIV"),updatePosition(instance)),element.parentNode!==document.body&&document.body.appendChild(element)}function updatePosition(instance){switch(element.className=classes.base,instance.__internal.position){case"top-right":addClass(element,classes.top+" "+classes.right);break;case"top-left":addClass(element,classes.top+" "+classes.left);break;case"bottom-left":addClass(element,classes.bottom+" "+classes.left);break;default:case"bottom-right":addClass(element,classes.bottom+" "+classes.right)}}function create(div,callback){function clickDelegate(event,instance){instance.__internal.closeButton&&"true"!==event.target.getAttribute("data-close")||instance.dismiss(!0)}function transitionDone(event,instance){off(instance.element,transition.type,transitionDone),element.removeChild(instance.element)}function clearTimers(instance){clearTimeout(instance.__internal.timer),clearTimeout(instance.__internal.transitionTimeout)}return(instance={element:div,push:function(_content,_wait){if(this.__internal.pushed)return this;var instance,content,wait;switch((instance=this).__internal.pushed=!0,openInstances.push(instance),clearTimers(this),arguments.length){case 0:wait=this.__internal.delay;break;case 1:wait="number"==typeof _content?_content:(content=_content,this.__internal.delay);break;case 2:content=_content,wait=_wait}return this.__internal.closeButton=alertify.defaults.notifier.closeButton,void 0!==content&&this.setContent(content),notifier.__internal.position.indexOf("top")<0?element.appendChild(this.element):element.insertBefore(this.element,element.firstChild),this.element.offsetWidth,addClass(this.element,classes.visible),on(this.element,"click",this.__internal.clickHandler),this.delay(wait)},ondismiss:function(){},callback:callback,dismiss:function(clicked){var instance;return this.__internal.pushed&&(clearTimers(this),"function"==typeof this.ondismiss&&!1===this.ondismiss.call(this)||(off(this.element,"click",this.__internal.clickHandler),void 0!==this.element&&this.element.parentNode===element&&(this.__internal.transitionTimeout=setTimeout(this.__internal.transitionEndHandler,transition.supported?1e3:100),removeClass(this.element,classes.visible),"function"==typeof this.callback&&this.callback.call(this,clicked)),instance=this,openInstances.splice(openInstances.indexOf(instance),1),instance.__internal.pushed=!1)),this},delay:function(wait){if(clearTimers(this),this.__internal.delay=void 0===wait||isNaN(+wait)?notifier.__internal.delay:+wait,0<this.__internal.delay){var self=this;this.__internal.timer=setTimeout(function(){self.dismiss()},1e3*this.__internal.delay)}return this},setContent:function(content){if("string"==typeof content?(clearContents(this.element),this.element.innerHTML=content):content instanceof window.HTMLElement&&this.element.firstChild!==content&&(clearContents(this.element),this.element.appendChild(content)),this.__internal.closeButton){var close=document.createElement("span");addClass(close,classes.close),close.setAttribute("data-close",!0),this.element.appendChild(close)}return this},dismissOthers:function(){return notifier.dismissAll(this),this}}).__internal||(instance.__internal={pushed:!1,delay:void 0,timer:void 0,clickHandler:void 0,transitionEndHandler:void 0,transitionTimeout:void 0},instance.__internal.clickHandler=delegate(instance,clickDelegate),instance.__internal.transitionEndHandler=delegate(instance,transitionDone)),instance;var instance}return{setting:function(key,value){if(initialize(this),void 0===value)return this.__internal[key];switch(key){case"position":this.__internal.position=value,updatePosition(this);break;case"delay":this.__internal.delay=value}return this},set:function(key,value){return this.setting(key,value),this},get:function(key){return this.setting(key)},create:function(type,callback){initialize(this);var div=document.createElement("div");return div.className=classes.message+("string"==typeof type&&""!==type?" ajs-"+type:""),create(div,callback)},dismissAll:function(except){for(var clone=openInstances.slice(0),x=0;x<clone.length;x+=1){var instance=clone[x];void 0!==except&&except===instance||instance.dismiss()}}}}();var alertify=new function(){var dialogs={};function extend(sub,base){for(var prop in base)base.hasOwnProperty(prop)&&(sub[prop]=base[prop]);return sub}function get_dialog(name){var dialog=dialogs[name].dialog;return dialog&&"function"==typeof dialog.__init&&dialog.__init(dialog),dialog}return{defaults:defaults,dialog:function(name,Factory,transient,base){if("function"!=typeof Factory)return get_dialog(name);if(this.hasOwnProperty(name))throw new Error("alertify.dialog: name already exists");var definition=function(name,Factory,transient,base){var definition={dialog:null,factory:Factory};return void 0!==base&&(definition.factory=function(){return extend(new dialogs[base].factory,new Factory)}),transient||(definition.dialog=extend(new definition.factory,dialog)),dialogs[name]=definition}(name,Factory,transient,base);this[name]=transient?function(){if(0===arguments.length)return definition.dialog;var instance=extend(new definition.factory,dialog);return instance&&"function"==typeof instance.__init&&instance.__init(instance),instance.main.apply(instance,arguments),instance.show.apply(instance)}:function(){if(definition.dialog&&"function"==typeof definition.dialog.__init&&definition.dialog.__init(definition.dialog),0===arguments.length)return definition.dialog;var dialog=definition.dialog;return dialog.main.apply(definition.dialog,arguments),dialog.show.apply(definition.dialog)}},closeAll:function(except){for(var clone=openDialogs.slice(0),x=0;x<clone.length;x+=1){var instance=clone[x];void 0!==except&&except===instance||instance.close()}},setting:function(name,key,value){if("notifier"===name)return notifier.setting(key,value);var dialog=get_dialog(name);return dialog?dialog.setting(key,value):void 0},set:function(name,key,value){return this.setting(name,key,value)},get:function(name,key){return this.setting(name,key)},notify:function(message,type,wait,callback){return notifier.create(type,callback).push(message,wait)},message:function(message,wait,callback){return notifier.create(null,callback).push(message,wait)},success:function(message,wait,callback){return notifier.create("success",callback).push(message,wait)},danger:function(message,wait,callback){return notifier.create("danger",callback).push(message,wait)},warning:function(message,wait,callback){return notifier.create("warning",callback).push(message,wait)},info:function(message,wait,callback){return notifier.create("info",callback).push(message,wait)},dismissAll:function(){notifier.dismissAll()}}};alertify.dialog("alert",function(){return{main:function(_title,_message,_onok){var title,message,onok;switch(arguments.length){case 1:message=_title;break;case 2:"function"==typeof _message?(message=_title,onok=_message):(title=_title,message=_message);break;case 3:title=_title,message=_message,onok=_onok}return this.set("title",title),this.set("message",message),this.set("onok",onok),this},setup:function(){return{buttons:[{text:alertify.defaults.glossary.ok,key:keys_ESC,invokeOnClose:!0,className:alertify.defaults.theme.ok}],focus:{element:0,select:!1},options:{maximizable:!1,resizable:!1}}},build:function(){},prepare:function(){},setMessage:function(message){this.setContent(message)},settings:{message:void 0,onok:void 0,label:void 0},settingUpdated:function(key,oldValue,newValue){switch(key){case"message":this.setMessage(newValue);break;case"label":this.__internal.buttons[0].element&&(this.__internal.buttons[0].element.innerHTML=newValue)}},callback:function(closeEvent){if("function"==typeof this.get("onok")){var returnValue=this.get("onok").call(this,closeEvent);void 0!==returnValue&&(closeEvent.cancel=!returnValue)}}}}),alertify.dialog("confirm",function(){var autoConfirm={timer:null,index:null,text:null,duration:null,task:function(event,self){if(self.isOpen()){if(self.__internal.buttons[autoConfirm.index].element.innerHTML=autoConfirm.text+" (&#8207;"+autoConfirm.duration+"&#8207;) ",autoConfirm.duration-=1,-1===autoConfirm.duration){clearAutoConfirm(self);var button=self.__internal.buttons[autoConfirm.index],closeEvent=createCloseEvent(autoConfirm.index,button);"function"==typeof self.callback&&self.callback.apply(self,[closeEvent]),!1!==closeEvent.close&&self.close()}}else clearAutoConfirm(self)}};function clearAutoConfirm(self){null!==autoConfirm.timer&&(clearInterval(autoConfirm.timer),autoConfirm.timer=null,self.__internal.buttons[autoConfirm.index].element.innerHTML=autoConfirm.text)}function startAutoConfirm(self,index,duration){clearAutoConfirm(self),autoConfirm.duration=duration,autoConfirm.index=index,autoConfirm.text=self.__internal.buttons[index].element.innerHTML,autoConfirm.timer=setInterval(delegate(self,autoConfirm.task),1e3),autoConfirm.task(null,self)}return{main:function(_title,_message,_onok,_oncancel){var title,message,onok,oncancel;switch(arguments.length){case 1:message=_title;break;case 2:message=_title,onok=_message;break;case 3:message=_title,onok=_message,oncancel=_onok;break;case 4:title=_title,message=_message,onok=_onok,oncancel=_oncancel}return this.set("title",title),this.set("message",message),this.set("onok",onok),this.set("oncancel",oncancel),this},setup:function(){return{buttons:[{text:alertify.defaults.glossary.ok,key:keys_ENTER,className:alertify.defaults.theme.ok},{text:alertify.defaults.glossary.cancel,key:keys_ESC,invokeOnClose:!0,className:alertify.defaults.theme.cancel}],focus:{element:0,select:!1},options:{maximizable:!1,resizable:!1}}},build:function(){},prepare:function(){},setMessage:function(message){this.setContent(message)},settings:{message:null,labels:null,onok:null,oncancel:null,defaultFocus:null,reverseButtons:null},settingUpdated:function(key,oldValue,newValue){switch(key){case"message":this.setMessage(newValue);break;case"labels":"ok"in newValue&&this.__internal.buttons[0].element&&(this.__internal.buttons[0].text=newValue.ok,this.__internal.buttons[0].element.innerHTML=newValue.ok),"cancel"in newValue&&this.__internal.buttons[1].element&&(this.__internal.buttons[1].text=newValue.cancel,this.__internal.buttons[1].element.innerHTML=newValue.cancel);break;case"reverseButtons":!0===newValue?this.elements.buttons.primary.appendChild(this.__internal.buttons[0].element):this.elements.buttons.primary.appendChild(this.__internal.buttons[1].element);break;case"defaultFocus":this.__internal.focus.element="ok"===newValue?0:1}},callback:function(closeEvent){var returnValue;switch(clearAutoConfirm(this),closeEvent.index){case 0:"function"==typeof this.get("onok")&&void 0!==(returnValue=this.get("onok").call(this,closeEvent))&&(closeEvent.cancel=!returnValue);break;case 1:"function"==typeof this.get("oncancel")&&void 0!==(returnValue=this.get("oncancel").call(this,closeEvent))&&(closeEvent.cancel=!returnValue)}},autoOk:function(duration){return startAutoConfirm(this,0,duration),this},autoCancel:function(duration){return startAutoConfirm(this,1,duration),this}}}),alertify.dialog("prompt",function(){var input=document.createElement("INPUT"),p=document.createElement("P");return{main:function(_title,_message,_value,_onok,_oncancel){var title,message,value,onok,oncancel;switch(arguments.length){case 1:message=_title;break;case 2:message=_title,value=_message;break;case 3:message=_title,value=_message,onok=_value;break;case 4:message=_title,value=_message,onok=_value,oncancel=_onok;break;case 5:title=_title,message=_message,value=_value,onok=_onok,oncancel=_oncancel}return this.set("title",title),this.set("message",message),this.set("value",value),this.set("onok",onok),this.set("oncancel",oncancel),this},setup:function(){return{buttons:[{text:alertify.defaults.glossary.ok,key:keys_ENTER,className:alertify.defaults.theme.ok},{text:alertify.defaults.glossary.cancel,key:keys_ESC,invokeOnClose:!0,className:alertify.defaults.theme.cancel}],focus:{element:input,select:!0},options:{maximizable:!1,resizable:!1}}},build:function(){input.className=alertify.defaults.theme.input,input.setAttribute("type","text"),input.value=this.get("value"),this.elements.content.appendChild(p),this.elements.content.appendChild(input)},prepare:function(){},setMessage:function(message){"string"==typeof message?(clearContents(p),p.innerHTML=message):message instanceof window.HTMLElement&&p.firstChild!==message&&(clearContents(p),p.appendChild(message))},settings:{message:void 0,labels:void 0,onok:void 0,oncancel:void 0,value:"",type:"text",reverseButtons:void 0},settingUpdated:function(key,oldValue,newValue){switch(key){case"message":this.setMessage(newValue);break;case"value":input.value=newValue;break;case"type":switch(newValue){case"text":case"color":case"date":case"datetime-local":case"email":case"month":case"number":case"password":case"search":case"tel":case"time":case"week":input.type=newValue;break;default:input.type="text"}break;case"labels":newValue.ok&&this.__internal.buttons[0].element&&(this.__internal.buttons[0].element.innerHTML=newValue.ok),newValue.cancel&&this.__internal.buttons[1].element&&(this.__internal.buttons[1].element.innerHTML=newValue.cancel);break;case"reverseButtons":!0===newValue?this.elements.buttons.primary.appendChild(this.__internal.buttons[0].element):this.elements.buttons.primary.appendChild(this.__internal.buttons[1].element)}},callback:function(closeEvent){var returnValue;switch(closeEvent.index){case 0:this.settings.value=input.value,"function"==typeof this.get("onok")&&void 0!==(returnValue=this.get("onok").call(this,closeEvent,this.settings.value))&&(closeEvent.cancel=!returnValue);break;case 1:"function"==typeof this.get("oncancel")&&void 0!==(returnValue=this.get("oncancel").call(this,closeEvent))&&(closeEvent.cancel=!returnValue),closeEvent.cancel||(input.value=this.settings.value)}}}}),"object"==typeof module&&"object"==typeof module.exports?module.exports=alertify:"function"==typeof define&&define.amd?define([],function(){return alertify}):window.alertify||(window.alertify=alertify)}("undefined"!=typeof window?window:this);